<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Einbindung und Konfiguration :: IsyFact Dokumentation</title>
    <link rel="canonical" href="https://github.com/isyfact/isyfact-standards-doku/latest/isy-sicherheit/nutzungsvorgaben/anhaenge.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../../../_/css/isyfact.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://github.com/isyfact">IsyFact Dokumentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="isyfact-standards-doku" data-version="2.5-SNAPSHOT">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../einstieg/vorstellung.html">IsyFact Standards</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Einstieg</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../einstieg/vorstellung.html">Vorstellung der IsyFact</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/isyfact-standards.html">IsyFact-Standards</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/isyfact-erweiterungen.html">IsyFact-Erweiterungen</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/rahmenbedingungen.html">Rahmenbedingungen</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/erste-schritte.html">Erste Schritte</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/tutorial/master.html">Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/whitepaper/master.html">Whitepaper</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/migrationsleitfaden-if2/master.html">Migrationsleitfaden IsyFact 2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Blaupausen</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../blaupausen/referenzarchitektur/master.html">Referenzarchitektur</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../blaupausen/referenzarchitektur-it-system/master.html">Referenzarchitektur IT-System</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-anwendungskern/master.html">Anwendungskern</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-datenzugriff/master.html">Datenzugriff</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-service/master.html">Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-web-gui/master.html">Web GUI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-batch/master.html">Batch</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Vorgaben</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/vorgaben-architektur/master.html">Architektur</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/vorgaben-it-sicherheit/master.html">IT-Sicherheit</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Bausteine</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Datum &amp; Zeit</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-datetime/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-datetime/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Fehlerbehandlung</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-exception-core/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-exception-core/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">HttpInvoker</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-serviceapi-core/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-serviceapi-core/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Konfiguration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-konfiguration/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-konfiguration/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Logging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-logging/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-logging/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Polling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-polling/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-polling/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">REST</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-service-rest/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-service-rest/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sicherheit</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sonderzeichen</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sonderzeichen/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sonderzeichen/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Task Scheduling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-task/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-task/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ãœberwachung</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-ueberwachung/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-ueberwachung/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Util</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-util/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Methodik</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/namenskonventionen/master.html">Namenskonventionen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/versionierung/master.html">Versionierung</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/java-programmierkonventionen/master.html">Java-Programmierkonventionen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/diagrammerstellung.html">Diagrammerstellung und Modellierung</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/diagrammerstellung/diagramsnet.html">diagrams.net</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/diagrammerstellung/enterprise-architect.html">Enterprise Architect</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/vorlagen.html">Vorlagen</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/tailoring/tailoring.html">Tailoring</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/spezifikation/datenflussdiagramme.html">Datenflussdiagramme</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Werkzeuge</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../werkzeuge/einrichtung_entwicklungsumgebung/master.html">Entwicklungsumgebung</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../werkzeuge/versionierungskontrolle/master.html">Versionierungskontrolle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../werkzeuge/handbuch_dokumentation/master.html">Dokumentation der IsyFact</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../werkzeuge/seitenvorlage.html">Seitenvorlage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../werkzeuge/kopiervorlage.html">Kopiervorlage fÃ¼r neue Seiten</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../changelog/changelog.html">Changelog</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">IsyFact Standards</span>
    <span class="version">2.5-SNAPSHOT</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../glossary/latest/glossary/master.html">Glossar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../glossary/latest/glossary/master.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../einstieg/vorstellung.html">IsyFact Standards</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../einstieg/vorstellung.html">2.5-SNAPSHOT</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../einstieg/vorstellung.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../einstieg/vorstellung.html">IsyFact Standards</a></li>
    <li><a href="anhaenge.html">Einbindung und Konfiguration</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Inhalt" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Einbindung und Konfiguration</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In diesem Abschnitt wird die Einbindung und Konfiguration von <strong>isy-sicherheit-keycloak</strong> beschrieben.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="maven-dependency"><a class="anchor" href="#maven-dependency"></a>1. Maven Dependency</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In der pom.xml der Anwendung muss folgende AbhÃ¤ngigkeit ergÃ¤nzt werden:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;de.bund.bva.isyfact&lt;/groupId&gt;
  &lt;artifactId&gt;isy-sicherheit-keycloak&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-konfiguration"><a class="anchor" href="#spring-konfiguration"></a>2. Spring Konfiguration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die Spring-Konfiguration von isy-sicherheit-keycloak baut auf der Konfiguration von isy-sicherheit auf (siehe <a href="#NutzungsvorgabenSicherheit">Nutzungsvorgaben Sicherheit</a>).
Lediglich alle dort beschriebenen CAMS-spezifischen Konfigurationen mÃ¼ssen entfallen.
In IsyFact 2 bringt isy-sicherheit-keycloak eine Autokonfiguration fÃ¼r Spring Boot mit.
Die  <code>AccessManager</code>-Bean fÃ¼r Keycloak wird damit automatisch konfiguriert, wenn keine andere AccessManager-Bean im Kontext vorhanden ist.</p>
</div>
<div class="paragraph">
<p>Zur Absicherung von Rest-Services in Spring sind weitere Konfigurationen erforderlich.
Insbesondere muss die Spring-Security-Chain korrekt initialisiert werden.
Dies geschieht am einfachsten per Konfiguration nicht in XML sondern im Java-Code.
Hierzu muss in der Anwendung eine Konfigurationsklasse definiert werden, welche von <code>IsyKeycloakWebSecurityConfigurerAdapter</code> ableitet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeispielAnwendungSecurityConfig extends IsyKeycloakWebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);

        http.authorizeRequests().anyRequest().authenticated();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Die <code>HttpSecurity</code>-Konfiguration in dem Beispiel oben stellt sicher, dass der Nutzer bei allen Requests authentifiziert ist.
Regeln zur Autorisierung werden hier nicht definiert, da dies in isy-sicherheit Ã¼ber die <code>Gesichert</code>-Annotation an den abzusichernden Services erfolgt.</p>
</div>
<div class="paragraph">
<p>Die Konfigurationsklasse wird als Import in die Hauptklasse in der Anwendung eingebunden:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableAutoConfiguration
@Import({ BeispielAnwendungSecurityConfig.class /*, ggf weitere Config*/ })

public class BeispielAnwendungApplication extends SpringBootServletInitializer {
//...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="konfigurationsparameter"><a class="anchor" href="#konfigurationsparameter"></a>3. Konfigurationsparameter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>FÃ¼r die korrekte Anbindung an Keycloak ist die Angabe einiger Konfigurationsparameter notwendig.
Die in den <a href="#NutzungsvorgabenSicherheit">Nutzungsvorgaben Sicherheit</a> beschriebenen Parameter fÃ¼r CAMS (<code>sic.camsagent.<strong></code> und <code>cams.</strong></code>) sind nicht mehr relevant.</p>
</div>
<div class="paragraph">
<p>Der PrÃ¤fix sÃ¤mtlicher Konfigurationsparameter <code>isy.sicherheit.keycloak</code> wird zur Vereinfachung in der Liste unten weggelassen.</p>
</div>
<div class="paragraph">
<p>Einige Konfigurationsparameter sind mit einem ZÃ¤hler versehen.
Diese beinhalten mit <code>instances[0]</code> und kÃ¶nnen fÃ¼r mehr als eine SicherheitsdomÃ¤ne und/oder Keycloak-Installation definiert werden.
Die Parameter fÃ¼r eine zweite Konfiguration mÃ¼ssen mit <code>instances[1]</code> ergÃ¤nzt werden.
Weitere Konfigurationen werden demzufolge mit Parametern konfiguriert, die mit <code>instances[2]</code>, <code>instances[3]</code>, etc. enthalten.
Dies ist dann sinnvoll, wenn eine Anwendung nicht nur Access-Tokens einer SicherheitsdomÃ¤ne in einer Keycloak-Installation akzeptieren soll, sondern verschiedene.
Ein Beispiel fÃ¼r eine Anwendung mit zwei Realms ist eine GeschÃ¤ftsanwendung,
welche einen Realm zur PrÃ¼fung der Tokens benÃ¶tigt mit denen es aus dem Portal heraus Ã¼ber den Proxy aufgerufen wird und
einen zweiten Realm zur Initiierung der Authentifizierung eines Timer-Tasks oder Batch.</p>
</div>
<table id="table-parameter" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 1. Konfigurationsparameter</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 53.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Wertebereich</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock"><code><strong>Parameter pro SicherheitsdomÃ¤ne und/oder Keycloak-Installation</strong></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].realm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Realm bei Keycloak (=SicherheitsdomÃ¤ne)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].realmKey</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Public-Key zur ÃœberprÃ¼fung der Token-Signatur.
    Der Wert hier kann der Realm-Konfiguration in Keycloak entnommen werden.
    Wird i.d.R. nicht gesetzt, damit der Key automatisch von Keycloak bezogen wird.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].auth-server-url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link auf die betreffende Keycloak-Instanz (Beispiel: <a href="http://keycloak:8080/auth" class="bare">http://keycloak:8080/auth</a>).
    Der Link dient dazu die Keycloak-Instanzen zu unterscheiden und wird zur Kommunikation dieser Anwendung mit Keycloak benÃ¶tigt;
    beispielsweise zur Abfrage des Public-Key zur ÃœberprÃ¼fung der Token-Signatur.
    Der Link muss mit dem Aussteller des Tokens Ã¼bereinstimmen.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].ext-auth-server-url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alternativer Link auf die betreffende Keycloak-Instanz (Beispiel: <a href="http://proxy/keycloak/auth" class="bare">http://proxy/keycloak/auth</a>).
    Der Link wird nur zur Token-PrÃ¼fung verwendet, es werden keine Anfragen Ã¼ber die URL gesendet.
    Tokens bei denen dieser Link als Aussteller im Token steht, werden auch akzeptiert.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].default-instance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Markiert eine Keycloak-Instanz als Default.
    Falls keine Instanz explizit als Default markiert ist, wird die erste Instanz genommen.
    Die Default-Instanz ist relevant, wenn die Anwendung eine Authentifizierung bei Keycloak initiieren will.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].bearer-only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bearer-only Anwendungen kÃ¶nnen nur Tokens prÃ¼fen, aber selbst keine Authentifizierung bei Keycloak initiieren.
    In der Regel ist dies bei GUI-Anwendungen der Fall, bei denen das Token durch einen vorgeschalteten Apache ermittelt wird.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].resource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bearer-only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Name des Clients, der fÃ¼r die Authentifizierung bei Keycloak verwendet wird.
    FÃ¼r bearer-only Anwendungen ist keine Konfiguration notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].credentials-secret</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passwort mit dem sich die Anwendung / der Client bei Keycloak authentifiziert.
    FÃ¼r bearer-only Anwendungen ist keine Konfiguration notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].enable-basic-auth</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aktivierung von HTTP Basic-Authentication.
    Funktioniert nur, wenn der Keycloak Client auch entsprechend konfiguriert ist.
    Wird bereits auf einen sinnvollen Standardwert gesetzt.
    Anpassungen sind i.d.R. nicht notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].public-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bei Public-Clients wird kein Client-Secret benÃ¶tigt, um eine Authentifizierung bei Keycloak zu initiieren.
    Funktioniert nur, wenn der Keycloak Client auch entsprechend konfiguriert ist.
    Wird bereits auf einen sinnvollen Standardwert gesetzt.
    Anpassungen sind i.d.R. nicht notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].ssl-required</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>external</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definiert, wann eine SSL Verbindung verpflichtend ist.
    Wird bereits auf einen sinnvollen Standardwert gesetzt.
    Anpassungen sind i.d.R. nicht notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].principal-attribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sub</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definiert, welches Token-Attribut als User-Name genutzt wird.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock"><code><strong>Allgemeine Parameter</strong>:</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cert-header-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x-client-cert</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Als zusÃ¤tzliche SicherheitsmaÃŸnahme ist zur Authentifizierung in Keycloak ein BehÃ¶rdenkennzeichen erforderlich, welches zu dem BehÃ¶rdenkennzeichen passen muss, dass im Nutzerprofil hinterlegt ist.
Das BehÃ¶rdenkennzeichen wird von Keycloak aus dem Zertifikat ausgelesen.
Der Name des HTTP-Headers, der das Zertifikat enthÃ¤lt ist konfigurierbar.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cert-dn-header-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x-client-cert-dn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alternativ kann statt des Zertifikats auch nur der DN aus dem Zertifikat an Keycloak weitergeleitet werden.
HierfÃ¼r wird ein anderer HTTP-Header verwendet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bhknz-header-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x-client-cert-bhknz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alternativ kann statt des Zertifikats oder DN auch nur das BehÃ¶rdenkennzeichen an Keycloak weitergeleitet werden.
HierfÃ¼r wird ein anderer HTTP-Header verwendet.
Dies wird zum Test, aber auch in Produktion beispielsweise bei Batches verwendet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>standard-zertifikat-ou</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AZRVISAPORTAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Wert wird verwendet, wenn ein Aufruf mit BHKNZ jedoch ohne Zertifikat-OU eingeht.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>korrelations-id-header-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>correlationid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Name des Korrelations-ID-Headers in Anfragen an Keycloak.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bhknz-attribute-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bhknz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Attributname der BehÃ¶rdenkennzeichen in den Userdaten in den Antworten von Keycloak.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>interne-kennung-attribute-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>internekennung</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Name des Claims im Token, aus dem die interneKennung fÃ¼r den Aufrufkontext entnommen wird</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<h1 id="authentifizierung" class="sect0"><a class="anchor" href="#authentifizierung"></a>Authentifizierung</h1>
<div class="paragraph">
<p>Die Authentifizierung erfolgt Ã¼ber Keycloak.
Keycloak greift hierbei auf die Benutzerdaten im Benutzerverzeichnis zu.
Nach erfolgreicher Authentifizierung stellt Keycloak ein Access-Token aus, welches die benÃ¶tigten Informationen zum angemeldeten Nutzer enthÃ¤lt.
Dies sind beispielsweise die Rollen des Nutzers, das Kennzeichen der BehÃ¶rde, welcher er zugeordnet ist, sowie der Nutzername.</p>
</div>
<div class="sect1">
<h2 id="authentifizierung_in_der_gui"><a class="anchor" href="#authentifizierung_in_der_gui"></a>1. Authentifizierung in der GUI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die Authentifizierung in der GUI erfolgt Ã¼ber ein Modul im Apache, welches prÃ¼ft, ob bereits eine gÃ¼ltige Session vorhanden ist.
Falls nein, wird der Nutzer auf die Login-Seite von Keycloak umgeleitet und kann dort seine Credentials eingeben.
Wenn die Authentifizierung bei Keycloak erfolgreich war, liefert Keycloak ein Access-Token zurÃ¼ck.
Dies wird in der Session gespeichert und bei jedem Request an die nachgelagerten Anwendungen Ã¼ber einen HTTP-Header mitgeschickt.</p>
</div>
<div class="paragraph">
<p>Im der aufgerufenen Anwendung wird durch isy-sicherheit-keycloak geprÃ¼ft, ob das Token gÃ¼ltig ist.
Hierzu wird der Public-Key des Realm in Keycloak benÃ¶tigt.
Dieser wird automatisch (Ã¼ber einen Ã¶ffentlichen Rest-Endpunkt) bei Keycloak abgefragt und in einem Cache in der Anwendung vorgehalten.
Wenn die Token-PrÃ¼fung erfolgreich war, werden die Daten aus dem Token in einem <code>AufrufKontext</code> im <code>AufrufKontextVerwalter</code> gespeichert.
ZusÃ¤tzlich werden die Daten auch im Spring-Security-Context gespeichert.
Dies ermÃ¶glicht AutorisierungsprÃ¼fungen sowohl Ã¼ber die <code>Gesichert</code>-Annotation aus isy-sicherheit,
als auch Ã¼ber die entsprechenden Mechanismen in Spring-Security, beispielsweise die <code>Secured</code>-Annotation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentifizierung_innerhalb_einer_anwendung"><a class="anchor" href="#authentifizierung_innerhalb_einer_anwendung"></a>2. Authentifizierung innerhalb einer Anwendung</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Zur Authentifizierung innerhalb einer Anwendung muss ein <code>AufrufKontext</code> oder <code>ZertifikatInfoAufrufKontext</code> erzeugt werden, in dem Kennung, Passwort und BehÃ¶rdenkennzeichen oder Zertifikat gefÃ¼llt sind.
Ãœber die Komponente <code>Sicherheit</code> kann dann die Authentifizierung bei Keycloak angestoÃŸen werden.
Der Aufruf an Keycloak erfolgt dabei Ã¼ber den <code>KeycloakAccessManager</code>.
Wenn die Authentifizierung bei Keycloak erfolgreich war, liefert Keycloak ein Access-Token zurÃ¼ck.
Die Daten aus dem Token werden in einem <code>AufrufKontext</code> im <code>AufrufKontextVerwalter</code> gespeichert.
ZusÃ¤tzlich werden die Daten auch im Spring-Security-Context gespeichert.</p>
</div>
</div>
</div>
<h1 id="autorisierung" class="sect0"><a class="anchor" href="#autorisierung"></a>Autorisierung</h1>
<div class="sect1">
<h2 id="autorisierung_eines_rest_service"><a class="anchor" href="#autorisierung_eines_rest_service"></a>1. Autorisierung eines REST Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bei REST Services wird erwartet, dass der Aufrufer ein gÃ¼ltiges Access-Token mitschickt.
Das Token wird als Bearer-Token im Authorization Header des Http-Requests erwartet.
Hieraus erzeugt isy-sicherheit-keycloak (wie oben beschrieben) einen <code>AufrufKontext</code>.
Die AutorisierungsprÃ¼fung erfolgt dann, entsprechend dem Konzept von isy-sicherheit, Ã¼ber die <code>Gesichert</code>-Annotation an der Service-Implementierung.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="autorisierung_eines_httpinvoker_service"><a class="anchor" href="#autorisierung_eines_httpinvoker_service"></a>2. Autorisierung eines HttpInvoker Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bei HttpInvoker Services wird erwartet, dass der <code>AufrufKontext</code> als erster Parameter mitgesendet wird.
Dieser wird dann zur AutorisierungsprÃ¼fung herangezogen.</p>
</div>
<div class="paragraph">
<p>Aktuell gibt es noch keine Festlegungen zur Nutzung von Tokens auch bei HttpInvoker.</p>
</div>
</div>
</div>
<h1 id="testunterstuetzung" class="sect0"><a class="anchor" href="#testunterstuetzung"></a>TestunterstÃ¼tzung</h1>
<div class="paragraph">
<p>In diesem Abschnitt wird <strong>isy-sicherheit-keycloak-test</strong> beschrieben.</p>
</div>
<div class="paragraph">
<p>Isy-sicherheit-test enthÃ¤lt Hilfsklassen zum Erstellen von (automatisierten) Tests, in welchen isy-sicherheit-keycloak benÃ¶tigt wird.
Das Projekt enthÃ¤lt eine Mock-Implementierung von Keycloak.
Zur Simulation des REST-Services wird WireMock verwendet.</p>
</div>
<div class="paragraph">
<p>Isy-sicherheit-test wird auch in den Unit-Tests des Projekts isy-sicherheit-keycloak verwendet.</p>
</div>
<div class="paragraph">
<p>Das folgende Beispiel zeigt die einfache Initialisierung eines Mocks fÃ¼r Keycloak, mit genau einem Nutzer mit genau einer Rolle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">EmbeddedKeycloakMock embeddedKeycloak = new EmbeddedKeycloakMock("localhost", 9095, "testRealm", new RsaKeyGenerator());
embeddedKeycloak.addUser("testUser", "testPwd", "testBhknz", Collections.singleton("testRolle"));</code></pre>
</div>
</div>
</article>
  </div>
</main>
</div>
<div class="divFooter"></div>

<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/isyfact.js"></script>
  </body>
</html>
