<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Einbindung und Konfiguration :: IsyFact Dokumentation</title>
    <link rel="canonical" href="https://github.com/isyfact/isyfact-standards-doku/latest/isy-sicherheit/nutzungsvorgaben/anhaenge.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../../../_/css/isyfact.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://github.com/isyfact">IsyFact Dokumentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="isyfact-standards-doku" data-version="2.5-SNAPSHOT">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../einstieg/einstieg.html">IsyFact Standards</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../einstieg/einstieg.html">Einstieg</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../einstieg/vorstellung.html">Vorstellung der IsyFact</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/isyfact-standards.html">IsyFact-Standards</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/isyfact-erweiterungen.html">IsyFact-Erweiterungen</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/rahmenbedingungen.html">Rahmenbedingungen</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/erste-schritte.html">Erste Schritte</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/tutorial/master.html">Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/whitepaper.html">Whitepaper</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/migrationsleitfaden-if2/master.html">Migrationsleitfaden IsyFact 2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../blaupausen/blaupausen.html">Blaupausen</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../blaupausen/referenzarchitektur/master.html">Referenzarchitektur</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../blaupausen/referenzarchitektur-it-system/master.html">Referenzarchitektur IT-System</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-anwendungskern/master.html">Anwendungskern</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-datenzugriff/master.html">Datenzugriff</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-service/master.html">Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-web-gui/master.html">Web GUI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/detailkonzept-komponente-batch/master.html">Batch</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Vorgaben</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/vorgaben-architektur/master.html">Architektur</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../blaupausen/vorgaben-it-sicherheit/master.html">IT-Sicherheit</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../bausteine/bausteine.html">Bausteine</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Datum &amp; Zeit</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-datetime/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-datetime/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Fehlerbehandlung</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-exception-core/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-exception-core/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">HttpInvoker</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-serviceapi-core/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-serviceapi-core/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Konfiguration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-konfiguration/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-konfiguration/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Logging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-logging/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-logging/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Polling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-polling/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-polling/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">REST</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-service-rest/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-service-rest/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sicherheit</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sonderzeichen</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sonderzeichen/konzept/sonderzeichen.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sonderzeichen/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Task Scheduling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-task/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-task/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Überwachung</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-ueberwachung/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-ueberwachung/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Util</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-util/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../plattform/plattform.html">Plattform</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/methodik.html">Methodik</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/namenskonventionen/master.html">Namenskonventionen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/versionierung/master.html">Versionierung</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/java-programmierkonventionen/master.html">Java-Programmierkonventionen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/diagrammerstellung.html">Diagrammerstellung und Modellierung</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/diagrammerstellung/diagramsnet.html">diagrams.net</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/diagrammerstellung/enterprise-architect.html">Enterprise Architect</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/vorlagen.html">Vorlagen</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/vorlagen/bearbeitung.html">Bearbeitung der AsciiDoc-Vorlagen</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../werkzeuge/werkzeuge.html">Werkzeuge</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../werkzeuge/dokumentation/einleitung/einfuehrung.html">Dokumentation gemäß IsyFact</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../werkzeuge/dokumentation/master-antora.html">Projektseite mit Antora (empfohlen)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../werkzeuge/seitenvorlage.html">Seitenvorlage</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../werkzeuge/kopiervorlage.html">Kopiervorlage für neue Seiten</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../werkzeuge/dokumentation/master-asciidoctorJ.html">Dokumente mit AsciidoctorJ Extensions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../werkzeuge/entwicklungsumgebung/master.html">Entwicklungsumgebung</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../werkzeuge/versionierungskontrolle/master.html">Versionierungskontrolle</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../changelog/changelog.html">Changelog</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">IsyFact Standards</span>
    <span class="version">2.5-SNAPSHOT</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../glossary/latest/glossary/master.html">Glossar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../glossary/latest/glossary/master.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../einstieg/einstieg.html">IsyFact Standards</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../einstieg/einstieg.html">2.5-SNAPSHOT</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../einstieg/einstieg.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../einstieg/einstieg.html">IsyFact Standards</a></li>
    <li><a href="anhaenge.html">Einbindung und Konfiguration</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Inhalt" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Einbindung und Konfiguration</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In diesem Abschnitt wird die Einbindung und Konfiguration von <strong>isy-sicherheit-keycloak</strong> beschrieben.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="maven-dependency"><a class="anchor" href="#maven-dependency"></a>1. Maven Dependency</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In der pom.xml der Anwendung muss folgende Abhängigkeit ergänzt werden:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;de.bund.bva.isyfact&lt;/groupId&gt;
  &lt;artifactId&gt;isy-sicherheit-keycloak&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="spring-konfiguration"><a class="anchor" href="#spring-konfiguration"></a>2. Spring Konfiguration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die Spring-Konfiguration von isy-sicherheit-keycloak baut auf der Konfiguration von isy-sicherheit auf (siehe <a href="#NutzungsvorgabenSicherheit">Nutzungsvorgaben Sicherheit</a>).
Lediglich alle dort beschriebenen CAMS-spezifischen Konfigurationen müssen entfallen.
In IsyFact 2 bringt isy-sicherheit-keycloak eine Autokonfiguration für Spring Boot mit.
Die  <code>AccessManager</code>-Bean für Keycloak wird damit automatisch konfiguriert, wenn keine andere AccessManager-Bean im Kontext vorhanden ist.</p>
</div>
<div class="paragraph">
<p>Zur Absicherung von Rest-Services in Spring sind weitere Konfigurationen erforderlich.
Insbesondere muss die Spring-Security-Chain korrekt initialisiert werden.
Dies geschieht am einfachsten per Konfiguration nicht in XML sondern im Java-Code.
Hierzu muss in der Anwendung eine Konfigurationsklasse definiert werden, welche von <code>IsyKeycloakWebSecurityConfigurerAdapter</code> ableitet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class BeispielAnwendungSecurityConfig extends IsyKeycloakWebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        super.configure(http);

        http.authorizeRequests().anyRequest().authenticated();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Die <code>HttpSecurity</code>-Konfiguration in dem Beispiel oben stellt sicher, dass der Nutzer bei allen Requests authentifiziert ist.
Regeln zur Autorisierung werden hier nicht definiert, da dies in isy-sicherheit über die <code>Gesichert</code>-Annotation an den abzusichernden Services erfolgt.</p>
</div>
<div class="paragraph">
<p>Die Konfigurationsklasse wird als Import in die Hauptklasse in der Anwendung eingebunden:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableAutoConfiguration
@Import({ BeispielAnwendungSecurityConfig.class /*, ggf weitere Config*/ })

public class BeispielAnwendungApplication extends SpringBootServletInitializer {
//...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="konfigurationsparameter"><a class="anchor" href="#konfigurationsparameter"></a>3. Konfigurationsparameter</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Für die korrekte Anbindung an Keycloak ist die Angabe einiger Konfigurationsparameter notwendig.
Die in den <a href="#NutzungsvorgabenSicherheit">Nutzungsvorgaben Sicherheit</a> beschriebenen Parameter für CAMS (<code>sic.camsagent.<strong></code> und <code>cams.</strong></code>) sind nicht mehr relevant.</p>
</div>
<div class="paragraph">
<p>Der Präfix sämtlicher Konfigurationsparameter <code>isy.sicherheit.keycloak</code> wird zur Vereinfachung in der Liste unten weggelassen.</p>
</div>
<div class="paragraph">
<p>Einige Konfigurationsparameter sind mit einem Zähler versehen.
Diese beinhalten mit <code>instances[0]</code> und können für mehr als eine Sicherheitsdomäne und/oder Keycloak-Installation definiert werden.
Die Parameter für eine zweite Konfiguration müssen mit <code>instances[1]</code> ergänzt werden.
Weitere Konfigurationen werden demzufolge mit Parametern konfiguriert, die mit <code>instances[2]</code>, <code>instances[3]</code>, etc. enthalten.
Dies ist dann sinnvoll, wenn eine Anwendung nicht nur Access-Tokens einer Sicherheitsdomäne in einer Keycloak-Installation akzeptieren soll, sondern verschiedene.
Ein Beispiel für eine Anwendung mit zwei Realms ist eine Geschäftsanwendung,
welche einen Realm zur Prüfung der Tokens benötigt mit denen es aus dem Portal heraus über den Proxy aufgerufen wird und
einen zweiten Realm zur Initiierung der Authentifizierung eines Timer-Tasks oder Batch.</p>
</div>
<table id="table-parameter" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 1. Konfigurationsparameter</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 13.3333%;">
<col style="width: 13.3333%;">
<col style="width: 53.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Wertebereich</th>
<th class="tableblock halign-left valign-top">Default</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock"><code><strong>Parameter pro Sicherheitsdomäne und/oder Keycloak-Installation</strong></code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].realm</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Realm bei Keycloak (=Sicherheitsdomäne)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].realmKey</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Public-Key zur Überprüfung der Token-Signatur.
    Der Wert hier kann der Realm-Konfiguration in Keycloak entnommen werden.
    Wird i.d.R. nicht gesetzt, damit der Key automatisch von Keycloak bezogen wird.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].auth-server-url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Link auf die betreffende Keycloak-Instanz (Beispiel: <a href="http://keycloak:8080/auth" class="bare">http://keycloak:8080/auth</a>).
    Der Link dient dazu die Keycloak-Instanzen zu unterscheiden und wird zur Kommunikation dieser Anwendung mit Keycloak benötigt;
    beispielsweise zur Abfrage des Public-Key zur Überprüfung der Token-Signatur.
    Der Link muss mit dem Aussteller des Tokens übereinstimmen.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].ext-auth-server-url</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alternativer Link auf die betreffende Keycloak-Instanz (Beispiel: <a href="http://proxy/keycloak/auth" class="bare">http://proxy/keycloak/auth</a>).
    Der Link wird nur zur Token-Prüfung verwendet, es werden keine Anfragen über die URL gesendet.
    Tokens bei denen dieser Link als Aussteller im Token steht, werden auch akzeptiert.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].default-instance</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Markiert eine Keycloak-Instanz als Default.
    Falls keine Instanz explizit als Default markiert ist, wird die erste Instanz genommen.
    Die Default-Instanz ist relevant, wenn die Anwendung eine Authentifizierung bei Keycloak initiieren will.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].bearer-only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bearer-only Anwendungen können nur Tokens prüfen, aber selbst keine Authentifizierung bei Keycloak initiieren.
    In der Regel ist dies bei GUI-Anwendungen der Fall, bei denen das Token durch einen vorgeschalteten Apache ermittelt wird.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].resource</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bearer-only</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Name des Clients, der für die Authentifizierung bei Keycloak verwendet wird.
    Für bearer-only Anwendungen ist keine Konfiguration notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].credentials-secret</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code><em>keiner</em></code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Passwort mit dem sich die Anwendung / der Client bei Keycloak authentifiziert.
    Für bearer-only Anwendungen ist keine Konfiguration notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].enable-basic-auth</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Aktivierung von HTTP Basic-Authentication.
    Funktioniert nur, wenn der Keycloak Client auch entsprechend konfiguriert ist.
    Wird bereits auf einen sinnvollen Standardwert gesetzt.
    Anpassungen sind i.d.R. nicht notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].public-client</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>boolean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bei Public-Clients wird kein Client-Secret benötigt, um eine Authentifizierung bei Keycloak zu initiieren.
    Funktioniert nur, wenn der Keycloak Client auch entsprechend konfiguriert ist.
    Wird bereits auf einen sinnvollen Standardwert gesetzt.
    Anpassungen sind i.d.R. nicht notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].ssl-required</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>external</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definiert, wann eine SSL Verbindung verpflichtend ist.
    Wird bereits auf einen sinnvollen Standardwert gesetzt.
    Anpassungen sind i.d.R. nicht notwendig.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>instances[0].principal-attribute</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sub</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Definiert, welches Token-Attribut als User-Name genutzt wird.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top" colspan="4"><p class="tableblock"><code><strong>Allgemeine Parameter</strong>:</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cert-header-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x-client-cert</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Als zusätzliche Sicherheitsmaßnahme ist zur Authentifizierung in Keycloak ein Behördenkennzeichen erforderlich, welches zu dem Behördenkennzeichen passen muss, dass im Nutzerprofil hinterlegt ist.
Das Behördenkennzeichen wird von Keycloak aus dem Zertifikat ausgelesen.
Der Name des HTTP-Headers, der das Zertifikat enthält ist konfigurierbar.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>cert-dn-header-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x-client-cert-dn</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alternativ kann statt des Zertifikats auch nur der DN aus dem Zertifikat an Keycloak weitergeleitet werden.
Hierfür wird ein anderer HTTP-Header verwendet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bhknz-header-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>x-client-cert-bhknz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Alternativ kann statt des Zertifikats oder DN auch nur das Behördenkennzeichen an Keycloak weitergeleitet werden.
Hierfür wird ein anderer HTTP-Header verwendet.
Dies wird zum Test, aber auch in Produktion beispielsweise bei Batches verwendet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>standard-zertifikat-ou</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AZRVISAPORTAL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Wert wird verwendet, wenn ein Aufruf mit BHKNZ jedoch ohne Zertifikat-OU eingeht.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>korrelations-id-header-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>correlationid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Name des Korrelations-ID-Headers in Anfragen an Keycloak.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bhknz-attribute-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bhknz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Attributname der Behördenkennzeichen in den Userdaten in den Antworten von Keycloak.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>interne-kennung-attribute-name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>internekennung</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Name des Claims im Token, aus dem die interneKennung für den Aufrufkontext entnommen wird</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<h1 id="authentifizierung" class="sect0"><a class="anchor" href="#authentifizierung"></a>Authentifizierung</h1>
<div class="paragraph">
<p>Die Authentifizierung erfolgt über Keycloak.
Keycloak greift hierbei auf die Benutzerdaten im Benutzerverzeichnis zu.
Nach erfolgreicher Authentifizierung stellt Keycloak ein Access-Token aus, welches die benötigten Informationen zum angemeldeten Nutzer enthält.
Dies sind beispielsweise die Rollen des Nutzers, das Kennzeichen der Behörde, welcher er zugeordnet ist, sowie der Nutzername.</p>
</div>
<div class="sect1">
<h2 id="authentifizierung_in_der_gui"><a class="anchor" href="#authentifizierung_in_der_gui"></a>1. Authentifizierung in der GUI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die Authentifizierung in der GUI erfolgt über ein Modul im Apache, welches prüft, ob bereits eine gültige Session vorhanden ist.
Falls nein, wird der Nutzer auf die Login-Seite von Keycloak umgeleitet und kann dort seine Credentials eingeben.
Wenn die Authentifizierung bei Keycloak erfolgreich war, liefert Keycloak ein Access-Token zurück.
Dies wird in der Session gespeichert und bei jedem Request an die nachgelagerten Anwendungen über einen HTTP-Header mitgeschickt.</p>
</div>
<div class="paragraph">
<p>Im der aufgerufenen Anwendung wird durch isy-sicherheit-keycloak geprüft, ob das Token gültig ist.
Hierzu wird der Public-Key des Realm in Keycloak benötigt.
Dieser wird automatisch (über einen öffentlichen Rest-Endpunkt) bei Keycloak abgefragt und in einem Cache in der Anwendung vorgehalten.
Wenn die Token-Prüfung erfolgreich war, werden die Daten aus dem Token in einem <code>AufrufKontext</code> im <code>AufrufKontextVerwalter</code> gespeichert.
Zusätzlich werden die Daten auch im Spring-Security-Context gespeichert.
Dies ermöglicht Autorisierungsprüfungen sowohl über die <code>Gesichert</code>-Annotation aus isy-sicherheit,
als auch über die entsprechenden Mechanismen in Spring-Security, beispielsweise die <code>Secured</code>-Annotation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentifizierung_innerhalb_einer_anwendung"><a class="anchor" href="#authentifizierung_innerhalb_einer_anwendung"></a>2. Authentifizierung innerhalb einer Anwendung</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Zur Authentifizierung innerhalb einer Anwendung muss ein <code>AufrufKontext</code> oder <code>ZertifikatInfoAufrufKontext</code> erzeugt werden, in dem Kennung, Passwort und Behördenkennzeichen oder Zertifikat gefüllt sind.
Über die Komponente <code>Sicherheit</code> kann dann die Authentifizierung bei Keycloak angestoßen werden.
Der Aufruf an Keycloak erfolgt dabei über den <code>KeycloakAccessManager</code>.
Wenn die Authentifizierung bei Keycloak erfolgreich war, liefert Keycloak ein Access-Token zurück.
Die Daten aus dem Token werden in einem <code>AufrufKontext</code> im <code>AufrufKontextVerwalter</code> gespeichert.
Zusätzlich werden die Daten auch im Spring-Security-Context gespeichert.</p>
</div>
</div>
</div>
<h1 id="autorisierung" class="sect0"><a class="anchor" href="#autorisierung"></a>Autorisierung</h1>
<div class="sect1">
<h2 id="autorisierung_eines_rest_service"><a class="anchor" href="#autorisierung_eines_rest_service"></a>1. Autorisierung eines REST Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bei REST Services wird erwartet, dass der Aufrufer ein gültiges Access-Token mitschickt.
Das Token wird als Bearer-Token im Authorization Header des Http-Requests erwartet.
Hieraus erzeugt isy-sicherheit-keycloak (wie oben beschrieben) einen <code>AufrufKontext</code>.
Die Autorisierungsprüfung erfolgt dann, entsprechend dem Konzept von isy-sicherheit, über die <code>Gesichert</code>-Annotation an der Service-Implementierung.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="autorisierung_eines_httpinvoker_service"><a class="anchor" href="#autorisierung_eines_httpinvoker_service"></a>2. Autorisierung eines HttpInvoker Service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bei HttpInvoker Services wird erwartet, dass der <code>AufrufKontext</code> als erster Parameter mitgesendet wird.
Dieser wird dann zur Autorisierungsprüfung herangezogen.</p>
</div>
<div class="paragraph">
<p>Aktuell gibt es noch keine Festlegungen zur Nutzung von Tokens auch bei HttpInvoker.</p>
</div>
</div>
</div>
<h1 id="testunterstuetzung" class="sect0"><a class="anchor" href="#testunterstuetzung"></a>Testunterstützung</h1>
<div class="paragraph">
<p>In diesem Abschnitt wird <strong>isy-sicherheit-keycloak-test</strong> beschrieben.</p>
</div>
<div class="paragraph">
<p>Isy-sicherheit-test enthält Hilfsklassen zum Erstellen von (automatisierten) Tests, in welchen isy-sicherheit-keycloak benötigt wird.
Das Projekt enthält eine Mock-Implementierung von Keycloak.
Zur Simulation des REST-Services wird WireMock verwendet.</p>
</div>
<div class="paragraph">
<p>Isy-sicherheit-test wird auch in den Unit-Tests des Projekts isy-sicherheit-keycloak verwendet.</p>
</div>
<div class="paragraph">
<p>Das folgende Beispiel zeigt die einfache Initialisierung eines Mocks für Keycloak, mit genau einem Nutzer mit genau einer Rolle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">EmbeddedKeycloakMock embeddedKeycloak = new EmbeddedKeycloakMock("localhost", 9095, "testRealm", new RsaKeyGenerator());
embeddedKeycloak.addUser("testUser", "testPwd", "testBhknz", Collections.singleton("testRolle"));</code></pre>
</div>
</div>
</article>
  </div>
</main>
</div>
<div class="divFooter"></div>

<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/isyfact.js"></script>
  </body>
</html>
