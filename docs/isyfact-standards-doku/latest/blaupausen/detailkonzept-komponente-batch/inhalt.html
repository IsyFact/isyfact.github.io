<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Detailkonzept Batch: Inhalt :: IsyFact Dokumentation</title>
    <link rel="canonical" href="https://isyfact.github.io/isyfact-standards-doku/latest/blaupausen/detailkonzept-komponente-batch/inhalt.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../../../_/css/isyfact.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://isyfact.github.io">IsyFact Dokumentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="isyfact-standards-doku" data-version="2.5.0-SNAPSHOT">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../einstieg/einstieg.html">IsyFact Standards</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../einstieg/einstieg.html">Einstieg</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../einstieg/vorstellung.html">Vorstellung der IsyFact</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/isyfact-standards.html">IsyFact-Standards</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/isyfact-erweiterungen.html">IsyFact-Erweiterungen</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/rahmenbedingungen.html">Rahmenbedingungen</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/erste-schritte.html">Erste Schritte</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/produkte.html">Eingesetzte Produkte</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/tutorial/master.html">Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/whitepaper.html">Whitepaper</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/migrationsleitfaden-if2/master.html">Migrationsleitfaden IsyFact 2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../blaupausen.html">Blaupausen</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../referenzarchitektur/master.html">Referenzarchitektur</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../referenzarchitektur-it-system/master.html">Referenzarchitektur IT-System</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../detailkonzept-komponente-anwendungskern/master.html">Anwendungskern</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../detailkonzept-komponente-datenzugriff/master.html">Datenzugriff</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../detailkonzept-komponente-service/master.html">Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../detailkonzept-komponente-web-gui/master.html">Web GUI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="master.html">Batch</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Vorgaben</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../vorgaben-architektur/master.html">Architektur</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../vorgaben-it-sicherheit/master.html">IT-Sicherheit</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../bausteine/bausteine.html">Bausteine</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Datum &amp; Zeit</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-datetime/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-datetime/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Fehlerbehandlung</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-exception-core/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-exception-core/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">HttpInvoker</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-serviceapi-core/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-serviceapi-core/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Konfiguration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-konfiguration/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-konfiguration/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Logging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-logging/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-logging/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Polling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-polling/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-polling/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">REST</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-service-rest/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-service-rest/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sicherheit</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sicherheit/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sicherheit/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sonderzeichen</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sonderzeichen/konzept/sonderzeichen.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sonderzeichen/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Task Scheduling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-task/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-task/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Überwachung</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-ueberwachung/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-ueberwachung/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Util</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-util/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Styleguide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../isyfact-style-doku/latest/isy-style/styleguide.html">Styleguide</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../isyfact-style-doku/latest/isy-style/nutzungsvorgaben/nutzungsvorgaben.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">JSF</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../isyfact-jsf-doku/latest/isy-web/konzept/konzept.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../../isyfact-jsf-doku/latest/isy-web/nutzungsvorgaben/nutzungsvorgaben.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../plattform/plattform.html">Plattform</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/methodik.html">Methodik</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/namenskonventionen/master.html">Namenskonventionen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/versionierung/master.html">Versionierung</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/java-programmierkonventionen/master.html">Java-Programmierkonventionen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/diagrammerstellung.html">Diagrammerstellung und Modellierung</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/diagrammerstellung/diagramsnet.html">diagrams.net</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/diagrammerstellung/enterprise-architect.html">Enterprise Architect</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/vorlagen.html">Vorlagen</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/vorlagen/bearbeitung.html">Bearbeitung der AsciiDoc-Vorlagen</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../werkzeuge/werkzeuge.html">Werkzeuge</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../werkzeuge/dokumentation/einleitung/einfuehrung.html">Dokumentation gemäß IsyFact</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../werkzeuge/dokumentation/master-antora.html">Projektseite mit Antora (empfohlen)</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../werkzeuge/seitenvorlage.html">Seitenvorlage</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../werkzeuge/kopiervorlage.html">Kopiervorlage für neue Seiten</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../werkzeuge/dokumentation/master-asciidoctorJ.html">Dokumente mit AsciidoctorJ Extensions</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../werkzeuge/entwicklungsumgebung/master.html">Entwicklungsumgebung</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../werkzeuge/versionierungskontrolle/master.html">Versionierungskontrolle</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../changelog/changelog.html">Changelog</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">IsyFact Standards</span>
    <span class="version">2.5 (DEV)</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../glossary/latest/glossary/master.html">Glossar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../glossary/latest/glossary/master.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../einstieg/einstieg.html">IsyFact Standards</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../einstieg/einstieg.html">2.5 (DEV)</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../isyfact-jsf-doku/latest/isy-web/konzept/konzept.html">JavaServer Faces (JSF)</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../isyfact-jsf-doku/latest/isy-web/konzept/konzept.html">5.3</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../isyfact-style-doku/latest/isy-style/styleguide.html">Styleguide</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../isyfact-style-doku/latest/isy-style/styleguide.html">5.4</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../einstieg/vorstellung.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../einstieg/einstieg.html">IsyFact Standards</a></li>
    <li><a href="inhalt.html">Detailkonzept Batch: Inhalt</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Inhalt" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Detailkonzept Batch: Inhalt</h1>
<div class="sect1">
<h2 id="einfuehrung"><a class="anchor" href="#einfuehrung"></a>1. Einführung</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="vorgehen"><a class="anchor" href="#vorgehen"></a>1.1. Vorgehen</h3>
<div class="paragraph">
<p>Der Begriff „Batch“ bedeutet im Kern lediglich „nicht interaktive Stapelverarbeitung“. Wie ein Batch technisch umgesetzt werden soll, hängt davon ab, was konkret unter einem Batch verstanden wird.
Im Folgenden wird deshalb zuerst beschrieben, was ein Batch im Sinne der IsyFact ist.</p>
</div>
<div class="paragraph">
<p>Ein Batch teilt sich auf in einen „Batchrahmen“, die Batchlogik der einzelnen Batch-Anwendungen, sowie die von ihnen aufgerufenen Komponenten des Anwendungskerns.
Was darunter verstanden wird, wird in Kapitel <a href="#die-aufteilung-in-batchrahmen-und-batchlogik">Die Aufteilung in Batchrahmen und Batchlogik</a> beschrieben.</p>
</div>
</div>
<div class="sect2">
<h3 id="was-ist-ein-batch"><a class="anchor" href="#was-ist-ein-batch"></a>1.2. Was ist ein Batch?</h3>
<div class="paragraph">
<p>Eine Geschäftsanwendung stellt über ihre Komponenten fachliche Operationen bereit.
Diese Operationen werden (zum Teil) als Services bereitgestellt.
Sie werden aber auch bei der automatisierten Bearbeitung größerer Datenmengen in Batches verwendet.
Typischerweise verarbeiten Batches dabei Dateilieferungen oder eine definierte Menge von Datensätzen aus dem Datenbestand.
Einige der Operationen von Anwendungskomponenten werden nur für Services, einige nur für Batch-Verarbeitungen, andere für beides verwendet.</p>
</div>
</div>
<div class="sect2">
<h3 id="_namenskonvention_für_eine_batchanwendung"><a class="anchor" href="#_namenskonvention_für_eine_batchanwendung"></a>1.3. Namenskonvention für eine Batchanwendung</h3>
<div class="paragraph">
<p>Mit vielen Systemen wird eine eigene Batch-Deploymenteinheit ausgeliefert.
Diese wird folgendermaßen benannt.</p>
</div>
<table id="table-nambat" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 1. Name einer Batchanwendung</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Name der Batchanwendung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;anwendungsname&gt;-batch</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>xyz-ga-batch<br>
xyz-register-batch</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Variable</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Mögliche Ausprägungen</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;anwendungsname&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Name einer Anwendung, wie in den vorigen Abschnitten beschrieben.
Er setzt sich meistens aus einem Systemkürzel und dem Systemtyp zusammen.</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="die-bestandteile-eines-batches-und-die-zielarchitektur"><a class="anchor" href="#die-bestandteile-eines-batches-und-die-zielarchitektur"></a>1.3.1. Die Bestandteile eines Batches und die Zielarchitektur</h4>
<div class="paragraph">
<p>Ein Batch verwendet für die fachliche Verarbeitungslogik die Operationen der Komponenten der Geschäftsanwendung.
Neben der fachlichen Verarbeitungslogik besteht die Anwendungslogik eines Batches aus folgenden Bestandteilen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>der technischen Logik, welche spezifisch für genau eine Batch-Implementierung ist: Funktionalität für das Einlesen der für die Verarbeitung benötigten Daten, das Aufrufen der Fachkomponenten etc.</p>
</li>
<li>
<p>querschnittliche Logik, welche für alle Batches gleich ist.
Dies ist z. B. die Checkpoint-Restart Logik (siehe Kapitel <a href="#checkpoint-restart-logik">Checkpoint / Restart Logik</a>).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In <a href="#image-AnwLogBat">Abbildung 1</a> werden diese Bestandteile in der Zielarchitektur hervorgehoben: Die spezifische technische
Batchlogik wird in Punkt 1 dargestellt, die fachlichen Operationen der Komponenten finden sich in Punkt 2.
Die querschnittliche Logik wird lediglich als Bibliothek eingebunden und ist in der Abbildung nicht dargestellt.</p>
</div>
<div class="paragraph">
<p>Die Komponente „Batchsteuerung“ der Zielarchitektur bezieht sich auf die Steuerung eines Batch-Netzes (siehe <a href="#image-BatNetz">Abbildung 2</a>) und
wird über UC4 (siehe auch <a href="../../isy-konfiguration/konzept/master.html#einleitung" class="xref page">Konzept Konfiguration</a>) umgesetzt.
Sie wird in diesem Dokument nicht betrachtet.</p>
</div>
<div class="paragraph">
<p>Die Komponente „Batchlogik“ der Zielarchitektur ist eine logische Komponente, welche die technische Logik der
Batchimplementierungen der Geschäftsanwendung beinhaltet.
Diese Logik ist technisch gesehen keine Komponente, sondern eine Sammlung unabhängiger Klassen in der Batch-Schicht
der Geschäftsanwendung.
Im Dokument wird unter Batchlogik diese Klassensammlung und keine Komponente verstanden.</p>
</div>
<div id="image-AnwLogBat" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-batch/AnwLogBat.png" alt="AnwLogBat">
</div>
<div class="title">Abbildung 1. Die Anwendungslogik eines Batches (Zielarchitektur)</div>
</div>
</div>
<div class="sect3">
<h4 id="checkpoint-restart-logik"><a class="anchor" href="#checkpoint-restart-logik"></a>1.3.2. Checkpoint / Restart Logik</h4>
<div class="paragraph">
<p>Da ein Batch in einem Lauf eine große Anzahl an Datensätzen verarbeiten muss, soll seine Verarbeitung nicht in einer Transaktion durchgeführt werden.
Ebenso soll nicht jeder Datensatz in einer eigenen Transaktion verarbeitet werden, wie es die Transaktionssteuerung des Anwendungskerns vorsieht.
Vielmehr wird ein Batch sein Arbeitspaket in mehreren Paketen, und damit auch Transaktionen, abarbeiten.
Bei einem Wiederanlauf nach einem Fehler muss der Batch in der Lage sein, die bis zu seinem letzten Commit verarbeiteten Datensätze zu überlesen und nur die „neuen“ Datensätze zu verarbeiten.
Das Commit einer Transaktion bezeichnet man in diesem Fall als Checkpoint.
Das Überlesen bereits verarbeiteter Datensätze nennt man Checkpoint / Restart Fähigkeit.</p>
</div>
<div class="paragraph">
<p>Für die Umsetzung der Checkpoint / Restart Fähigkeit muss der Batch in jeder Transaktion speichern, welche Datensätze bis zum Commit verarbeitet wurden. Üblicherweise geschieht das durch die Ablage der Anzahl verarbeiteter Datensätze bis zum Commit.
Abgelegt werden diese Daten in einer Batch-Statustabelle, welche für jeden Batch eine Zeile enthält.</p>
</div>
</div>
<div class="sect3">
<h4 id="der-unterschied-zwischen-batch-netz-batch-schritt-und-batch-implementierung"><a class="anchor" href="#der-unterschied-zwischen-batch-netz-batch-schritt-und-batch-implementierung"></a>1.3.3. Der Unterschied zwischen Batch-Netz, Batch-Schritt und Batch-Implementierung</h4>
<div class="paragraph">
<p>Die Verarbeitung von Massendaten durch einen Batch verläuft meist in mehreren Schritten: Die Verarbeitung einer Datei kann beispielsweise aus ihrer Übertragung auf einen internen Server, ihrer nachfolgenden Prüfung und der Verarbeitung ihres Inhalts bestehen.
Diese Verarbeitungsschritte (<em>Batch-Schritte</em>) eines Batches bilden ein „Batch-Netz“. Jeder Schritt wird über den Aufruf eines Shell-Skripts gestartet.</p>
</div>
<div id="image-BatNetz" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-batch/BatNetz.png" alt="BatNetz">
</div>
<div class="title">Abbildung 2. Ein Batch-Netz</div>
</div>
<div class="paragraph">
<p>Die meisten Batch-Schritte sind keine Anwendungen: Sie werden komplett über ein Skript umgesetzt.
Nur die Schritte, welche die Verarbeitung in der Geschäftsanwendung durchführen, sind Anwendungen und besitzen eine Java-Implementierung (die <em>Batchschritt-Implementierung</em>). In obiger Abbildung wird die Verarbeitung in der Geschäftsanwendung durch drei Batch-Schritte parallel durchgeführt.
Alle drei verwenden dieselbe Batchschritt-Implementierung, arbeiten aber auf anderen Daten.</p>
</div>
<div class="paragraph">
<p>Ein Batch-Netz wird durch einen Job-Scheduler gesteuert.
Ein Batch-Schritt ist dabei der Aufruf, welcher vom Scheduler aufgerufen wird.
Aufgerufen wird ein Skript mit einer bestimmten Konfiguration. Über dieses Skript wird ggf.
eine Geschäftsanwendung mit der übergebenen Konfiguration ausgeführt.
Die Konfiguration eines Batchschrittes enthält stets eine Batchschritt-ID, welche den Batchschritt eindeutig identifiziert.
Das bedeutet, dass jeder der drei Batchschritte in <a href="#image-BatNetz">Abbildung 2</a> eine eigene Batchschritt-ID erhält, obwohl alle drei Batchschritte die gleiche Batchschritt-Implementierung verwenden.
Der Grund ist, dass jeder Batchschritt auf einem anderen Nummernkreis arbeitet und somit die Batchschritte unterscheidbar sein müssen.
Diese Unterscheidung erfolgt über die Batchschritt-ID.</p>
</div>
<div class="paragraph">
<p>Dieses Dokument befasst sich nicht mit Batch-Netzen oder ihrer Steuerung.
Es behandelt die Geschäftsanwendung-Batchimplementierungen und ihre Konfigurationen.
Der Einfachheit halber wird deshalb ein Geschäftsanwendung-Batchschritt als „Batch“ und eine Batchschritt-ID als „Batch-ID“ bezeichnet.</p>
</div>
<div class="paragraph">
<p>Wichtig ist jedoch die Unterscheidung zwischen Batch und Batch-Implementierung: Der Batch ist der Aufruf aus der Produktionssteuerung heraus. Über ihn wird die aufzurufende Batch-Implementierung sowie seine Konfiguration (inklusive der Batch-ID) definiert.
Die Implementierung ist Java-Code, der von mehreren Batches verwendet werden darf.</p>
</div>
</div>
<div class="sect3">
<h4 id="die-aufteilung-in-batchrahmen-und-batchlogik"><a class="anchor" href="#die-aufteilung-in-batchrahmen-und-batchlogik"></a>1.3.4. Die Aufteilung in Batchrahmen und Batchlogik</h4>
<div class="paragraph">
<p>Das Einlesen und Verarbeiten von Datensätzen durch den Aufruf fachlicher Komponenten wird in diesem Dokument <em>Batchlogik</em> genannt.
Diese ist spezifisch für genau eine Batch-Implementierung.</p>
</div>
<div class="paragraph">
<p>Neben dieser Logik enthält eine Batch-Implementierung Querschnittsfunktionalität, welche stets gleich ist.
Für eine Batch-Implementierung umfasst diese Querschnittsfunktionalität folgende Punkte:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Einlesen der Konfiguration des Batches über die Kommandozeile und Konfigurationsdateien</p>
</li>
<li>
<p>Instanziieren der Geschäftsanwendungs-Komponenten in einem Spring-Kontext</p>
</li>
<li>
<p>Initialisieren, Auslesen und Verwalten der Batch-Statustabelle</p>
</li>
<li>
<p>Aufruf des Überlesens von Datensätzen bei einem Restart</p>
</li>
<li>
<p>Steuerung der Transaktionen inklusive Speicherung des Fortschritts in einer Status-Tabelle</p>
</li>
<li>
<p>Bereitstellung von Überwachungsmöglichkeiten</p>
</li>
<li>
<p>Authentifizierung und Autorisierung eines betrieblich konfigurierten Batchbenutzers über die T-Komponente Sicherheit</p>
</li>
<li>
<p>Konfiguration, Instanziierung und Aufruf der eigentlichen Batchlogik</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Diese Funktionalität wird in einer Batch-Implementierung durch eine querschnittliche Komponente namens <em>Batchrahmen</em> umgesetzt.
Diese wird über eine Bibliothek bereitgestellt, welche in jede Geschäftsanwendung eingebunden wird.</p>
</div>
</div>
<div class="sect3">
<h4 id="grobe-architektur-des-batchrahmens"><a class="anchor" href="#grobe-architektur-des-batchrahmens"></a>1.3.5. Grobe Architektur des Batchrahmens</h4>
<div class="paragraph">
<p>Für den Batchrahmen wurde folgende grobe Architektur gewählt:</p>
</div>
<div id="image-GrobArchBatCanv" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-batch/GrobArchBatCanv.png" alt="GrobArchBatCanv" width="80%">
</div>
<div class="title">Abbildung 3. Grobe Architektur des Batchrahmens</div>
</div>
<div class="paragraph">
<p>Der Batchrahmen besteht aus einem Startprogramm, welches notwendige Initialisierungen vornimmt, und einer Komponente Batchrahmen.
Die Komponente Batchrahmen übernimmt die Steuerung des Batches und den Aufruf der Batchlogik.</p>
</div>
<div class="paragraph">
<p>Die Komponenten einer Geschäftsanwendung werden für einen Batch, genau wie in der Webanwendung, über das Spring-Framework verwaltet.
Damit die Konfigurationen für die Webanwendung und für die Batch-Implementierungen möglichst gleich sind, werden die Komponenten für den Batchrahmen und die Batchlogik in einer separaten Konfigurationsdatei und einem separaten Spring-Kontext abgelegt.
Dieser Kontext ist ein Kind-Kontext des eigentlichen <a href="../../../../glossary/latest/glossary/master.html#glossar-anwendungskontext" class="xref page">Anwendunskontextes</a> und kann alle Beans des Anwendungskontextes verwenden.
So kann die Konfiguration der Webanwendung mit minimalen Anpassungen auch für den Batch verwendet werden.</p>
</div>
<div class="paragraph">
<p>Der Batchrahmen benötigt für die Speicherung des Fortschritts und des Status der Batches eine Datenbankverbindung.
In der Datei werden die vom Batchrahmen benötigten Informationen gespeichert, siehe <a href="#die-tabellen-des-batchrahmens">Die Tabellen des Batchrahmens</a>.</p>
</div>
<div class="paragraph">
<p>Bei Bedarf können in einem Batch auch weitere Datenbankverbindungen genutzt werden.
Die Einbindung weiterer Datenbanken ist in <a href="../detailkonzept-komponente-datenzugriff/master.html" class="xref page">Detailkonzept Komponente Datenzugriff</a> beschrieben.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="batches-als-eigenes-it-system"><a class="anchor" href="#batches-als-eigenes-it-system"></a>1.4. Batches als eigenes IT-System</h3>
<div class="paragraph">
<p>Batches existieren meistens als weiterer Zugangsweg in der Nutzungsschicht einer bestehenden Geschäftsanwendung
(siehe <a href="#image-AnwLogBat">Abbildung 1</a>), da sie auf den Daten des jeweiligen Anwendungssystems operieren.</p>
</div>
<div class="paragraph">
<p>Es kann allerdings auch Batches geben, die unabhängig von einer bestimmten Geschäftsanwendung sind.
Dies kann beispielsweise der Fall sein, wenn ein Import-Batch angelieferte Dateien in verschiedene Geschäftsanwendungen importiert.
Wenn Batches nicht eindeutig einem Anwendungssystem zugeordnet werden können, kann man sie auch als eigenständiges IT-System implementieren.
Dieses „Batch-System“ kann dann die Service-Schnittstellen anderer Geschäftsanwendungen aufrufen.
Insgesamt ist dies jedoch als Sonderfall zu betrachten.
In der Regel gehören Batches zu Geschäftsanwendungen, sie enthalten damit den fachlichen Code dieser Anwendung und
nutzen diesen nicht über Service-Schnittstellen (siehe Kapitel <a href="#das-deployment-eines-batches">Das Deployment eines Batches</a>).</p>
</div>
<div class="paragraph">
<p>In diesem Fall ist das Anwendungssystem architektonisch ein eigenständiges IT-System nach Zielarchitektur, nur ohne Service und GUI Bereiche in der Nutzungsschicht.</p>
</div>
<div class="paragraph">
<p>Batches die zu einer Geschäftsanwendung gehören sollen jedoch nicht als eigenständiges IT-System umgesetzt werden.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="anforderungen"><a class="anchor" href="#anforderungen"></a>2. Anforderungen</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="anforderungen-an-den-batchrahmen"><a class="anchor" href="#anforderungen-an-den-batchrahmen"></a>2.1. Anforderungen an den Batchrahmen</h3>
<div class="paragraph">
<p>Für den Batchrahmen selbst gelten folgende Anforderungen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Er soll den vorhandenen Nutzungsvorgaben und Querschnitts­konzepten entsprechen.</p>
</li>
<li>
<p>Die Spring-Konfiguration für den Batch soll der Konfiguration der Webanwendung möglichst ähnlich sein.</p>
</li>
<li>
<p>Er soll möglichst wenige Anforderungen an (bzw.
Annahmen in Bezug auf) die Batchlogik stellen.</p>
</li>
<li>
<p>Die Batchlogik soll möglichst einfach implementiert werden können.</p>
</li>
<li>
<p>Die Batchrahmen-Implementierung soll programmtechnisch effizient sein.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="anforderungen-an-die-batchimplementierung"><a class="anchor" href="#anforderungen-an-die-batchimplementierung"></a>2.2. Anforderungen an die Batchimplementierung</h3>
<div class="paragraph">
<p>Für die umzusetzende Batchlogik gelten folgende Anforderungen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Sie sollen keine Fachlogik enthalten, sondern die Komponenten des Anwendungskerns verwenden.
Abweichungen sind nur aus zwingenden Performance-Gründen erlaubt.
Dies ist jeweils mit dem technischen Chefarchitekten abzustimmen und im Systementwurf zu dokumentieren.
Falls in Ausnahmefällen direkte Datenbankzugriffe notwendig sind, sind alle weiteren Verarbeitungen an die Fach-Komponenten zu delegieren.</p>
</li>
<li>
<p>Die Batchlogik soll die Logging-, Statistik- und Protokollierungs-Aufgaben nach Anforderung des Projekts umsetzen.
Diese wird nicht durch den Batchrahmen umgesetzt.
Insbesondere die Statistikinformationen sind für Betrieb und Fachbereich wichtige Informationsquellen, um beispielsweise Laufzeitabschätzungen für die Produktion durchführen zu können.
In der Statistik sollte immer enthalten sein, wie viele Sätze verarbeitet wurden (erfolgreich und mit Fehlern) und was konkret unter dem Begriff „Satz“ zu verstehen ist.
Ist dies in der Statistik nicht vermerkt, wird davon ausgegangen, dass es sich um den Hauptsatz der Geschäftsanwendung handelt.
Was der Hauptsatz einer Geschäftsanwendung ist, hängt von der konkreten Anwendung ab.</p>
</li>
<li>
<p>Die Batchlogik soll die Funktionalität des „Überlesens“ von Datensätzen übernehmen.
Ob und welche Datensätze zu überlesen sind, teilt der Batchrahmen mit.</p>
</li>
<li>
<p>Die Batchlogik soll dem Batchrahmen hinreichende Informationen übergeben, um den Wiederanlaufpunkt bei einem späteren Restart zu bestimmen.</p>
</li>
<li>
<p>Der Batchrahmen führt in konfigurierbaren Intervallen Commits durch, um das Fortsetzen des Batches nach einem Abbruch zu ermöglichen.
Die Batchlogik soll mit solchen periodischen Commits umgehen können.</p>
</li>
<li>
<p>Die Batchlogik sollte – sofern es keine inhaltlichen Abhängigkeiten gibt – mit parallel laufenden Batches umgehen können.
Damit ist nicht nur gemeint, dass die gleiche Batchschritt-Implementierung parallel auf z. B. verschiedenen Nummernkreisen arbeiten kann.
Vielmehr ist damit gemeint, dass verschiedene Batchschritt-Implementierung parallel ausgeführt werden können.
Dazu ist sicherzustellen, dass gemeinsam genutzte Ressourcen nicht unnötig gehalten werden.</p>
</li>
<li>
<p>Bei der Ausgabe von vielen Dateien während eines Batchlaufs sind diese strukturiert in Unterverzeichnissen abzulegen.
Es ist eine Datei-Namenskonvention für die Batch-Implementierung festzulegen.
Die Unterverzeichnisstruktur und die Anzahl der darin enthaltenen Dateien sollen parametrisierbar sein.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="anforderungen-an-die-dokumentation-von-batches"><a class="anchor" href="#anforderungen-an-die-dokumentation-von-batches"></a>2.3. Anforderungen an die Dokumentation von Batches</h3>
<div class="paragraph">
<p>Für die Dokumentation von Batches gelten neben der lückenlosen und kurzen Beschreibung der durchgeführten Funktionen noch folgende Anforderungen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Es muss auf lang laufende Batches hingewiesen werden.
Dies ist abhängig von der umgesetzten Batchlogik und der erwarteten Anzahl an zu verarbeitenden Datensätzen.
Der Betreiber des Batches soll damit schon im Vorfeld längere Batchlaufzeiten einkalkulieren können.</p>
</li>
<li>
<p>Das zu erwartende Laufzeitverhalten bei steigendem Mengengerüst ist anzugeben.
Dadurch soll eine Abschätzung geliefert werden, wie sich der Batch skalieren lässt.
Analog zum zuvor genannten Punkt soll dies eine Hilfe für den Betreiber zur Kalkulation von Batchlaufzeiten sein.</p>
</li>
<li>
<p>Abhängigkeiten von Batches werden dargestellt.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ausgrenzungen"><a class="anchor" href="#ausgrenzungen"></a>3. Ausgrenzungen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Der bereitzustellende Batchrahmen soll ein unkompliziertes und einfach zu verwendendes Framework sein.
Seine Funktionalitäten sollen lediglich die Verarbeitung, nicht andere betriebliche Aspekte abdecken.
Explizit ausgegrenzt werden deshalb folgende Themenbereiche:</p>
</div>
<div class="paragraph">
<p><strong>Ein explizites Handling von Eingabedateien:</strong> Ein möglicherweise erforderliches Dateihandling übernimmt die spezifische Batchlogik.
Der Batchrahmen soll kein Wissen darüber besitzen.</p>
</div>
<div class="paragraph">
<p><strong>Die Terminierung der Verarbeitung:</strong> Der Batch stellt keine direkten Schnittstellen bereit, um ihn während der Verarbeitung zu beenden.
Allerdings muss es möglich sein, einen aktiven Lauf mit dem Signal <code>kill -15</code> definiert zu beenden.
Wie die zugehörige Prozess-ID ermittelt wird, ist in den Betriebshandbüchern für die Prozesse zu definieren.
Es ist auch möglich, mit dem „laufzeit“-Parameter eine maximale Laufzeit anzugeben, um den Batch nach Überschreitung der angegebenen Laufzeit sich selbst definiert beenden zu lassen.</p>
</div>
<div class="paragraph">
<p><strong>Das Scheduling der Verarbeitung:</strong> Das Scheduling wird nicht durch den Batchrahmen, sondern durch die betriebliche Produktionssteuerung durchgeführt.</p>
</div>
<div class="paragraph">
<p><strong>Das Prüfen von Vorbedingungen:</strong> Falls für die Ausführung Vorbedingungen gegeben sein müssen (etwa Dateien in Verzeichnissen vorliegen müssen), so liegt deren Prüfung in der Verantwortung des aufrufenden Skripts.</p>
</div>
<div class="paragraph">
<p><strong>Das Warten auf Events:</strong> Der Batchrahmen arbeitet eine Reihe von Datensätzen ab und beendet sich danach.
Er ist kein Serverprozess, welcher auf bestimmte Events (Dateien in Verzeichnissen, Sätze in Datenbank) wartet, diese verarbeitet und daraufhin weiter wartet.</p>
</div>
<div class="paragraph">
<p><strong>Keine parallele Verarbeitung innerhalb eines Batches:</strong> Es ist erlaubt, dass mehrere Java-Prozesse mit der gleichen Batch-Implementierung (jedoch verschiedenen BatchIDs) parallel laufen.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Hinweis"></i>
</td>
<td class="content">
Siehe Unterschied zwischen <em>Batch-Implementierung</em> und <em>Batch</em>, Kapitel <a href="#was-ist-ein-batch">Was ist ein Batch?</a>.
Parallel laufende Batches sind vor allem sinnvoll, wenn sie über einem aufgeteilten Datenbestand arbeiten und ein Batch pro Teil verwendet wird.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Innerhalb einer Verarbeitung wird jedoch stets mit einem Thread gearbeitet.
Multithreading innerhalb eines Batches wird nicht unterstützt.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="der-batchrahmen"><a class="anchor" href="#der-batchrahmen"></a>4. Der Batchrahmen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Der Batchrahmen ist das Framework, in welches sich die Logik eines konkreten Batches einfügt.
Der Batchrahmen ruft (anhand einer Konfiguration) diese Logik auf.
Da eine Batch-Anwendung über Spring verwaltet wird, wird die Batchlogik als Spring-Bean konfiguriert, als sogenannte <em>Ausführungsbean</em>.
Diese Bean wiederum ruft die Geschäftsanwendungs-Komponenten auf, welche die fachliche Logik enthalten.</p>
</div>
<div class="paragraph">
<p>Für die <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-vorlageanwendung" class="xref page">Vorlage-Anwendung</a> zeigt <a href="#image-BeanGriffBat">Abbildung 4</a> eine Auswahl der vorhandenen Beans.
Wichtig ist ihre Verteilung auf zwei Anwendungskontexte: Der Batchrahmen und die Ausführungsbeans werden in einem eigenen Kontext konfiguriert.
So müssen wenige Anpassungen vorgenommen werden, um aus der Anwendungskontext-Konfiguration als Webanwendung die Konfiguration für den Anwendungskontext im Batchbetrieb zu erhalten.</p>
</div>
<div id="image-BeanGriffBat" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-batch/BeanGriffBat.png" alt="BeanGriffBat">
</div>
<div class="title">Abbildung 4. Bean-Zugriffe des Batchrahmens</div>
</div>
<div class="paragraph">
<p>Für neue Batch-Implementierungen einer Geschäftsanwendung müssen ggf.
Geschäftsanwendungs-Komponenten angepasst, Ausführungsbeans erstellt und diese im Batch-Springkontext konfiguriert werden.
Die folgenden Abschnitte liefern die zur Entwicklung dieser Beans und zur Verwendung des Batchrahmens notwendigen Informationen.
Im Einzelnen werden die folgenden Aspekte beschrieben:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Die Konfigurationsmöglichkeiten des Batchrahmens und der Ausführungsbeans.</p>
</li>
<li>
<p>Das Transaktions-Handling, die Restart-Funktionalität und die Status-Tabellen des Batchrahmens.</p>
</li>
<li>
<p>Die im Batchrahmen enthaltenen Überwachungsmöglichkeiten.</p>
</li>
<li>
<p>Die Authentifizierung und Autorisierung eines Batch-Benutzers.</p>
</li>
<li>
<p>Das Deployment der Batches einer Geschäftsanwendung.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="die-status-und-startarten-des-batchrahmens"><a class="anchor" href="#die-status-und-startarten-des-batchrahmens"></a>4.1. Die Status und Startarten des Batchrahmens</h3>
<div class="paragraph">
<p>Im Folgenden werden die Status beschrieben, in welchen sich ein Batch laut den Batchrahmen-Tabellen befinden kann.
Zusätzlich werden, basierend auf diesen Status, die Möglichkeiten zum Starten eines Batchlaufs beschrieben.
Diese Informationen werden hier vorgestellt und in den folgenden Abschnitten im Zusammenhang mit den Parametern und
Tabellen des Batchrahmens verwendet.</p>
</div>
<div class="paragraph">
<p>Ein Batch befindet sich in einem von vier Status, welche in den Tabellen des Batchrahmens gespeichert werden:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>neu</code>: Status eines noch nicht gelaufenen Batches.
Existiert kein Eintrag in der Datenbank, dann wird dieser Status implizit verwendet.
Bricht ein noch nicht gelaufener Batch noch in der Initialisierungsphase ab, dann wird dieser Status explizit in die Datenbank geschrieben.</p>
</li>
<li>
<p><code>laeuft</code>: Der Batch wurde gestartet und läuft aktuell.</p>
</li>
<li>
<p><code>abgebrochen</code>: Der Batch ist</p>
<div class="ulist">
<ul>
<li>
<p>mit einem Fehler</p>
</li>
<li>
<p>durch das Signal <code>kill -15</code></p>
</li>
<li>
<p>durch die Überschreitung der konfigurierten maximalen Laufzeit</p>
</li>
<li>
<p>oder weil die Grenze der zu verarbeitenden Datensätze erreicht wurde abgebrochen</p>
</li>
</ul>
</div>
</li>
<li>
<p><code>beendet</code>: Der Batch ist erfolgreich beendet worden.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Je nachdem, in welchem Zustand sich der Batch laut den Tabellen gerade befindet, lässt er sich nur mit bestimmten Startarten starten.
Welche Startart verwendet wird, muss über Parameter definiert werden.
Folgende Startarten sind möglich:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Batch im Status <code>neu</code> oder <code>beendet</code>:</strong></p>
<div class="paragraph">
<p><code>start</code>: Der Batch startet und bearbeitet die Eingabedaten ab dem ersten Datensatz.</p>
</div>
</li>
<li>
<p><strong>Batch im Status <code>laeuft</code>:</strong></p>
<div class="paragraph">
<p><code>ignoriereLauf</code>: Der Batch wird gestartet, als wäre er erfolgreich beendet worden.</p>
</div>
<div class="paragraph">
<p><code>restart</code>: Der Batch startet neu und überliest alle bereits verarbeiteten Sätze.</p>
</div>
</li>
<li>
<p><strong>Batch im Status <code>abgebrochen</code>:</strong></p>
<div class="paragraph">
<p><code>restart</code>: Der Batch startet neu und überliest alle bereits verarbeiteten Sätze.</p>
</div>
<div class="paragraph">
<p><code>ignoriereRestart</code>: Der Batch startet neu und beginnt die Verarbeitung mit dem ersten Datensatz.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="die-konfiguration-des-batchrahmens"><a class="anchor" href="#die-konfiguration-des-batchrahmens"></a>4.2. Die Konfiguration des Batchrahmens</h3>
<div class="sect3">
<h4 id="konfigurationsdatei-und-kommandozeilen-parameter"><a class="anchor" href="#konfigurationsdatei-und-kommandozeilen-parameter"></a>4.2.1. Konfigurationsdatei und Kommandozeilen-Parameter</h4>
<div class="paragraph">
<p>Die Konfiguration des Batchrahmens wird über zwei Arten durchgeführt: über</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Kommandozeilen-Parameter und</p>
</li>
<li>
<p>Konfigurationsdateien.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Alle Konfigurationsparameter werden an die Ausführungsbean übergeben und können genutzt werden, um sie zu konfigurieren.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Hinweis"></i>
</td>
<td class="content">
Bei der Nutzung von Dateien, egal ob für Kommandozeilenparameter oder für Konfigurationsdateien,
müssen die Dateien mit absoluten Pfaden angegeben werden.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_reihenfolge_der_auswertung"><a class="anchor" href="#_reihenfolge_der_auswertung"></a>4.2.1.1. Reihenfolge der Auswertung</h5>
<div class="paragraph">
<p>Konfigurationsparameter werden in der folgenden Reihenfolge im Spring-Kontext angezogen. Gleichnamige Parameter werden in dieser Reihenfolge überschrieben.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Konfiguration des Betriebssystems / der JVM</p>
</li>
<li>
<p>Konfigurationsdatei</p>
</li>
<li>
<p>Kommandouzeilen-Parameter</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_kommandozeilen_parameter"><a class="anchor" href="#_kommandozeilen_parameter"></a>4.2.2. Kommandozeilen-Parameter</h4>
<div class="sect4">
<h5 id="_namenskonvention"><a class="anchor" href="#_namenskonvention"></a>4.2.2.1. Namenskonvention</h5>
<table id="table-batckonfig-konfigurationsparameter-kommandozeile" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 2. Batches: Konfigurationsparameter Kommandozeile</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Batches: Konfigurationsparameter Kommandozeile</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-&lt;Parametername&gt; &lt;Parameterwert&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-laufzeit 10</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_standard_parameter"><a class="anchor" href="#_standard_parameter"></a>4.2.2.2. Standard-Parameter</h5>
<div class="paragraph">
<p>Vom Batchrahmen werden folgende Kommandozeilen-Parameter interpretiert:</p>
</div>
<table id="table-CLIBATCanv" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 3. Kommandozeilen-Parameter des Batchrahmens</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Parameter</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-cfg &lt;Dateiname&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name einer Property-Datei mit Konfigurationseinträgen.
Der Dateiname wird relativ zum Klassenpfad interpretiert.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-start</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Starten des Batches und Verarbeitung der Daten ab dem ersten Datensatz.<br>
Batches im Status „beendet“ <em>müssen</em> über „-start“ gestartet werden.<br>
Die gleichzeitige Eingabe von „-start“ und „-restart“ führt zum Abbruch des Batches.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-restart</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Starten des Batches nach einem Fehler-Abbruch: Überlesen der bereits verarbeiteten Datensätze.<br>
Batches im Status „Abbruch“ müssen mit „-restart“ gestartet werden oder zusätzlich den Parameter -ignoriereRestart enthalten.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-ignoriereRestart</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Auch bei Fehlern Start akzeptieren, nicht auf Restart beharren.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-ignoriereLauf</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Auch bei Status "laeuft" Start akzeptieren.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-testmodus</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Startet den Batch im Testmodus.
Dieser arbeitet analog zum normalen Wirkbetrieb, jedoch werden keine Änderungen an Datenbeständen vom Anwendungssystem oder Nachbarsystemen durchgeführt.
Ein detailliertes Konzept ist in Kapitel <a href="#testmodus">Testmodus</a> beschrieben.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-laufzeit &lt;Minuten&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Gibt eine maximale Laufzeit in Minuten an.
Wird die angegebene Zeit überschritten, wird der aktuelle Datensatz zu Ende bearbeitet.
Der Batch bricht vor der Verarbeitung des nächsten Datensatzes mit einem dedizierten Return-Code ab.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_weitere_parameter"><a class="anchor" href="#_weitere_parameter"></a>4.2.2.3. Weitere Parameter</h5>
<div class="paragraph">
<p>Es können auch andere Parameter angegeben werden, die der Namenskonvention genügen</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_konfigurationsdateien"><a class="anchor" href="#_konfigurationsdateien"></a>4.2.3. Konfigurationsdatei(en)</h4>
<div class="paragraph">
<p>Konfigurationsdateien sind syntaktisch property-Dateien.
Die Konfigurationsdatei mit den unten aufgelisteten Parametern wird als statische Konfiguration im Verzeichnis`resources` abgelegt und
kann daher nicht vom Betrieb angepasst werden.</p>
</div>
<div class="paragraph">
<p>Betriebliche Konfigurationen müssen wie in Kapitel <a href="#betriebliche-konfiguration-der-ausfuehrungsbean">Betriebliche Konfiguration der Ausführungsbean</a> beschriebenen
umgesetzt werden.</p>
</div>
<div class="sect4">
<h5 id="_namenskonvention_2"><a class="anchor" href="#_namenskonvention_2"></a>4.2.3.1. Namenskonvention</h5>
<table id="table-batch-property-files" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 4. Batches: Benennung Konfigurationsdateien</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Batches: Benennung Konfigurationsdateien (unter resources/resources/batch)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schemata</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batchname-des-batches&gt;.properties</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>loeschfrist-pruefen.properties<br>
import-bhknz-liste.properties</code></p></td>
</tr>
</tbody>
</table>
<table id="table-batckonfig-konfigurationsparameter-konfigurationsdatei" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 5. Batches: Konfigurationsparameter Konfigurationsdatei</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Batches: Konfigurationsparameter Konfigurationsdatei</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;Parametername&gt;=&lt;Parameterwert&gt;<br>
&lt;Parametername&gt;.&lt;Parametername&gt;=&lt;Parameterwert&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchName=LoeschBatch<br>
Loeschfunktion.DatumVon=30.11.2019</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_standard_konfigurationsparameter"><a class="anchor" href="#_standard_konfigurationsparameter"></a>4.2.3.2. Standard-Konfigurationsparameter</h5>
<div class="paragraph">
<p>Die nachfolgenden Parameter sind in der Batchkomponente als Standard definiert und werden der
Konfiguration in der Property-Datei hinzugefügt.</p>
</div>
<div class="paragraph">
<p>Aus der Property-Datei werden durch den Batchrahmen folgende Properties gelesen:</p>
</div>
<table id="table-PropBATCanv" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 6. Die Properties des Batchrahmens</caption>
<colgroup>
<col style="width: 55.5555%;">
<col style="width: 44.4445%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batchrahmen.BeanName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name der Batchrahmen-Bean</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Anwendung.SpringDateien.&lt;N&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vollqualifizierte Namen der Spring-Konfigurationsklassen der Geschäftsanwendung</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batchrahmen.SpringDateien.&lt;N&gt;</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Vollqualifizierte Namen der Spring-Konfigurationsklassen des Batchrahmens</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batchrahmen.CommitIntervall</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anzahl Satz-Verarbeitungen pro Commit</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batchrahmen.ClearIntervall</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Anzahl Satz-Verarbeitungen bis zum Löschen des Hibernate session cache. Dies dient Perfomancegründen und der Vermeidung von out of memory Fehlern.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AusfuehrungsBean</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name der Ausführungsbean für die Batchlogik</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID des Batches (ID des Batch-Status-Datensatzes)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name des Batches in der Batch-Statustabelle</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batchrahmen.AnzahlZuVerarbeitendeDatensaetze</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Falls nicht die ganze Datei verarbeitet werden soll, sondern nur eine gewisse Anzahl an Datensätzen.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batchrahmen.Ergebnisdatei</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Pfad zur XML-Ergebnisdatei des Batchrahmens (siehe Kapitel <a href="#rueckgabewerte-des-batchrahmens">Rückgabewerte des Batchrahmens</a>)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_weitere_parameter_2"><a class="anchor" href="#_weitere_parameter_2"></a>4.2.3.3. Weitere Parameter</h5>
<div class="paragraph">
<p>Die Property-Datei darf beliebige weitere Properties enthalten, die der Namenskonvention genügen.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="betriebliche-konfiguration-der-ausfuehrungsbean"><a class="anchor" href="#betriebliche-konfiguration-der-ausfuehrungsbean"></a>4.2.4. Betriebliche Konfiguration der Ausführungsbean</h4>
<div class="paragraph">
<p>Sämtliche obigen Parameter müssen vom Betrieb nicht angepasst werden.
Falls im Ausnahmefall die Batch-ID angepasst werden muss, kann dies über den Kommandozeilen-Parameter –BatchId &lt;BatchId&gt; geschehen.</p>
</div>
<div class="paragraph">
<p>Falls für die Ausführungsbean eines Batches Konfigurationen notwendig sind, welche durch den Betrieb gepflegt werden müssen, so ist dies auf eine von zwei Arten umzusetzen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Die Konfigurationen können der betrieblichen Konfiguration der Geschäftsanwendung hinzugefügt werden.<br></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Hinweis"></i>
</td>
<td class="content">
Konfiguration der Geschäftsanwendung: Die im Ordner <code>config</code> liegenden, durch den Betrieb pflegbaren Konfigurationsdateien.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Die Ausführungsbean kann dann die Geschäftsanwendungs-Konfigurationsbean per Dependency Injection erhalten und sich darüber konfigurieren.</p>
</div>
<div class="paragraph">
<p>Diese Möglichkeit ist zu verwenden, falls nur ein Batch für die Geschäftsanwendung umgesetzt wird.
Falls mehrere Batches umgesetzt werden, ist sie dann zu verwenden, wenn sich die Konfigurationen für die einzelnen Batches nicht widersprechen (also für verschiedene Batches verschiedene Werte für die gleiche Property erwartet werden).</p>
</div>
</li>
<li>
<p>Die Konfiguration kann in einer neuen Datei abgelegt werden, welche nur für diesen Batch verwendet wird.
Diese Datei kann als Properties-Bean geladen und der Ausführer-Bean per Dependency Injection übergeben werden.<br></p>
<div class="paragraph">
<p>Diese Möglichkeit ist zu verwenden, falls für verschiedene Batches verschiedene Konfigurationsdateien benötigt werden.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="die-konfiguration-der-spring-kontexte"><a class="anchor" href="#die-konfiguration-der-spring-kontexte"></a>4.2.5. Die Konfiguration der Spring-Kontexte</h4>
<div class="paragraph">
<p>Wie in Kapitel <a href="#grobe-architektur-des-batchrahmens">Grobe Architektur des Batchrahmens</a> beschrieben, werden für einen Batch zwei Spring-Kontexte erzeugt:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ein Kontext mit den Beans der eigentlichen Geschäftsanwendung.</p>
</li>
<li>
<p>Ein Kontext mit der Batchrahmen-Bean, der Batchrahmen JMX-Bean sowie den Ausführungsbeans für die Batches der Geschäftsanwendung.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Für den Kontext der eigentlichen Geschäftsanwendung können die Spring-Konfigurationsdateien übernommen werden.
In ihnen müssen folgende Anpassungen vorgenommen werden:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Beans, die für die Batch-Verarbeitung nicht benötigt werden, sollten entfernt werden (Service-Beans, GUI-Beans).</p>
</li>
<li>
<p>Damit die Entity-Klassen des Batchrahmens gefunden werden können, muss in der Spring-Konfiguration der Batches ein Entity-Scan hinzugefügt werden:</p>
<div class="literalblock">
<div class="content">
<pre>@EntityScan("de.bund.bva.isyfact.batchrahmen.persistence.rahmen")</pre>
</div>
</div>
</li>
<li>
<p>Das Nachrichten-Resource-Bundle für den Batch muss der <code>messageSource</code>-Bean hinzugefügt werden.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Um Beans gezielt aus der Spring-Konfiguration der Anwendung für die Ausführung eines Batches auszuschließen, kann die
Annotation <code>@ExludeFromBatchContext</code> verwendet werden.
Damit werden mit <code>@Component</code> annotierte Klassen oder <code>@Bean</code>-Methoden in <code>@Configuration</code>-Klassen annotiert (<a href="#listing-excludefrombatchcontext">Listing 1</a>).</p>
</div>
<div id="listing-excludefrombatchcontext" class="listingblock">
<div class="title">Listing 1. Verwendung der Annotation @ExcludeFromBatchContext</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Component
@ExcludeFromBatchContext
public class BeispielServiceExceptionFassade { ...


@Configuration
public class ServiceConfig {
    @Bean
    @ExcludeFromBatchContext
    public BeispielServiceExceptionFassade() { ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Die Spring-Konfiguration für den Kontext des Batchrahmens muss neu erstellt werden.
Hierfür werden gesonderte <code>@Configuration</code>-Klassen erstellt.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="die-tabellen-des-batchrahmens"><a class="anchor" href="#die-tabellen-des-batchrahmens"></a>5. Die Tabellen des Batchrahmens</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Der Batchrahmen benötigt für seine Checkpoint / Restart Funktionalität die Möglichkeit, bei jedem Commit den aktuellen Stand des Batches in einer Tabelle zu speichern.
Dies wird über die Tabelle BatchStatus umgesetzt.</p>
</div>
<div id="image-SchemTabBatStat" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-batch/SchemTabBatStat.png" alt="SchemTabBatStat">
</div>
<div class="title">Abbildung 5. Tabellen-Schema für die Batchrahmen-Tabelle</div>
</div>
<div class="paragraph">
<p>Die Tabelle BatchStatus enthält für jeden Batch eine Zeile.
Ein Batch ist nicht gleichzusetzen mit der Batch-Ausführungsbean.
Für eine Bean darf es mehrere Batches geben, welche die Bean für die Ausführung jeweils anders konfigurieren.
Für einen Batch werden folgende Informationen verwendet:</p>
</div>
<table id="table-SchemTabBatStat2" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 7. Das Schema der Tabelle BatchStatus</caption>
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Spalte</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Schlüssel für den Batch.
Die ID sollte aus einem gemeinsamen Präfix für die Geschäftsanwendung, gefolgt von einem Suffix für den konkreten Batch, bestehen.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ein kurzer informativer Name des Batches.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchStatus</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Einer der folgenden Werte:<br>
<strong>laeuft</strong>: Der Batch wurde gestartet und läuft aktuell.<br>
<strong>abgebrochen</strong>: Der Batch ist abgebrochen und sollte per <code>RESTART</code> neu gestartet werden.<br>
<strong>beendet</strong>: Der Batch ist erfolgreich beendet worden.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SatznummerLetztesCommit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Die Anzahl an Sätzen, welche beim letzten Commit verarbeitet worden sind.
Dies wird für die Umsetzung der Restart-Funktionalität verwendet.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SchluesselLetztesCommit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Der Datenbank-Schlüssel des Datensatzes, der als letztes vor dem Commit bearbeitet wurde.
Dies wird für die Umsetzung der Restart-Funktionalität verwendet.
Falls der Schlüssel ein zusammengesetzter Schlüssel ist, müssen sämtliche Schlüsselteile (durch Trennzeichen getrennt) in dieses Feld geschrieben werden.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DatumLetzterStart</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Das Datum des Starts des aktuellen Batch-Laufs (falls der Status „laeuft“ ist) bzw.
des letzten Laufes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DatumLetzterAbbruch</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Das Datum des letzten fehlerhaften Abbruchs des Batches.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DatumLetzterErfolg</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Das Datum des letzten erfolgreichen Abschlusses des Batches.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Die Tabelle liegt im Datenbank-Schema der eigenen Geschäftsanwendung.
Es darf keine übergreifenden Tabellen oder ein übergreifendes Datenbankschema für alle Batches gemäß IsyFact-Architektur geben.</p>
</div>
<div class="sect2">
<h3 id="verwaltung-der-tabelle"><a class="anchor" href="#verwaltung-der-tabelle"></a>5.1. Verwaltung der Tabelle</h3>
<div class="paragraph">
<p>Die Tabelle dient nicht der Steuerung des Batches über den Betrieb, sondern nur der Ablage von Informationen zwischen zwei Batch-Läufen.
Die Befüllung der Tabelle wird deshalb komplett über den Batchrahmen durchgeführt: Es müssen keine Datensätze manuell befüllt werden: Ist ein Datensatz für einen Batch noch nicht vorhanden, wird er angelegt.</p>
</div>
<div class="paragraph">
<p>Üblicherweise ist das Locking-Verhalten in Geschäftsanwendungen optimistisch: Datensätze werden nicht explizit gelockt.
Stattdessen wird über Versions-Attribute zum Commit-Zeitpunkt geprüft, ob der Datensatz innerhalb der Transaktion verändert wurde.
Für die Tabelle des Batchrahmens wird <em>nicht</em> optimistisch, sondern pessimistisch gelockt.
Zusätzlich wird als Hibernate Locking-Strategie <code>LOCK_NOWAIT</code> verwendet: Falls auf einen Datensatz zugegriffen wird, welcher gerade gelockt ist, wird nicht bis zur Freigabe gewartet, sondern eine Exception geworfen.
Die parallele Ausführung zweier Batches mit gleicher Batch-ID ist nicht erlaubt und soll zum Fehler führen.</p>
</div>
</div>
<div class="sect2">
<h3 id="die-transaktionssteuerung"><a class="anchor" href="#die-transaktionssteuerung"></a>5.2. Die Transaktionssteuerung</h3>
<div class="paragraph">
<p>In der Property-Datei des Batchrahmens wird die Commit-Rate für den Batch über eine Property konfiguriert.
Die Transaktionssteuerung für einen Batch arbeitet daraufhin folgendermaßen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Die Klasse <code>BatchLauncher</code> liest die Kommandozeile ein, interpretiert die Parameter und erzeugt alle notwendigen Spring-Kontexte.
Dies geschieht außerhalb einer Transaktion.
Danach gibt die Klasse die Kontrolle an die Batchrahmen-Bean weiter.</p>
</li>
<li>
<p>Die Batchrahmen-Bean startet eine erste Transaktion.
Sie aktualisiert die Batchrahmen-Tabellen und initialisiert die Ausführungsbean in dieser Transaktion.
Die Ausführungsbean führt im Rahmen dieser Transaktion das „Vorlesen“ bis zum letzten Checkpoint sowie ggf. nötige Initialisierungen durch.
Die Transaktion wird beendet.
Danach beginnt die Satz-Verarbeitung.</p>
</li>
<li>
<p>Für die Satz-Verarbeitung wird eine neue Transaktion gestartet.
Die einzelnen Datensätze werden verarbeitet.
Bei Erreichung eines Checkpoints wird die Status-Tabelle aktualisiert, die Transaktion abgeschlossen (Commit) und eine neue gestartet.</p>
</li>
<li>
<p>Sobald der letzte Datensatz verarbeitet wurde, wird in einer letzten Transaktion die Status-Tabelle aktualisiert, auf der Ausführungsbean eine Shutdown-Methode aufgerufen und die Transaktion abgeschlossen.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Das Verhalten in Fehlerfällen ist zu jedem Zeitpunkt während der Verarbeitung gleich: Der Fehler wird geloggt und die Transaktion zurückgerollt.
Danach wird versucht, eine neue Transaktion zu starten, um die Status-Tabelle zu aktualisieren: Der Status wird auf <code>abgebrochen</code> gesetzt und die Spalte <code>DatumLetzterAbbruch</code> auf den aktuellen Zeitpunkt.
Daraufhin wird versucht, diese Transaktion abzuschließen.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warnung"></i>
</td>
<td class="content">
Schlägt diese Transaktion fehl, kann der Batchrahmen den Abbruch nicht persistent speichern.
Der nächste Lauf muss dann mit dem Parameter <code>-ignoriereLauf</code> gestartet werden.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="die-restart-funktionalitaet"><a class="anchor" href="#die-restart-funktionalitaet"></a>5.3. Die Restart Funktionalität</h3>
<div class="paragraph">
<p>Falls ein Batch durch einen Fehler oder durch das Erreichen der Anzahl zu verarbeitender Datensätze abgebrochen ist, muss ein Restart für ihn durchgeführt werden.
In diesem Fall müssen alle bereits verarbeiteten Datensätze übersprungen werden.
Ebenso wird die Wiederanlauffähigkeit nach manuellem Terminieren durch das Signal <code>kill -15</code> sichergestellt.</p>
</div>
<div class="sect3">
<h4 id="die-konfiguration-im-restart-fall"><a class="anchor" href="#die-konfiguration-im-restart-fall"></a>5.3.1. Die Konfiguration im Restart-Fall</h4>
<div class="paragraph">
<p>Im Restart-Fall wird nicht überprüft, dass die übergebenen Parameter denen entsprechen, die im ursprünglichen Lauf übergeben wurden.
Es muss daher bei einem Restart manuell darauf geachtet werden, dass die gleichen Parameter übergeben werden.</p>
</div>
</div>
<div class="sect3">
<h4 id="beenden-eines-laufs-mit-kill--15-und-wiederanlauf"><a class="anchor" href="#beenden-eines-laufs-mit-kill--15-und-wiederanlauf"></a>5.3.2. Beenden eines Laufs mit <code>kill -15</code> und Wiederanlauf</h4>
<div class="paragraph">
<p>Durch Senden des Signals <code>kill -15</code> kann ein aktiver Batchlauf beendet werden.
Beim Empfang des Signals wird der aktuelle Datensatz zu Ende bearbeitet und der Batch terminiert im wohldefinierten Zustand.
In der Statustabelle ist dann der Status „abgebrochen“ vermerkt und der Batchlauf kann mit dem Parameter „-restart“ wieder aufgesetzt werden.</p>
</div>
</div>
<div class="sect3">
<h4 id="wiederanlauf-nach-abbruch-durch-die-ueberschreitung-der-maximalen-laufzeit"><a class="anchor" href="#wiederanlauf-nach-abbruch-durch-die-ueberschreitung-der-maximalen-laufzeit"></a>5.3.3. Wiederanlauf nach Abbruch durch die Überschreitung der maximalen Laufzeit</h4>
<div class="paragraph">
<p>Falls der Batch mit dem „laufzeit“-Parameter gestartet wurde, wird nach Überschreitung der angegebenen maximalen Laufzeit der aktuelle Datensatz zu Ende bearbeitet und der Batch terminiert im wohldefinierten Zustand.
In der Statustabelle ist dann der Status „abgebrochen“ vermerkt und der Batchlauf kann mit dem Parameter „-restart“ wieder aufgesetzt werden.</p>
</div>
</div>
<div class="sect3">
<h4 id="wiederanlauf-nach-abbruch-durch-kill--9"><a class="anchor" href="#wiederanlauf-nach-abbruch-durch-kill--9"></a>5.3.4. Wiederanlauf nach Abbruch durch <code>kill -9</code></h4>
<div class="paragraph">
<p>Durch Senden des Signals <code>kill -9</code> wird der aktive Batchprozess von Betriebssystemseite beendet.
Dabei wird der Java-Prozess direkt entfernt ohne die Möglichkeit, den Batchrahmen definiert zu terminieren.
Dies ist daher nur in Ausnahmesituationen vom Betrieb durchzuführen.
Da der Batchrahmen in dieser Situation kein Status-Update mehr schreiben kann, befindet sich der Eintrag „läuft“ in der Statustabelle.
Ein Wiederanlauf in dieser Situation ist mit dem Parameter „-restart“ möglich.</p>
</div>
</div>
<div class="sect3">
<h4 id="das-vorlesen-durch-die-ausfuehrungsbean"><a class="anchor" href="#das-vorlesen-durch-die-ausfuehrungsbean"></a>5.3.5. Das Vorlesen durch die Ausführungsbean</h4>
<div class="paragraph">
<p>Um den Batch nach einem Fehler zum nächsten zu bearbeiteten Datensatz „vorlesen“ zu lassen, muss dieser Datensatz identifiziert werden.
Dies geschieht zum einen durch den Batchrahmen selbst, welcher die Anzahl der bereits verarbeiteten Datensätze speichert.
Bei auf Datenbank-Queries basierenden Batches kann diese Anzahl jedoch ggf.
nicht verwendet werden, da sie sich im Laufe der Zeit ändert.
Hier ist es notwendig, die zu verarbeitenden Sätze nach ihrem Schlüssel zu sortieren und den als letztes bearbeiteten Schlüssel zu speichern.</p>
</div>
<div class="paragraph">
<p>Die Batchrahmen Status-Tabelle enthält deshalb zwei Felder: Ein Feld für die Anzahl verarbeiteter Sätze und ein Feld für den Schlüssel des letzten verarbeiteten Datensatzes.
Dieser Schlüssel wird von der Ausführungsbean nach der Verarbeitung eines Satzes zurückgegeben.</p>
</div>
<div class="paragraph">
<p>Bei einem Restart wird der Ausführungsbean in der Initialisierungsmethode übermittelt, ob es sich um einen Restart handelt und welche Werte für den Schlüssel und die Satznummer in der Datenbank stehen.
Der Bean ist es überlassen, das Vorlesen effizient durchzuführen (etwa durch die Aufnahme des Schlüssels in das Selektionskriterium einer Query).</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="die-ueberwachungs-funktionalitaet"><a class="anchor" href="#die-ueberwachungs-funktionalitaet"></a>5.4. Die Überwachungs-Funktionalität</h3>
<div class="paragraph">
<p>Die Verarbeitung eines Batches soll überwacht und nachverfolgt werden können.
Für die Nachverfolgung können durch die Verarbeitungsbean zu verschiedenen Zeitpunkten Log-, Statistik- oder Protokoll-Einträge erstellt werden:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Zu Beginn des Batches, während der Initialisierung der Ausführungsbean.</p>
</li>
<li>
<p>Nach dem Schreiben jedes Checkpoints.</p>
</li>
<li>
<p>Bei der erfolgreichen Beendigung des Batches.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Jeder Log-Eintrag eines Batches, insbesondere die Aufrufe der Fachkomponenten, enthält pro Satz eine eindeutige Korrelations-ID. Damit können Log-Einträge nicht nur einem Batchlauf, sondern den einzelnen Sätzen eindeutig zugeordnet werden.</p>
</div>
<div class="paragraph">
<p>Für die Überwachung wird durch den Batchrahmen eine JMX-Bean bereitgestellt. Über folgende Konfiguration wird ein JMX Agent erzeugt, welcher die Bean nach außen zugreifbar macht:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">  -Dcom.sun.management.jmxremote
  -Dcom.sun.management.jmxremote.port=&lt;PortNummer&gt;
  -Dcom.sun.management.jmxremote.ssl=false
  -Dcom.sun.management.jmxremote.authenticate=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Über die Java Management Console kann man danach auf die Daten zugreifen:</p>
</div>
<div id="image-JMXOverBat" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-batch/JMXOverBat.png" alt="JMXOverBat">
</div>
<div class="title">Abbildung 6. Die JMX Überwachung eines Batches</div>
</div>
<div class="paragraph">
<p>Bereitgestellt werden folgende Informationen:</p>
</div>
<table id="table-JMXAttr" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 8. JMX-Attribute</caption>
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SaetzeGesamt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Die Gesamtanzahl der zu bearbeitenden Sätze. Falls diese nicht bekannt ist: -1</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SaetzeVerarbeitet</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Die Anzahl bereits verarbeiteter Sätze.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SchluesselLetzterSatz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Schlüssel des letzten verarbeiteten Satzes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ZeitSeitLetztemSatz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zeitraum in Millisekunden, der bereits für den aktuellen Satz benötigt wurde.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Die ID des aktuellen Batches</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name des aktuellen Batches.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Zur Erhöhung der Sicherheit in der Betriebsumgebung muss eine Absicherung der RMI-Schnittstelle für JMX per Benutzername und Passwort erfolgen (siehe JVM-Parameter oben). Hierzu sind die JMX-Benutzer und Passwörter entweder direkt in der Datei</p>
</div>
<table class="tableblock frame-none grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>JRE_HOME/lib/management/jmxremote.password</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>zu konfigurieren, oder der Ort dieser Datei ist über den JVM-Parameter</p>
</div>
<table class="tableblock frame-none grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock"><code>com.sun.management.jmxremote.password.file</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>anzugeben.
Die Datei benötigt einen Eintrag für die Rolle controlRole oder für eine beliebige Rolle, für welche in
Datei <code>JRE_HOME/lib/management/jmxremote.access</code> readwrite-Zugriff erlaubt ist.</p>
</div>
</div>
<div class="sect2">
<h3 id="authentifizierung-und-autorisierung"><a class="anchor" href="#authentifizierung-und-autorisierung"></a>5.5. Authentifizierung und Autorisierung</h3>
<div class="paragraph">
<p>Ein Batch wird innerhalb der Plattform gestartet.
Dazu verwendet der Batch die Benutzerkennung eines technischen Benutzers „internes System“, die in seiner Startkonfiguration (als Konfigurationsdatei) hinterlegt und im Benutzerverzeichnis vorhanden ist.</p>
</div>
<div class="paragraph">
<p>Der Batchrahmen nutzt die T-Komponente Sicherheit (siehe <a href="../../isy-sicherheit/nutzungsvorgaben/master.html#einleitung" class="xref page">Nutzungsvorgaben Sicherheit</a>), um den anfragenden Benutzer über den IAM-Service der Plattform zu authentifizieren.
Das IAM-Service authentifiziert den Benutzer anhand der angegebenen Benutzerkennung und des Passwortes, registriert alle Informationen zum Benutzer in der T-Komponente AufrufKontextVerwalter und schließt die Session des Benutzers im IAM-System.</p>
</div>
<div class="paragraph">
<p>Im Zuge des Batchlaufs können nun über die T-Komponente Sicherheit Berechtigungsprüfungen (z.B. im Anwendungskern) stattfinden.</p>
</div>
<div class="paragraph">
<p>Der Batchrahmen fordert vom BatchAusführungsBean die Implementierung der Methode: getAuthenticationCredentials(), in der dem Batchrahmen bekannt gegeben wird, mit welchem Benutzer der Batch laufen soll.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-Java hljs" data-lang="Java">@Override
public BatchAuthenticationCredentials getAuthenticationCredentials(
                  BatchKonfiguration konfiguration);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Folgende Informationen zum Benutzer sind anzugeben</p>
</div>
<table id="table-CharBatUse" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 9. Die Eigenschaften des Batchbenutzers</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Property</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bhknz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Das Behörden- oder Organisationskennzeichen, der Behörde oder Organisation, der der Benutzer angehört.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Benutzer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Die Kennung des technischen Benutzers (internes System)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Passwort</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Das Kennwort des Benutzers</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In der Regel wird der Benutzer aus der betrieblichen Konfiguration der Anwendung oder alternativ aus den Aufrufparametern beim Batchstart gelesen.</p>
</div>
<div class="paragraph">
<p>In Ausnahmefällen ist es auch möglich, einen Batch zu implementieren, der ohne Benutzer laufen soll.
Dies ist nur möglich, wenn bei Aufrufen des Anwendungskerns keine Autorisierungsprüfungen stattfinden und auch keine Nachbarsystemschnittstellen aufgerufen werden.
Soll der Batch ohne Benutzer laufen, so ist in der Methode <code>null</code> zurückzugeben.</p>
</div>
<div class="paragraph">
<p>Enthält eine Anwendung mehrere Batches, so enthält sie auch mehrere BatchAusführungsBeans und kann jeden Batch mit einem
eigenen Benutzer ausstatten.</p>
</div>
</div>
<div class="sect2">
<h3 id="das-deployment-eines-batches"><a class="anchor" href="#das-deployment-eines-batches"></a>5.6. Das Deployment eines Batches</h3>
<div class="paragraph">
<p>Die Batches werden nicht einzeln deployed.
Stattdessen wird ein Paket angeboten, welches sämtliche Batches der Geschäftsanwendung enthält.</p>
</div>
<div class="paragraph">
<p>Das erstellte Paket enthält den Code des Batchrahmens sowie den Code der eigentlichen Geschäftsanwendung inklusive der Batch-Ausführungsklassen und der benötigten nicht-betrieblichen Batch-Konfigurationsdateien.
Für jeden Batch wird ein Shellskript zum Start bereitgestellt.</p>
</div>
<div class="paragraph">
<p>Für die Shellskripte existieren keine Vorgaben.
Falls vor der Ausführung des Batches Vorbedingungen gelten müssen (etwa Dateien in Verzeichnissen vorliegen sollen), so können sie in diesen Skripten geprüft werden.
Beispiele für Aufruf-Skripte von Batches befinden sich in der Bibliothek <code>isy-batchrahmen</code>, im Verzeichnis <code>src/main/skripte/bin</code></p>
</div>
<div class="paragraph">
<p>Eine sinnvolle Aufteilung bei den Shellskripten ist es, ein technisches Startskript zu erstellen, was von den eigentlichen Batch-Shellskripten zum Aufruf genutzt wird.
Beispiel für ein solches Startskript befinden sich in der Bibliothek <code>isy-batchrahmen</code>, in der Datei <code>src/main/skripte/bin/batch-ausfuehren.sh</code></p>
</div>
<div class="paragraph">
<p>Dieses Startskript soll in der Batch-Anwendung unter <code>&lt;batch-projekt&gt;/src/main/resources/bin</code> übernommen und mit der richtigen Java-Version versehen werden.</p>
</div>
<div class="paragraph">
<p>Ein beispielhaftes Shellskript zum Aufruf eines Batches kann dieses Skript dann nutzen und folgendermaßen aussehen:</p>
</div>
<div id="listing-BSPStartBAT" class="listingblock">
<div class="title">Listing 2. Beispielhaftes Startskript für einen Batch</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash
#
# Parameter für den Erinnerung-Batch
#
# -Testmodus &lt;true|false&gt; Flag ob nur simuliert wird oder nicht (optionaler Parameter)
#

BATCHDIR=`dirname $0`
$BATCHDIR/batch-ausfuehren.sh -start -cfg /resources/batch/batch-erinnerung-config.properties -Batchrahmen.Ergebnisdatei /tmp/erinnerung_out.xml $1 $2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bei der betrieblichen Konfiguration wird nicht zwischen dem Deployment als Web-Anwendung und dem Deployment als Batch unterschieden: Es werden jeweils dieselben betrieblichen Konfigurationsdateien verwendet.
Damit der Betrieb Anpassungen dieser Dateien nicht zweimal durchführen muss, wird die betriebliche Konfiguration mit der Web-Anwendung deployed.
Vor dem Deployment des Batch-Pakets muss die Webanwendung deployed sein.
Falls der Batch nicht auf dem Server der Webanwendung läuft, muss die Konfigurationsdatei der Webanwendung vor der Installation des Batches auch auf diesem Server verfügbar gemacht (z.B. gemountet oder kopiert) werden.
Beim Deployment des Batch-Pakets werden über symbolische Links diese betriebliche Konfigurationsdatei referenziert.</p>
</div>
</div>
<div class="sect2">
<h3 id="rueckgabewerte-des-batchrahmens"><a class="anchor" href="#rueckgabewerte-des-batchrahmens"></a>5.7. Rückgabewerte des Batchrahmens</h3>
<div class="paragraph">
<p>Der Batchrahmen endet mit einem Returncode und erzeugt optional zusätzlich noch ein ausführliches Verarbeitungsergebnis in Form einer Ergebnisdatei im XML-Format.
Die Ergebnisdatei ist eine <strong>fachliche Datei</strong>, sie enthält keine betrieblichen Informationen.
Alle betrieblichen Informationen über Ausführung des Batches werden in die Logdatei geschrieben, so dass der Betrieb nur diese Datei betrachten muss.
Es gibt keine weiteren betriebsrelevanten Dateien neben der Logdatei.</p>
</div>
<div class="paragraph">
<p>Der Pfad der Ergebnisdatei wird über einen Konfigurationsparameter des Batches festgelegt (siehe
Kapitel <a href="#konfigurationsdatei-und-kommandozeilen-parameter">Konfigurationsdatei und Kommandozeilen-Parameter</a>). Ist dieser Parameter nicht vorhanden, so wird auch keine Ergebnisdatei geschrieben.
Die Ergebnisdatei hat den folgenden Aufbau:</p>
</div>
<table id="table-FormAusDat" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 10. Format der Ergebnisdatei</caption>
<colgroup>
<col style="width: 30.7692%;">
<col style="width: 15.3846%;">
<col style="width: 7.6923%;">
<col style="width: 46.1539%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">XML-Pfad</th>
<th class="tableblock halign-left valign-top">Attribut</th>
<th class="tableblock halign-left valign-top">Typ</th>
<th class="tableblock halign-left valign-top">Bedeutung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Root-Tag des Batch-Ergebnisses</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Start</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Datum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datum des Starts des Batchlaufs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Start</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Uhrzeit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uhrzeit des Starts des Batchlaufs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Start</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatchID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Die Batch-ID des Batchlaufs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Start</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Parameter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Die Parameter des Batchlaufs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Meldungen</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Liste von Meldungen (Fehler, Warnungen oder Informationen)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Meldungen / Meldung</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID des Eintrags (z.B. Fehlernummer)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Meldungen / Meldung</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Typ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Typ des Eintrags: F, W, I</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Meldungen / Meldung</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Text</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text des Eintrags, z.B. Fehlertext</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Meldungen / Meldung</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Satz</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Der fachliche Schlüssel des Hauptsatzes, dessen Verarbeitung diese Meldung verursacht hat.
Es ist zu beachten, dass ein technischer Schlüssel an dieser Stelle nicht ausreichend ist, da der Fachbereich und der Betrieb
mit diesem technischen Schlüssel nichts anfangen können.</p>
</div>
<div class="paragraph">
<p>Falls es nicht möglich ist den fachlichen Schlüssel des Hauptsatzes an dieser Stelle zu ermitteln bzw.
wenn dies nur auf Kosten der Laufzeit möglich ist, dann ist mit dem Fachbereich und dem Betrieb frühzeitig zu klären,
ob an dieser Stelle ein anderer Schlüssel ausgegeben werden kann.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Statistik</code></p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Liste von statistischen Daten die während des Batchlaufs ermittelt wurden.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Statistik / Statistik-Eintrag</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID des Statistik-Eintrags</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Statistik / Statistik-Eintrag</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Text</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Klartext des Eintrags, z. B. „Anzahl gelöschter Datensätze“</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Statistik / Statistik-Eintrag</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Wert</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Statistischer Wert, z. B. Anzahl der gelöschten Datensätze</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Ende</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Datum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Datum des Ende des Batchlaufs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Ende</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Uhrzeit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Uhrzeit des Ende des Batchlaufs</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Return-Code</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RC</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Return-Code der Batch-Verarbeitung</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Batch-Ergebnis / Return-Code</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Text</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Text</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Den Return-Code zugeordneter Text</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Beispiel für ein Batchprotokoll:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;Batch-Ergebnis&gt;
&lt;Start BatchID="terminfindungLoeschBatch" Datum="2017-01-30" Uhrzeit="09:33:53" Parameter="-start -cfg /resources/batch/batch-loeschen-config.properties -Batchrahmen.Ergebnisdatei loeschen-batch_out.xml"/&gt;
&lt;Meldungen&gt;
&lt;Meldung ID="COMMIT" Typ="I" Text="Checkpunkt geschrieben."/&gt;
&lt;Meldung ID="ENDE" Typ="I" Text="Batch beendet."/&gt;
&lt;/Meldungen&gt;
&lt;Statistik&gt;
&lt;Statistik-Eintrag ID="ANZAHL_GELOESCHT" Text="Anzahl gelöschter Terminfindungen" Wert="5"/&gt;
&lt;/Statistik&gt;
&lt;Ende Datum="2017-01-30" Uhrzeit="09:33:58"/&gt;
&lt;Return-Code RC="0" Text="Verarbeitung ohne Fehler durchgeführt."/&gt;
&lt;/Batch-Ergebnis&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Zur Auswertung der Ergebnisdatei können XSLT-Stylesheets verwendet werden, die die Ergebnisdatei in eine Textdatei bzw.
in HTML umwandeln.
Es handelt sich hierbei um eine fachliche Transformation der Daten mit dem Ziel, diese für den Fachbereich zu filtern,
zu aggregieren oder in einem bestimmten Format zu Weiterverarbeitung bereitzustellen.</p>
</div>
<div class="paragraph">
<p>Wenn die Verarbeitung erfolgreich beendet wurde, endet der Batchrahmen mit dem Return-Code 0. Er endet mit einem anderen
Return-Code, falls der Batch mit einem Fehler beendet wurde oder gar nicht gestartet werden konnte.
Bei Fehlern in den „Ausführungsbeans“ kann der zurückzugebende Return-Code über die aufgetretenen Exceptions bestimmt
werden (siehe Kapitel <a href="#informationen-zum-batch-benutzer-bereitstellen">Informationen zum Batch-Benutzer bereitstellen</a>).</p>
</div>
<div class="paragraph">
<p>Pro Batch müssen die möglichen Rückgabewerte definiert werden.
Die folgenden Werte sind reserviert und müssen von jedem Batch zurückgegeben werden, wenn das entsprechende
Ereignis eingetreten ist:</p>
</div>
<table id="table-GenRetCodeBatCanv" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 11. Allgemeine Return-Codes des Batchrahmens</caption>
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 83.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-right valign-top">Return-Code</th>
<th class="tableblock halign-left valign-top">Bedeutung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">0</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Verarbeitung ohne Fehler durchgeführt</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Verarbeitung mit Fehlern durchgeführt</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Verarbeitung mit Fehlern abgebrochen</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch konnte wegen Fehlern in den Aufrufparametern nicht gestartet werden</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch konnte wegen Fehlern in der Batch-Konfiguration nicht gestartet werden</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">143</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch wurde vom Benutzer abgebrochen.</p></td>
</tr>
<tr>
<td class="tableblock halign-right valign-top"><p class="tableblock">144</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Batch wurde durch die Überschreitung der konfigurierten maximalen Laufzeit abgebrochen.</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="testmodus"><a class="anchor" href="#testmodus"></a>5.8. Testmodus</h3>
<div class="paragraph">
<p>Der Batch im Testmodus arbeitet analog zum normalen Wirkbetrieb, jedoch werden keine Änderungen an Datenbeständen vom Anwendungssystem oder Nachbarsystemen durchgeführt.
Der Testmodus ist für den Betrieb wichtig, um Abschätzungen der Laufzeit durchführen zu können und somit den Batchbetrieb planen können.
Weiter ist der Testlauf für Bereinigungsläufe wichtig, da so der Fachbereich sehen kann, welche Änderungen durch den Bereinigungslauf ausgeführt werden würden.</p>
</div>
<div class="paragraph">
<p>In diesem Kapitel werden Architekturmuster zur Umsetzung des Testmodus beschrieben:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Der Batch arbeitet wie im Wirkbetrieb und statt der Commits findet immer ein Datenbank-Rollback statt (siehe
Kapitel <a href="#testmodus-mit-rollback">Testmodus mit Rollback</a>).</p>
</li>
<li>
<p>Die Batch-Logik wird ausgeführt, jedoch finden keine Schreiboperationen in der Datenbank oder Aufrufe von
Nachbarsystemen statt, welche Änderungen in deren Datenbestand zur Folge hätten (siehe
Kapitel <a href="#testmodus-ohne-schreiboperationen">Testmodus ohne Schreiboperationen</a>).</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="testmodus-mit-rollback"><a class="anchor" href="#testmodus-mit-rollback"></a>5.8.1. Testmodus mit Rollback</h4>
<div class="paragraph">
<p>Dieses Muster sieht vor, dass bei der Batchverarbeitung statt eines Commits ein Rollback ausgeführt wird, so dass die Änderungen, die durch den Batch erzeugt werden, nicht in die Datenbank geschrieben werden.
Das Muster ist für datenbankorientierte Batches gut geeignet, die keine Änderungen an Nachbarsystemen erfordern.</p>
</div>
<div class="paragraph">
<p>Einige Batches vermerken ihren Arbeitsfortschritt in der Datenbank.
Damit der Batch trotz Rollback nicht in eine Endlosschleife gerät, darf diese Änderung nicht zurückgerollt werden.
Dies kann wie folgt umgesetzt werden:</p>
</div>
<div class="paragraph">
<p>Der Batch schreibt zu Beginn die IDs aller zu verarbeitenden Sätze in eine gesonderte „Task“-Tabelle.
In jedem Schritt ermittelt der Batch einen Satz aus der Task-Tabelle, löscht diesen und verarbeitet den zugehörigen Datensatz.
Im Testmodus wird das Löschen des Tasks in einer separaten Transaktion durchgeführt und so nicht zurückgerollt.</p>
</div>
<div class="paragraph">
<p>Folgendes Code-Beispiel demonstriert dieses Muster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public VerarbeitungsErgebnis verarbeiteSatz() throws BatchAusfuehrungsException {
  MeinBatchTask task = meinBatchTaskDao.leseEintrag();
  meinBatchTaskDao.loesche(task);

  // Wenn Testmodus, neue Transaktion starten
  TransactionStatus txStatus = null;
  if (testmodus) {
      txStatus = transactionManager.getTransaction(new DefaultTransactionDefinition(TransactionDefinition.PROPAGATION_REQUIRES_NEW));
      txStatus.setRollbackOnly();
  }

  fristenkontrolle.pruefeFrist(task.getSatznummer());

  // Wenn Testmodus, Transaktion zurücksetzen
  if (testmodus) {
      transactionManager.rollback(txStatus);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Die Umsetzung des Testmodus mit einem Datenbank-Rollback eignet sich vor allem zur Überprüfung der fehlerfreien Durchführung
und bei der Bestimmung der Laufzeit eines Batches.
Zusätzlich ist bei einer entsprechenden Protokollierung nachvollziehbar, welche Datensätze der Batch verarbeitet hat.</p>
</div>
</div>
<div class="sect3">
<h4 id="testmodus-ohne-schreiboperationen"><a class="anchor" href="#testmodus-ohne-schreiboperationen"></a>5.8.2. Testmodus ohne Schreiboperationen</h4>
<div class="paragraph">
<p>Ein weiteres Konzept für die Umsetzung des Testmodus sieht vor, dass ändernde Operationen in der Datenbank unterbunden werden. Änderungen in der Datenbank oder in Nachbarsystemen werden durch entsprechende If-Abfragen abgefangen.</p>
</div>
<div class="paragraph">
<p>Dieses Muster ist dann einzusetzen, wenn die Realisierung durch einen Rollback nicht möglich oder angemessen ist.
Durch Tests muss sichergestellt werden, dass nicht trotz Testmodus versehentlich Änderungen durchgeführt werden.</p>
</div>
<div class="paragraph">
<p>Das Muster ist geeignet, um im Testmodus durch die Auswertung der Batch-Protokolle und Logs die Auswirkungen bzw.
durchgeführten Änderungen eines Batches vorab zu überprüfen.
Es ist nicht geeignet zur Bestimmung der Laufzeit oder für die vollständige Sicherstellung der fehlerfreien Batchausführung, da Fehler bei Schreiboperationen in die Datenbank oder dem Aufruf von Nachbarsystemen nicht auftreten können.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="die-ausfuehrungsbeans"><a class="anchor" href="#die-ausfuehrungsbeans"></a>6. Die Ausführungsbeans</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Im vorangegangenen Kapitel wurden die Eigenschaften des Batchrahmens erläutert.
Dieser existiert bereits und muss verwendet werden, indem Ausführungsbeans dafür entwickelt werden.
In diesem Kapitel werden Vorgaben für die Ausführungsbeans definiert.</p>
</div>
<div class="sect2">
<h3 id="_namenskonvention_3"><a class="anchor" href="#_namenskonvention_3"></a>6.1. Namenskonvention</h3>
<div class="paragraph">
<p>Ausführungsbeans folgend folegender Namenskonvention:</p>
</div>
<div class="paragraph">
<p>Analog zu den Anwendungsfällen werden Batchklassen mit dem Präfix <code>Bat</code> gekennzeichnet.</p>
</div>
<table id="table-batclass2" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 12. Batches: Klassen</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Batches: Klassen</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Bat&lt;Batchname&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BatLoeschfristPruefen<br>
BatSendenAllerInformationen</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="keine-transaktionssteuerung-in-einer-ausfuehrungsbean"><a class="anchor" href="#keine-transaktionssteuerung-in-einer-ausfuehrungsbean"></a>6.2. Keine Transaktionssteuerung in einer Ausführungsbean</h3>
<div class="paragraph">
<p>Eine Ausführungsbean darf keine Transaktionen starten oder beenden.
Sämtliche vom Batchrahmen aufgerufenen Operationen (Operationen von Interface <code>BatchAusfuehrungsBean</code>) werden innerhalb einer Transaktion aufgerufen.
Die Ausführungsbean muss sich hiermit nicht befassen.</p>
</div>
</div>
<div class="sect2">
<h3 id="logging-protokollierung-und-statistik-aufrufe-implementieren"><a class="anchor" href="#logging-protokollierung-und-statistik-aufrufe-implementieren"></a>6.3. Logging, Protokollierung und Statistik-Aufrufe implementieren</h3>
<div class="paragraph">
<p>Der Batchrahmen führt Logging nur im Fehlerfall durch.
Die restlichen Informationen müssen durch die Ausführungsbean geloggt, protokolliert oder einer Statistik-Komponente übergeben.</p>
</div>
<div class="paragraph">
<p>Dazu wird die Ausführungsbean bei allen wichtigen Ereignissen aufgerufen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Beim Start des Batches</p>
</li>
<li>
<p>Beim Schreiben eines Checkpoints</p>
</li>
<li>
<p>Beim Beenden des Batches</p>
</li>
<li>
<p>Bei der Verarbeitung eines Satzes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Jeder Batch erhält eine eigene Korrelations-ID.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warnung"></i>
</td>
<td class="content">
In älteren Versionen des Batchrahmens handelte es sich bei der Korrelations-ID für Batches um die ID des Batches.
Mittlerweile wurde dies durch eine UUID ersetzt.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Zusätzlich erhält jeder zu verarbeitende Satz auch eine eigene Korrelations-ID, welche an die Korrelations-ID des Batches angehängt wird. Die entstehende Korrelations-ID Kette wird dann dem Aufruf-Kontext hinzugefügt.</p>
</div>
</div>
<div class="sect2">
<h3 id="fachliche-logik-in-den-komponenten-der-geschaeftsanwendung-implementieren"><a class="anchor" href="#fachliche-logik-in-den-komponenten-der-geschaeftsanwendung-implementieren"></a>6.4. Fachliche Logik in den Komponenten der Geschäftsanwendung implementieren</h3>
<div class="paragraph">
<p>Falls für die Verarbeitung im Batch Fachlogik benötigt wird, welche für die Webanwendung nicht benötigt wird, ist diese trotzdem den Geschäftsnwendungskomponenten hinzuzufügen.
Die Ausführungsbean erhält die Referenzen auf die Komponenten über Dependency Injection und ruft die Fachlogik dort auf.</p>
</div>
<div class="paragraph">
<p>Auch wenn in Sonderfällen Datenbank-Aufrufe direkt durch die Ausführungsbean ausgeführt werden müssen, ist die sonstige fachliche Logik an die Fachkomponenten der Geschäftsanwendung zu delegieren.</p>
</div>
</div>
<div class="sect2">
<h3 id="plausibilitaetspruefung-in-der-initialisierung"><a class="anchor" href="#plausibilitaetspruefung-in-der-initialisierung"></a>6.5. Plausibilitätsprüfung in der Initialisierung</h3>
<div class="paragraph">
<p>Im Rahmen der Initialisierung hat die Ausführungsbean unter anderem die Aufgabe, die Konsistenz und Korrektheit der Eingabedaten zu prüfen.
Dies kann beispielsweise ein erstes Durchlaufen der zu verarbeitenden Datei beinhalten.
Werden hierbei Fehler erkannt, muss ein entsprechender Fehler geworfen werden.</p>
</div>
</div>
<div class="sect2">
<h3 id="in-initialisierung-schluessel-lesen-satz-verarbeitung-ueber-lookups"><a class="anchor" href="#in-initialisierung-schluessel-lesen-satz-verarbeitung-ueber-lookups"></a>6.6. In Initialisierung Schlüssel lesen, Satz-Verarbeitung über Lookups</h3>
<div class="paragraph">
<p>Falls die zu verarbeitenden Sätze eines Batches das Ergebnis einer Datenbank-Query sind, ist folgendermaßen vorzugehen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In Rahmen der Initialisierung ist die Query über eine Fachkomponente abzusetzen.
Diese Query soll die (fachlichen) Schlüssel von Entitäten, nicht die Entitäten selbst auslesen.</p>
</li>
<li>
<p>Die zurückgegebenen Schlüssel sind in einer Liste zu speichern und die Query ist zu schließen.</p>
</li>
<li>
<p>Beim Aufruf für eine Satzverarbeitung ist die Entität über ihren Schlüssel aus der Datenbank auszulesen und die Verarbeitung durchzuführen.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dies bietet gegenüber dem Auslesen von Entitäten in der Query folgende Vorteile:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Würden Entitäten ausgelesen, wären diese nach einem Commit während der Verarbeitung nicht mehr mit einer Transaktion
verbunden.<br>
Hibernate liest Entitäten bereits bei der <code>hasNext()</code>-Abfrage eines Resultset-Iterators ab.
So kommt es bei Checkpoints zwangsläufig zu toten Entitäten.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Hinweis"></i>
</td>
<td class="content">
Falls (in einem ungewöhnlichen Sonderfall) mit <code>ResultSet</code>-Iteratoren gearbeitet werden muss, so sollte mit einem Hibernate
<code>ScrollableResult</code> gearbeitet werden. Siehe Hibernate-Referenzdokumentation.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Durch das Ablegen der Schlüssel in einer Liste ist die Gesamtanzahl der Datensätze bekannt.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="informationen-zum-batch-benutzer-bereitstellen"><a class="anchor" href="#informationen-zum-batch-benutzer-bereitstellen"></a>6.7. Informationen zum Batch-Benutzer bereitstellen</h3>
<div class="paragraph">
<p>Batches müssen beim Start einen Benutzer authentifizieren und autorisieren, bevor der fachliche Teil der Batchverarbeitung starten kann.
Der Batchrahmen fordert von der Ausführungsbean die Bereitstellung der Informationen zum Benutzer, um diesen über die T-Komponente Sicherheit zu authentifizieren.
Dazu ist für das Ausführungsbean die Methode <code>getAuthenticationCredentials()</code> umzusetzen.</p>
</div>
</div>
<div class="sect2">
<h3 id="fehlerbehandlung-in-ausfuehrungsbeans-durchfuehren"><a class="anchor" href="#fehlerbehandlung-in-ausfuehrungsbeans-durchfuehren"></a>6.8. Fehlerbehandlung in Ausführungsbeans durchführen</h3>
<div class="paragraph">
<p>Die Batches sind möglichst robust zu konstruieren: Falls auf ein fachliches Problem in der Ausführungsbean reagiert werden kann, sollte dies getan werden.</p>
</div>
<div class="paragraph">
<p>Der Batchrahmen unterstützt beispielsweise <em>nicht</em> das Auslassen von Datensätzen im Fehlerfall (etwa für eine Verarbeitung im nächsten Batch). Falls dies umgesetzt werden soll, ist eine entsprechende Verarbeitung in der Ausführungsbean zu implementieren.</p>
</div>
<div class="paragraph">
<p>Wenn eine Ausführungsbean einen Fehler wirft, so muss dies eine „BeanAusfuehrungsException“ oder ein davon erbender Fehler sein.
In diesen Exceptions ist es möglich, den Return-Code des Batches zu definieren.
Die Return-Codes sind für den konkreten Batch zu konfigurieren und müssen den Vorgaben in
Abschnitt <a href="#rueckgabewerte-des-batchrahmens">Rückgabewerte des Batchrahmens</a> entsprechen.</p>
</div>
<div class="paragraph">
<p>Wichtig ist, dass ein Batch bei einem Fehler, den der Batch nicht behandeln kann, abbricht und nicht endlos weiter läuft.
Dieses Vorgehen ermöglicht es dem Betrieb, die Ursache des Fehlers zu korrigieren und den Batch neu zu starten.</p>
</div>
</div>
<div class="sect2">
<h3 id="beispiele-satzverarbeitung"><a class="anchor" href="#beispiele-satzverarbeitung"></a>6.9. Beispiele Satzverarbeitung</h3>
<div class="paragraph">
<p>Abschließend ist in die beispielhafte Satzverarbeitung in einer Batch-Ausführungsbean zu sehen Die gezeigte Satzverarbeitung setzt den Testmodus um, die Anwendungslogik ist weiterhin im Anwendungskern umgesetzt und sie übernimmt Logging, Protokollierung und Statistik-Zählung.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
public VerarbeitungsErgebnis verarbeiteSatz() throws BatchAusfuehrungsException {
  // Hole nächsten Task, wenn vorhanden.
  if (CollectionUtils._isEmpty_(vorgangsIds)) {
  return new VerarbeitungsErgebnis(null, true);
  }
  int vorgangsId = vorgangsIds.remove(vorgangsIds.size() - 1);

  // Wenn Testmodus, neue Transaktion starten
  TransactionStatus txStatus = pruefeStartSimulation();

  // Laden des Vorgangs und Aufruf der AWK Komponente
  // zum Versenden der Mitteilung
  VorgangRo vorgang =
  vorgangsverwaltung.leseVorgang(vorgangsId);
  Antragsnummer antragsnummer = vorgang.getAntragsnummer();
  log.debug("Versende Erinnerung zur Anfrage für Antragsnummer: " + antragsnummer + ".");

  // Versende Erinnerung
  try {
    xxxBeteiligung.versendeErinnerungsnachricht(antragsnummer, vorgangsId);
    getBatchProtokoll().ergaenzeMeldung(
    new VerarbeitungsMeldung(String._valueOf_(vorgangsId), antragsnummer.toString(), MeldungTyp._INFO_, "Antragsnummer: " + antragsnummer));
    statistikErinnerungVersendet.erhoeheWert();
  } catch (AkteGesperrtException e) {
  getBatchProtokoll().ergaenzeMeldung(
  new VerarbeitungsMeldung(String._valueOf_(vorgangsId), antragsnummer.toString(),
  MeldungTyp._WARNUNG_, e.getFehlertext()));
  }

  // Wenn Testmodus, Transaktion zurücksetzen
  pruefeEndeSimulation(txStatus);
  return new VerarbeitungsErgebnis(String._valueOf_(vorgangsId), false);
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="sonderfall-blockloeschung"><a class="anchor" href="#sonderfall-blockloeschung"></a>6.9.1. Sonderfall Blocklöschung</h4>
<div class="paragraph">
<p>Es ist nicht zwingend erforderlich, dass in einem Satz nur eine einzelne Aktion (bspw.
Löschung) durchgeführt wird. Bei großen Datenmengen kann es durchaus Sinn sinnvoll sein, pro Satz eine bestimmte Anzahl Datensätze auf einmal zu verarbeiten, wie im folgenden Codebeispiel zu sehen ist.
Die Variable <code>blockgroesse</code> ist dabei konfigurativ zu setzen.</p>
</div>
<div class="paragraph">
<p>Wichtig ist in so einem Sonderfall, dass das Commit-Intervall des Batches entsprechend niedrig eingestellt ist
(siehe Kapitel <a href="#konfigurationsdatei-und-kommandozeilen-parameter">Konfigurationsdatei und Kommandozeilen-Parameter</a>), da ansonsten
(<em>Blockgröße</em> * <em>Commit-Intervall</em>) viele Datensätze mit einer Transaktion verarbeitet werden.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Override
public VerarbeitungsErgebnis verarbeiteSatz() throws BatchAusfuehrungsException {
  log.debug("Lösche Nachrichten älter als " + fristdatum + " (Blockgröße " + blockgroesse + ").");

  // Wenn Testmodus, neue Transaktion starten
  TransactionStatus txStatus = pruefeStartSimulation();
  int anzahlGeloeschterEintraege = nachrichtenverwaltung.loescheNachrichtenOhneAkte(fristdatum, blockgroesse);
  log.debug(anzahlGeloeschterEintraege + " Nachrichten gelöscht.");
  geloeschteNachrichtenStatistik.setWert(geloeschteNachrichtenStatistik.getWert() + anzahlGeloeschterEintraege);

  // Wenn Testmodus, Transaktion zurücksetzen
  pruefeEndeSimulation(txStatus);
  return new VerarbeitungsErgebnis(null, anzahlGeloeschterEintraege &lt; blockgroesse);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="sonderfall-eigenstaendige-transaktionssteuerung"><a class="anchor" href="#sonderfall-eigenstaendige-transaktionssteuerung"></a>6.9.2. Sonderfall eigenständige Transaktionssteuerung</h4>
<div class="paragraph">
<p>Unter bestimmten Umständen kann es notwendig sein, die Transaktionssteuerung des Batchrahmens zu umgehen.
Dies ist beispielsweise der Fall, wenn ein im Datenzugriff auftretender Fehler aus der Datenbank ignoriert werden soll.
Das Auftreten einer solchen Exception führt dazu, dass die Transaktion nur noch zurückgerollt werden kann, selbst wenn die Exception gefangen und ignoriert wird.</p>
</div>
<div class="paragraph">
<p>Um dieser Problematik zu begegnen, kann in der Satzverarbeitung selbst die Transaktionsklammer nur für einen Satz geöffnet und nach der Verarbeitung entweder commited oder zurückgerollt werden.</p>
</div>
<div class="paragraph">
<p>In diesem Fall sollte der Commit-Intervall des Batchrahmens entsprechend hoch konfiguriert werden, um unnötige Commits zu vermeiden, auch wenn in dieser Transaktion nichts passiert.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ausnahmeregelungen"><a class="anchor" href="#ausnahmeregelungen"></a>7. Ausnahmeregelungen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In bestimmten Situationen, z. B. bei der Verarbeitung extrem großer Datenmengen, kann der Fall auftreten, dass die Implementierung eines Batchschritts in Java nicht sinnvoll ist.
In solchen Fällen muss dann eine Sonderlösung, wie z. B. ein SQL-Skript oder ein Shell-Skript, gefunden werden. Shell-Skripte sind in dem folgenden Kapitel <a href="#shell-batches">Shell-Batches</a> beschrieben.</p>
</div>
<div class="paragraph">
<p>Die Entscheidung, ob in einem solchen Einzelfall eine Sonderlösung gewählt werden kann, muss zwingend in einer Architekturentscheidung erfolgen.
Eine solche Abweichung von der Referenzarchitektur muss im Systementwurf in der Liste der Abweichungen aufgeführt und begründet werden.
Dabei muss die Abwägung getroffen werden zwischen der Einhaltung der nicht-funktionalen Anforderungen und der Verringerung der Wartbarkeit durch mehrfach implementierte Funktionalität.</p>
</div>
<div class="paragraph">
<p>Wichtig ist, dass die einheitliche Außenschnittstelle der Batchschritte erhalten bleibt, d. h. anhand der übergebenen Parameter, Rückgabewerte, geloggten Daten darf für den Nutzer des Batchschritts nicht erkennbar sein, dass dieser in einer anderen Technologie umgesetzt ist.</p>
</div>
<div class="paragraph">
<p>Die Dokumentation der abweichenden Batchimplementierung erfolgt im Systementwurf und wird daraus in die Systemdokumentation übernommen.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="shell-batches"><a class="anchor" href="#shell-batches"></a>8. Shell-Batches</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="was-ist-ein-shell-batch"><a class="anchor" href="#was-ist-ein-shell-batch"></a>8.1. Was ist ein Shell-Batch?</h3>
<div class="paragraph">
<p>Als Shell-Batch wird ein Shell-Skript bezeichnet, das Stapelverarbeitungsbefehle ausführt, die direkt in diesem Skript definiert sind.
Damit fallen sie unter die Ausnahmeregelungen des vorherigen Kapitels <a href="#ausnahmeregelungen">Ausnahmeregelungen</a>.
Reguläre Batches werden meist ebenfalls über ein Shell-Skript gestartet, ihre Logik ist aber in Java programmiert.
Das Skript startet also nur das zugehörige Programm.</p>
</div>
<div class="paragraph">
<p>Der Vorteil von Shell-Batches ist, dass sie etwas schlanker sind und daher auch schneller entwickelt werden können.
Komplexe fachliche Logik sollte aber immer als dediziertes Batchprogramm umgesetzt werden, da diese auf lange Sicht besser wartbar sind.</p>
</div>
<div class="paragraph">
<p>Ein Beispiel für Shell-Batches sind einmalige SQL-Migrationen.
Das Shell-Skript baut dabei eine Verbindung mit dem Datenbank-Server auf und führt eine SQL-Datei aus.</p>
</div>
<div class="paragraph">
<p>Es gibt aber auch Systeme die im regulären Wirkbetrieb regelmäßig Shell-Batches ausführen; bspw. um Datenbankabzüge für statistische Auswertungen zu erstellen.</p>
</div>
</div>
<div class="sect2">
<h3 id="aufbau-von-shell-batches"><a class="anchor" href="#aufbau-von-shell-batches"></a>8.2. Aufbau von Shell-Batches</h3>
<div class="paragraph">
<p>Ein Shell-Batch besteht aus einem SH-Skript und ggf.
weiteren Dateien:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Property-Datei für Konfigurationen, wie bspw. die zu verwendende Datenbankverbindung</p>
</li>
<li>
<p>SQL-Skripte, die vom SH-Skript ausgeführt werden</p>
</li>
<li>
<p>weitere SH-Skripte die, die vom SH-Skript ausgeführt werden</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_namenskonvemtion"><a class="anchor" href="#_namenskonvemtion"></a>8.2.1. Namenskonvemtion</h4>
<div class="paragraph">
<p>Ein Shell-Skript muss folgender Namenskonvention folgen:</p>
</div>
<table id="table-shellskript" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 13. Batches: Shellskript</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Batches: Shellskript</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schemata</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;batchname-des-batches&gt;.sh</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>loeschfrist-pruefen.sh<br>
import-bhknz-liste.sh</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Die Dateien sollten entweder in einen eigenen Ordner unter <code>/opt</code> abgelegt werden oder – falls der Batch Teil eines bestehenden Batch-Projekts ist – in den vorhandenen Batch-Ordner des Systems deployed werden.</p>
</div>
<div class="paragraph">
<p>In letzterem Fall sollte das Deployment über das RPM des Batch-Projekts erfolgen.
Andernfalls ist – insbesondere bei nur einmaligen Migrationsbatches – ein manuelles Deployment möglich.</p>
</div>
<div class="paragraph">
<p>Die SH-Skripte müssen immer nach dem folgenden Schema aufgebaut werden:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Beschreibungskommentar mit Parametern und Rückgabewerten</p>
</li>
<li>
<p>Automatisches Ermitteln des Homeverzeichnisses des Batches</p>
</li>
<li>
<p>Einlesen der Übergabe-Parameter</p>
</li>
<li>
<p>Einlesen notwendiger Properties aus den Konfigurationsdateien</p>
</li>
<li>
<p>Ausführen der eigentlichen Batchlogik</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Der Batch gibt zudem die Startzeit, Endezeit und Laufzeit aus.</p>
</div>
<div class="paragraph">
<p>Es müssen dokumentierte Returncodes für erwartete Fehlerfälle verwendet werden, um die Fehleranalyse zu vereinfachen.</p>
</div>
<div class="paragraph">
<p>Folgende Rahmenbedingungen sind bei der Umsetzung einzuhalten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Das Homeverzeichnis (in dem das SH-Skript liegt) wird automatisiert ermittelt und wird nicht als Parameter übergeben.</p>
</li>
<li>
<p>Das Logverzeichnis muss ein optionaler Parameter sein (und damit als letzter Eingabeparameter definiert sein).
Bei Nichtangabe wird der Standard-Logpfad unter <code>&lt;HOMEVEREICHNIS&gt;/log/</code> verwendet.</p>
</li>
<li>
<p>Datenbankverbindungsangaben müssen in einer Konfigurationsdatei (<code>&lt;HOMEVERZEICHNIS&gt;/etc/jpa.properties</code>) stehen und dürfen nicht als Parameter übergeben werden.</p>
</li>
<li>
<p>SQL-Skripte, die vom SH-Skript verwendet werden müssen im Verzeichnis <code>&lt;HOMEVERZEICHNIS&gt;/sql/</code> abgelegt werden.</p>
</li>
<li>
<p>Weitere SH-Skripte, die vom Hauptskript aufgerufen werden, müssen unter <code>&lt;HOMEVERZEICHNIS&gt;/sh/</code> abgelegt werden.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Im Folgenden ist ein Beispiel-Template eines Shell-Batches angegeben:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">#!/bin/bash
#===========================================================
# Beispiel Shellbatch
#
# Vorbedingungen
# - Leeres Datenbank Schema angelegt
#
# Parameter
# - Optional: Verzeichnis, in dem die Log-Dateien abgelegt werden
#
# Rückgabewerte:
# - 0 = Erfolg
# - 10 = Keine OracleConnection angegeben (jpa.properties existiert nicht oder enthält den Schlüssel database.connection nicht)
# - 20 = Fehler beim Ausführen von Schritt 1 (01_tabelle-erstellen.sql)
# - 30 = Fehler beim Ausführen von Schritt 2 (02_tabelle-loeschen.sql)
#
# Version: $Id: shellbatch.sh &lt;revision&gt; &lt;datum&gt; &lt;user&gt; $
#
#===========================================================

#Zeit zu Beginn ermitteln +
start=`date +%s`

# Homeverzeichnis ermitteln
HomeVerzeichnis=$(cd -P -- "$(dirname -- "$0")" &amp;&amp; pwd -P)

# Parameter prüfen
if [ -z "$1" ] ; then
  LogVerzeichnis=$\{HomeVerzeichnis}/log/
else
  LogVerzeichnis=$1
Fi

# Auslesen der Oracle-Datenbankverbindung aus einer Konfigurationsdatei (jpa.properties).
PROPERTY_FILE="$\{HomeVerzeichnis}/etc/jpa.properties"
PROP_KEY="database.connection"

# Alles nach dem ersten "=" wird gematched (inklusive Leerzeichen)
OracleConnection=`cat $PROPERTY_FILE | grep "$PROP_KEY" | sed 's/[^=]*=\(.*\)/\1/'`
if [ -z "$OracleConnection" ] ; then
  echo "+++ OracleConnection konnte nicht ermittelt werden. Existiert die jpa.properties Datei und ist der richtige Schlüssel enthalten? Abbruch!"
  exit 10
fi

# Startmeldung
echo "# "$(basename $0)" um "$(date +%Y-%m-%d-%T)" gestartet"
RC=0

# Batchschritte
# 1. Ausführen eines SQL-Skripts mit SQL-Plus
if [ $\{RC} = "0" ]; then
  echo "# Fuehre 01_tabelle-erstellen.sql aus ..."
  LogDatei=$\{LogVerzeichnis}/shellbatch_$(date +%Y-%m-%d_%H-%M-%S).log
  cd $\{HomeVerzeichnis}/sql
  sqlplus "$\{OracleConnection}" @01_tabelle-erstellen.sql | tee $\{LogDatei}
  res=$?
  AnzahlFehler=$(egrep -c "SP2\-[0-9]\{4}\:|ORA\-[0-9]\{5}\:" $\{LogDatei})
  if [ $\{AnzahlFehler} -ne 0 ]; then
    echo "+++ "$\{AnzahlFehler}" Fehler in Schritt 01, RC="$\{res}"!"
    RC=20
  fi
fi

# 2. Ausführen eines weiteren SQL-Skripts mit SQL-Plus
if [ $\{RC} = "0" ]; then
  echo "# Fuehre 02_tabelle-loeschen.sql aus ..."
  LogDatei=$\{LogVerzeichnis}/shellbatch_$(date +%Y-%m-%d_%H-%M-%S).log
  cd $\{HomeVerzeichnis}/sql
  sqlplus "$\{OracleConnection}" @02_tabelle-loeschen.sql | tee $\{LogDatei}
  res=$?
  AnzahlFehler=$(egrep -c "SP2\-[0-9]\{4}\:|ORA\-[0-9]\{5}\:" $\{LogDatei})
  if [ $\{AnzahlFehler} -ne 0 ]; then
    echo "+++ "$\{AnzahlFehler}" Fehler in Schritt 02, RC="$\{res}"!"
    RC=30
  fi
fi

end=`date +%s`
# Ende-Meldung
echo "Shell-Batch wurde erfolgreich beendet. - Laufzeit" $(($end - $start)) "Sekunden"
echo "# "$(basename $0)" um "$(date +%Y-%m-%d-%T)" mit RC="$\{RC}" beendet"
exit $\{RC}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Eine funktionsfähige Version dieses Beispiels ist im isy-batchrahmen
unter <code>src/main/skripte/shellbatch_template/</code> eingecheckt.
Um dieses ausführen zu können, muss eine funktionierende Datenbankverbindung auf ein leeres Schema in der jpa.properties Datei angegeben werden.</p>
</div>
<div class="paragraph">
<p>Details zu dem Datenzugriff, welcher in diesem Beispiel aufgeführt ist, oder alternative Datenzugriffe, befinden sich in dem Dokument <a href="#DetailkonzeptKomponenteDatenzugriff">[DetailkonzeptKomponenteDatenzugriff]</a>.</p>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<div class="divFooter"></div>

<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/isyfact.js"></script>
  </body>
</html>
