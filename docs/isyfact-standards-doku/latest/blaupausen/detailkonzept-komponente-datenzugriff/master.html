<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Komponente Datenzugriff :: IsyFact Dokumentation</title>
    <link rel="canonical" href="https://github.com/isyfact/isyfact-standards-doku/latest/blaupausen/detailkonzept-komponente-datenzugriff/master.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/font-awesome.min.css">
    <link rel="stylesheet" href="../../../../_/css/isyfact.css">
    <script>var uiRootPath = '../../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://github.com/isyfact">IsyFact Dokumentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="isyfact-standards-doku" data-version="2.5-SNAPSHOT">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../einstieg/vorstellung.html">IsyFact Standards</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Einstieg</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../einstieg/vorstellung.html">Vorstellung der IsyFact</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/isyfact-standards.html">IsyFact-Standards</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/isyfact-erweiterungen.html">IsyFact-Erweiterungen</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../einstieg/vorstellung/rahmenbedingungen.html">Rahmenbedingungen</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/erste-schritte.html">Erste Schritte</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/tutorial/master.html">Tutorial</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/whitepaper/master.html">Whitepaper</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../einstieg/migrationsleitfaden-if2/master.html">Migrationsleitfaden IsyFact 2</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Blaupausen</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../referenzarchitektur/master.html">Referenzarchitektur</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../referenzarchitektur-it-system/master.html">Referenzarchitektur IT-System</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../detailkonzept-komponente-anwendungskern/master.html">Anwendungskern</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="master.html">Datenzugriff</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../detailkonzept-komponente-service/master.html">Service</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../detailkonzept-komponente-web-gui/master.html">Web GUI</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../detailkonzept-komponente-batch/master.html">Batch</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Vorgaben</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../vorgaben-architektur/master.html">Architektur</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../vorgaben-it-sicherheit/master.html">IT-Sicherheit</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Bausteine</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Datum &amp; Zeit</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-datetime/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-datetime/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Fehlerbehandlung</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-exception-core/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-exception-core/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">HttpInvoker</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-serviceapi-core/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-serviceapi-core/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Konfiguration</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-konfiguration/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-konfiguration/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Logging</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-logging/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-logging/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Polling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-polling/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-polling/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">REST</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-service-rest/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-service-rest/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sicherheit</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sicherheit/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sicherheit/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Sonderzeichen</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sonderzeichen/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-sonderzeichen/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Task Scheduling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-task/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-task/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Ãœberwachung</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-ueberwachung/konzept/master.html">Konzept</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-ueberwachung/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Util</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../isy-util/nutzungsvorgaben/master.html">Nutzungsvorgaben</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Methodik</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/namenskonventionen/master.html">Namenskonventionen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/versionierung/master.html">Versionierung</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../methodik/java-programmierkonventionen/master.html">Java-Programmierkonventionen</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/diagrammerstellung.html">Diagrammerstellung und Modellierung</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/diagrammerstellung/diagramsnet.html">diagrams.net</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/diagrammerstellung/enterprise-architect.html">Enterprise Architect</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../methodik/vorlagen.html">Vorlagen</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/tailoring/tailoring.html">Tailoring</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../methodik/spezifikation/datenflussdiagramme.html">Datenflussdiagramme</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Werkzeuge</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../werkzeuge/einrichtung_entwicklungsumgebung/master.html">Entwicklungsumgebung</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../werkzeuge/versionierungskontrolle/master.html">Versionierungskontrolle</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../werkzeuge/handbuch_dokumentation/master.html">Dokumentation der IsyFact</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../werkzeuge/seitenvorlage.html">Seitenvorlage</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../werkzeuge/kopiervorlage.html">Kopiervorlage fÃ¼r neue Seiten</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../changelog/changelog.html">Changelog</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">IsyFact Standards</span>
    <span class="version">2.5-SNAPSHOT</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../glossary/latest/glossary/master.html">Glossar</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../glossary/latest/glossary/master.html">1.0</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../einstieg/vorstellung.html">IsyFact Standards</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../einstieg/vorstellung.html">2.5-SNAPSHOT</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../einstieg/vorstellung.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../einstieg/vorstellung.html">IsyFact Standards</a></li>
    <li>Blaupausen</li>
    <li><a href="../referenzarchitektur-it-system/master.html">Referenzarchitektur IT-System</a></li>
    <li><a href="master.html">Datenzugriff</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Inhalt" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Komponente Datenzugriff</h1>
<div id="preamble">
<div class="sectionbody">
<h3 id="_detailkonzept" class="discrete">Detailkonzept</h3>
<div class="paragraph">
<p><span class="image left"><img src="../../../../glossary/latest/licence/_images/IFS-Logo.png" alt="IFS-Logo" width="150"></span> Dieses Dokument ist ein Teil der IsyFact-Standards. Alle Inhalte dieses Dokuments, insbesondere Texte und Grafiken, sind urheberrechtlich geschÃ¼tzt. Alle urheberrechtlichen Nutzungs- und Verwertungsrechte liegen beim Bundesverwaltungsamt.</p>
</div>
<div class="paragraph">
<p><span class="image right"><img src="../../../../glossary/latest/licence/_images/CC-BY.png" alt="Creative Commons Namensnennung" width="100"></span>
Die Nutzung ist unter den Lizenzbedingungen der Creative Commons Namensnennung 4.0 International gestattet.
Die Lizenzbestimmungen sind unter folgender URL erhÃ¤ltlich:</p>
</div>
<div class="paragraph">
<p><a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-cc-licence" class="xref page">Creative-Commons-Lizenz</a></p>
</div>
<div class="paragraph">
<p><strong>Java Bibliothek / IT-System</strong></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 12.5%;">
<col style="width: 37.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Art</th>
<th class="tableblock halign-left valign-top">Version</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">isy-persistence</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bibliothek</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v2.5-SNAPSHOT</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="Einleitung"><a class="anchor" href="#Einleitung"></a>1. Einleitung</h2>
<div class="sectionbody">
<div class="paragraph">
<p>GemÃ¤ÃŸ den Vorgaben der <a href="../referenzarchitektur/master.html" class="xref page">Referenzarchitektur</a> basiert die Architektur eines IT-Systems auf der bekannten Drei-Schichten-Architektur.
Eine dieser Schichten ist die Persistenzschicht.
In dieser Schicht ist alle FunktionalitÃ¤t enthalten, die zum Erzeugen, Suchen, Bearbeiten und LÃ¶schen von DatensÃ¤tzen benÃ¶tigt wird.
Der Zugriff auf eine relationale Datenbank ist in dieser Schicht vollstÃ¤ndig gekapselt.
In Richtung Datenbank kommuniziert diese Schicht mittels JDBC und SQL, in Richtung des Anwendungskerns stellt die Schicht persistente Objekte zur VerfÃ¼gung.</p>
</div>
<div class="paragraph">
<p>In <a href="#image-IFRefArcITSsysPers">Abbildung 1</a> ist die Referenzarchitektur eines IT-Systems noch einmal dargestellt, wobei die Persistenzschicht mit der Komponente Datenhaltung hervorgehoben ist.</p>
</div>
<div id="image-IFRefArcITSsysPers" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/IFRefArcITSsysPers.png" alt="IFRefArcITSsysPers">
</div>
<div class="title">Abbildung 1. Referenzarchitektur eines IT-Systems</div>
</div>
<div class="paragraph">
<p>Dieses Dokument beschreibt die Vorgaben zur Umsetzung einer solchen Persistenzschicht im Detail.
Die Implementierung der Zugriffsschicht wird durch die Verwendung eines standardisierten Frameworks erleichtert.
Als Frameworks werden JPA/Hibernate sowie Spring Data JPA verwendet.
Das Dokument legt auÃŸerdem allgemeine Vorgaben fÃ¼r das Persistenzmodell (die dauerhaft zu speichernden Objekte) fest und behandelt weiterfÃ¼hrende Themen wie Historisierung von Daten.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warnung"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Das Thema Transaktionssteuerung wird nicht im Rahmen des Datenzugriffs behandelt, da Transaktionen in der IsyFact Ã¼ber den Anwendungskern bzw. die Nutzungsschicht gesteuert werden.
Mehr zu diesem Thema ist in den anderen Detailkonzepten enthalten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="../detailkonzept-komponente-anwendungskern/master.html#transaktionssteuerung" class="xref page">Detailkonzept Komponente Anwendungskern</a></p>
</li>
<li>
<p><a href="../detailkonzept-komponente-batch/master.html#die-transaktionssteuerung" class="xref page">Detailkonzept Komponente Batch</a></p>
</li>
<li>
<p><a href="../detailkonzept-komponente-service/master.html#transaktionssteuerung" class="xref page">Detailkonzept Komponente Service</a></p>
</li>
<li>
<p><a href="../detailkonzept-komponente-web-gui/master.html#zugriff-awk" class="xref page">Detailkonzept Komponente Web-GUI</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Die Vorgaben zum Thema JPA/Hibernate betreffen die folgenden Themenbereiche:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Die Definition des Mappings zwischen Persistenzobjekten und der Datenbank.</p>
</li>
<li>
<p>Die Konfiguration von JPA.</p>
</li>
<li>
<p>Die Konfiguration von Hibernate.</p>
</li>
<li>
<p>Die Verwendung von JPA in der Anwendung, vor allem das Zusammenspiel mit dem Spring Framework.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Hinweis"></i>
</td>
<td class="content">
Dieses Dokument ist keine allgemeine Anleitung zur Verwendung von JPA.
FÃ¼r den Einstieg in JPA mit Hibernate ist das Buch <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-JPA-Hibernate" class="xref page">â€žJava Persistence with Hibernateâ€œ</a> sehr zu empfehlen.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>FÃ¼r ein VerstÃ¤ndnis der in diesem Dokument geforderten JPA-Nutzung ist vor allem die <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-vorlageanwendung" class="xref page">Vorlageanwendung</a> zu empfehlen.
Die:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Konfiguration in der Datei <code>application.properties</code>,</p>
</li>
<li>
<p>Persistenzklassen <code>Terminfindung</code> und <code>Teilnehmer</code>,</p>
</li>
<li>
<p>Data Access Objects <code>TerminfindungDao</code> und <code>TeilnehmerDao</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>entsprechen den in diesem Dokument gemachten Vorgaben und kÃ¶nnen bequem als Vorlage fÃ¼r eigene Implementierungen verwendet werden.
Die in diesem Dokument gezeigten Code-Beispiele stammen in der Regel auch aus der Vorlage-Anwendung.</p>
</div>
<div class="paragraph">
<p>JPA kann (gerade in Verbindung mit dem Spring Framework) auf verschiedene Arten verwendet werden.
Die in diesem Dokument aufgestellten Vorgaben fÃ¼r die Verwendung von JPA verfolgen vor allem zwei Ziele:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Die Verwendung von JPA projektÃ¼bergreifend zu vereinheitlichen.</p>
</li>
<li>
<p>Die Verwendung von JPA so einfach, komfortabel und verstÃ¤ndlich wie mÃ¶glich zu gestalten.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Auf Grund dieser Anforderungen wird versucht, mÃ¶glichst ausschlieÃŸlich die Mechanismen von JPA zu verwenden.
Nur wo dies nicht mÃ¶glich ist, darf auf die Hibernate-Implementierung zugegriffen werden.
Dabei wird in diesem Dokument die Verwendung bestimmter Hibernate-Features verboten bzw. von ihrer Verwendung abgeraten.</p>
</div>
<div class="paragraph">
<p>Abweichungen zu den Vorgaben dieses Dokuments mÃ¼ssen als Architekturentscheidung im <a href="../../methodik/vorlage-systementwurf/antora-master.html" class="xref page">IsyFact Systementwurf</a> dokumentiert werden.</p>
</div>
<div class="paragraph">
<p>Dieses Dokument ist wie folgt aufgebaut:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ZunÃ¤chst werden im Kapitel <a href="#anforderungen">Anforderungen</a> die Anforderungen an die Komponente Datenzugriff kurz motiviert.</p>
</li>
<li>
<p>AnschlieÃŸend werden im Kapitel <a href="#persistenzlogik">Persistenzlogik</a> grundsÃ¤tzliche Regeln vorgestellt, wie die Abbildung von Objekten auf Datenbanken stattfinden soll.</p>
</li>
<li>
<p>Das Kapitel <a href="#die-definition-des-mappings-zwischen-objekten-und-datenbank">Die Definition des Mappings zwischen Objekten und Datenbank</a> vertieft anschlieÃŸend das Thema Mapping, wobei konkrete Hinweise zur Abbildung von Attributen auf Datenbankfelder gegeben werden.</p>
</li>
<li>
<p>Im Anschluss daran wird die konkrete Nutzung des Datenbankzugriffs in der Anwendung beschrieben.
ZunÃ¤chst wird gezeigt, wie Spring Data JPA aus der Anwendung heraus genutzt werden soll (Kapitel <a href="#verwendung-von-jpa-in-der-anwendung">Verwendung von JPA in der Anwendung</a> ).
AnschlieÃŸend wird erlÃ¤utert, wie Datenbank-Abfragen durchgefÃ¼hrt werden (Kapitel <a href="#jpql-fuer-datenbank-abfragen-nutzen">JPQL fÃ¼r Datenbankabfragen nutzen</a> ).</p>
</li>
<li>
<p>Die generelle Konfiguration von JPA und Hibernate ist im Kapitel <a href="#konfiguration-von-jpa-und-hibernate-in-der-anwendung">Konfiguration von JPA und Hibernate in der Anwendung</a> beschrieben.</p>
</li>
<li>
<p>AbschlieÃŸend wird noch das Thema Historisierung (Kapitel <a href="#historisierung">Historisierung</a> ) behandelt.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="anforderungen"><a class="anchor" href="#anforderungen"></a>2. Anforderungen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die in diesem Dokument aufgestellten Vorgaben setzen folgende Anforderungen um:</p>
</div>
<div class="paragraph">
<p><strong>Einfachheit der Verwendung von JPA:</strong> Dies betrifft sowohl die Erstellung von JPA-Konfigurationen und des JPA verwendenden Codes als auch deren VerstÃ¤ndlichkeit und Wartbarkeit.
Konkret kann diese Anforderung in die folgenden Anforderungen aufgeteilt werden:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Einfachheit und VerstÃ¤ndlichkeit der Konfiguration und der Mapping-Definition von JPA.</p>
</li>
<li>
<p>Einfachheit und VerstÃ¤ndlichkeit des JPA verwendenden Codes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Schmale, definierte JPA-Schnittstelle:</strong> Die Verwendung und Konfiguration von JPA soll isoliert und Ã¼ber eine schmale Schnittstelle erfolgen.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Die Komponente Datenzugriff soll auf JPA Ã¼ber die schmale Schnittstelle zugreifen.</p>
</li>
<li>
<p>Die Stellen, an welchen JPA verwendet wird, sollen keine Fachlogik enthalten.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Effizienz und Schnelligkeit der JPA Zugriffsschicht und der dahinter liegenden Hibernate-Implementierung:</strong> Die von
JPA abgesetzten Datenbank-Aufrufe sollen effizient sein.
UnnÃ¶tige Zugriffe und doppelte Zugriffe sollen vermieden werden.</p>
</div>
<div class="paragraph">
<p><strong>Einheitlichkeit der Verwendung von JPA:</strong> Die Konfiguration und Programmierung der JPA-Zugriffe soll zum einen
Ã¼ber die gleichen Mechanismen und zum anderen an den gleichen Stellen vorgenommen werden.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistenzlogik"><a class="anchor" href="#persistenzlogik"></a>3. Persistenzlogik</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die Persistenzlogik gliedert sich, wie der Anwendungskern, in <strong>Fachkomponenten</strong>.
Im Normalfall ist der Funktionsumfang dieser Fachkomponenten viel geringer als der Funktionsumfang der Entsprechungen im Anwendungskern.
Dies liegt darin begrÃ¼ndet, dass sich die Persistenzlogik ausschlieÃŸlich um die Speicherung von GeschÃ¤ftsobjekten in einer Datenbank kÃ¼mmert und selbst keinerlei GeschÃ¤ftslogik beinhaltet.</p>
</div>
<div class="paragraph">
<p>Die Fachkomponenten bestehen wiederum aus einer Schnittstelle und den persistenten Objekten.
Die Schnittstelle bildet in der Regel ein Data Access Object ab.
Persistente Objekte werden EntitÃ¤ten genannt.</p>
</div>
<div class="paragraph">
<p>Die <a href="#aufbau-fachkomponente-datenzugriff">folgende Abbildung</a> zeigt den Aufbau einer Fachkomponente im Datenzugriff.</p>
</div>
<div id="aufbau-fachkomponente-datenzugriff" class="imageblock">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/aufbau_fachkomponente_datenzugriff.dn.svg" alt="aufbau fachkomponente datenzugriff.dn">
</div>
<div class="title">Abbildung 2. Aufbau einer Fachkomponente des Datenzugriffs</div>
</div>
<div class="paragraph">
<p>Ein <strong>Data Access Object (DAO)</strong> beschreibt die Schnittstelle der Fachkomponente, d.h. die Operationen, die zum Speichern und Lesen der EntitÃ¤ten aus der Datenbank nÃ¶tig sind.
DAOs werden Ã¼ber <em>Spring Data Repositories</em> abgebildet.
Der Name eines Repositories leitet sich von derjenigen EntitÃ¤t ab, die Ã¼ber das Repository bearbeitet wird.</p>
</div>
<table id="table-repossimpl" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 1. Namenskonvention DAO: Spring Data Repository</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Data Access Object: Spring Data Repository</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;EntitÃ¤t&gt;Repository</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiel</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AkteRepository</code></p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warnung"></i>
</td>
<td class="content">
Der folgende, hervorgehobene Absatz wird nur noch aus historischen GrÃ¼nden erwÃ¤hnt und ist obsolet.
</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Vor der Verwendung von Spring Data wurden DAOs mithilfe von zwei Klassen umgesetzt: einem Interface und einer Implementierung.
Der Name eines DAO-Interfaces leitet sich von derjenigen EntitÃ¤t ab, die Ã¼ber das DAO bearbeitet wird.</p>
</div>
<table id="table-daossimpl" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 2. Namenskonvention DAO: Interface + Implementierung</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Data Access Object: Interface + Implementierung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;EntitÃ¤t&gt;Dao<br>
&lt;EntitÃ¤t&gt;DaoImpl</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AkteDao<br>
AkteDaoImpl</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="paragraph">
<p><strong>EntitÃ¤ten</strong> bilden GeschÃ¤ftsobjekte ab und werden in der Regel nach ihnen benannt.</p>
</div>
<table id="table-entity" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 3. Namenskonvention EntitÃ¤t</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">EntitÃ¤t</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;GeschÃ¤ftsobjekt&gt;</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiel</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Termin</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Ein <strong>Persistenz-Klassenmodell</strong> ist das Modell der EntitÃ¤ten, welche dauerhaft abgespeichert werden sollen.
Die folgenden Abschnitte beschreiben gewÃ¼nschte Eigenschaften des Persistenz-Klassenmodells sowie Verwendungsregeln.</p>
</div>
<div class="sect2">
<h3 id="persistenz-klassenmodell-und-datenbank-schema-sollen-moeglichst-aehnlich-sein"><a class="anchor" href="#persistenz-klassenmodell-und-datenbank-schema-sollen-moeglichst-aehnlich-sein"></a>3.1. Persistenz-Klassenmodell und Datenbank-Schema sollen mÃ¶glichst Ã¤hnlich sein</h3>
<div class="paragraph">
<p>Im Idealfall wird jedes Persistenzobjekt auf eine Tabelle des Datenbankschemas abgebildet.
Eine solche Abbildung ist intuitiv und erleichtert das VerstÃ¤ndnis der Anwendung und des Datenbankschemas, was wiederum in der Wartung ein groÃŸer Vorteil ist.</p>
</div>
<div class="paragraph">
<p>TatsÃ¤chlich ist es aus GrÃ¼nden der Datenbankperformance aber oft erforderlich, von diesem Idealfall abzuweichen.
Hier gilt es, auf mÃ¶glichst wenige Tabellen zuzugreifen, um an die benÃ¶tigten Informationen zu gelangen.</p>
</div>
<div class="paragraph">
<p>So ist es zum Beispiel sinnvoll, fÃ¼r 1:1-Beziehungen im Persistenz-Klassenmodell den JPA-Mechanismus der Embeddables zu verwenden.
Hier wird der Inhalt einer Datenbank Tabelle durch ein entsprechendes JPA-Mapping auf mindestens zwei Persistenzklassen verteilt.
Solche Persistenzobjekte kÃ¶nnen dann Ã¼ber das Lesen einer einzigen Tabellenzeile aus der Datenbank gefÃ¼llt werden.</p>
</div>
</div>
<div class="sect2">
<h3 id="verwendung-generischer-datenstrukturen-vermeiden"><a class="anchor" href="#verwendung-generischer-datenstrukturen-vermeiden"></a>3.2. Verwendung generischer Datenstrukturen vermeiden</h3>
<div class="paragraph">
<p>JPA ermÃ¶glicht die Verwendung generischer Datenstrukturen.
Dabei kÃ¶nnen die Spalten einer Tabelle in AbhÃ¤ngigkeit eines Deskriptorwertes in einer speziell definierten Spalte auf unterschiedliche Attribute verschiedener Persistenzklassen abgebildet werden.
Eine solche Vorgehensweise erschwert das VerstÃ¤ndnis der Daten bei einem direkten Zugriff auf die Datenbank mit Datenbankwerkzeugen und damit auch die Fehleranalyse und Wartung.</p>
</div>
<div class="paragraph">
<p>Trotzdem kann es aus GrÃ¼nden der Datenbankperformance erforderlich sein, generische Datenstrukturen zu verwenden.
Werden z.Â B. Persistenzklassen mit einer gemeinsamen Oberklasse als generische Datenstruktur in einer Tabelle abgelegt und sollen die Attribute der Oberklasse gesucht werden, so kann die Suche auf der Datenbank in einer einzigen Tabelle durchgefÃ¼hrt werden.
Die Persistenzobjekte kÃ¶nnen ohne zusÃ¤tzliche Joins aus der Datenbank gelesen werden.</p>
</div>
<div class="paragraph">
<p>Werden generische Datenstrukturen verwendet, dann ist es obligatorisch, dass fÃ¼r jede Persistenzklasse, die in dieser Datenstruktur abgespeichert wird, ein eigener Datenbank-View definiert wird.
Dieser Datenbank-View enthÃ¤lt alle Attribute der Persistenzklasse mit einem sprechenden Namen.
Diese Datenbank-Views kÃ¶nnen dann beim direkten Zugriff mit Datenbankwerkzeugen und bei der Fehleranalyse verwendet werden.</p>
</div>
</div>
<div class="sect2">
<h3 id="vererbung-im-persistenz-klassenmodell-vermeiden"><a class="anchor" href="#vererbung-im-persistenz-klassenmodell-vermeiden"></a>3.3. Vererbung im Persistenz-Klassenmodell vermeiden</h3>
<div class="paragraph">
<p>Klassenhierarchien (der Einsatz von Vererbung) sind bei PersistenzÂ­objekten zu vermeiden.
Abweichungen sind nur fÃ¼r eine Reduzierung der KomplexitÃ¤t des Persistenz-Klassenmodells erlaubt.</p>
</div>
<div class="paragraph">
<p>Falls Vererbung im Persistenz-Klassenmodell eingesetzt wird, ist sie im Datenbank-Schema auf folgende Weise umzusetzen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ãœber eine Tabelle, welche die Daten aller Klassen der Hierarchie (â€žTable per class hierarchyâ€œ, siehe <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-JPA-Hibernate" class="xref page">â€žJava Persistence with Hibernateâ€œ</a> Kapitel 5.1.3) enthÃ¤lt.
Diese Art der Abbildung ist vorzuziehen.
Falls sie aufgrund vieler unterschiedlicher Felder oder Problemen mit Pflichtfeldern in den Klassen nicht verwendbar ist, kÃ¶nnen auch andere Strategien verwendet werden.
Die Vor- und Nachteile der einzelnen Strategien sind in <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-JPA-Hibernate" class="xref page">â€žJava Persistence with Hibernateâ€œ</a> beschrieben.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Die Klassenhierarchie ist in jedem Fall mÃ¶glichst flach zu halten: Soweit mÃ¶glich sollen nur zwei Stufen verwendet werden.</p>
</div>
</div>
<div class="sect2">
<h3 id="fachlogik-in-persistenzklassen-vermeiden"><a class="anchor" href="#fachlogik-in-persistenzklassen-vermeiden"></a>3.4. Fachlogik in Persistenzklassen vermeiden</h3>
<div class="paragraph">
<p>Die Implementierung von fachlicher Logik in den Persistenzklassen ist zu vermeiden.
Idealerweise sollten die Persistenzklassen lediglich Getter- und Setter-Methoden fÃ¼r die persistierten Daten enthalten.
Jegliche Logik sollte im Anwendungskern implementiert werden.</p>
</div>
<div class="paragraph">
<p>Zur Fachlogik gehÃ¶ren auch Validierungen.</p>
</div>
</div>
<div class="sect2">
<h3 id="methoden-equals-und-hashcode-implementieren"><a class="anchor" href="#methoden-equals-und-hashcode-implementieren"></a>3.5. Methoden equals und hashCode implementieren</h3>
<div class="paragraph">
<p>Im Normalfall mÃ¼ssen fÃ¼r EntitÃ¤tsklassen die Methoden <code>equals</code> und <code>hashCode</code> nicht Ã¼berschrieben werden.</p>
</div>
<div class="paragraph">
<p>Nur fÃ¼r Embeddable-Klassen (siehe <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-JPA-Hibernate" class="xref page">â€žJava Persistence with Hibernateâ€œ</a> Kapitel 4.4.2) mÃ¼ssen die Methoden <code>equals</code> und <code>hashCode</code> implementiert werden.
Die Methoden mÃ¼ssen dafÃ¼r sÃ¤mtliche Attribute mit einbeziehen ZusÃ¤tzlich muss das Interface <code>Serializable</code> implementiert werden.</p>
</div>
<div class="paragraph">
<p>FÃ¼r Beispiele zu den <code>equals-</code> und <code>hashCode-`Implementierungen siehe die Klasse `Organisator</code> der <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-vorlageanwendung" class="xref page">Vorlage-Anwendung</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="initialisieren-von-string-feldern"><a class="anchor" href="#initialisieren-von-string-feldern"></a>3.6. Initialisieren von String-Feldern</h3>
<div class="paragraph">
<p>FÃ¼r die Verarbeitung im Regelwerk ist es hilfreich, dass String-Felder initialisiert werden, da ansonsten in nahezu allen Regeln zwischen <code>""</code> und <code>null</code> differenziert werden mÃ¼sste.
In Objekten, die in das Regelwerk eingegeben werden sollen, wird daher bei der Definition von String-Feldern initial ein Leer-String gesetzt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class Teilnehmer {
   private String name = "";
   // ...
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="die-definition-des-mappings-zwischen-objekten-und-datenbank"><a class="anchor" href="#die-definition-des-mappings-zwischen-objekten-und-datenbank"></a>4. Die Definition des Mappings zwischen Objekten und Datenbank</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Im vorherigen Abschnitt wurden allgemeine Regeln fÃ¼r das Persistenz-Klassenmodell aufgestellt.
In diesem Kapitel wird die Abbildung dieses Modells auf ein Datenbankschema in JPA beschrieben.</p>
</div>
<div class="sect2">
<h3 id="definition-des-mappings-ueber-annotationen"><a class="anchor" href="#definition-des-mappings-ueber-annotationen"></a>4.1. Definition des Mappings Ã¼ber Annotationen</h3>
<div class="paragraph">
<p>Die Definition des Mappings wird Ã¼ber Annotationen in den Persistenzklassen (EntitÃ¤tsklassen) durchgefÃ¼hrt.
Pro Klasse wird Ã¼ber die Annotationen definiert, auf welche Tabelle sie abgebildet werden und wie ihre Variablen auf Datenbank-Felder abgebildet werden.
FÃ¼r Beispiele zu Annotationen siehe die Klassen <code>Terminfindung</code>, <code>Tag</code> und <code>Zeitraum</code> in der <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-vorlageanwendung" class="xref page">Vorlageanwendung</a>.</p>
</div>
<div class="paragraph">
<p>Ãœber Annotationen kÃ¶nnen einige wenige Mappings nicht definiert werden, welche Ã¼ber eine XML-Konfigurationsdatei definierbar sind.
Ein Beispiel dafÃ¼r ist das Mapping einer Klasse auf zwei verschiedene Tabellen.</p>
</div>
<div class="paragraph">
<p>Falls eine XML-Mapping-Konfiguration fÃ¼r eine Klasse notwendig ist, ist die Konfiguration fÃ¼r diese Klasse in einer XML-Konfigurationsdatei abzulegen.
Diese wird automatisch von JPA verwendet.</p>
</div>
</div>
<div class="sect2">
<h3 id="n-assoziationen-in-der-regel-als-set-ohne-reihenfolge-definieren"><a class="anchor" href="#n-assoziationen-in-der-regel-als-set-ohne-reihenfolge-definieren"></a>4.2. 1:n Assoziationen in der Regel als Set (ohne Reihenfolge) definieren</h3>
<div class="paragraph">
<p>Beim Abbilden einer 1:n Assoziation (â€žCollection Mappingâ€œ, siehe <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-Collection-Mapping" class="xref page">Collections</a>) ist in der Regel als Java-Typ <code>Set</code> zu definieren, da in einem <code>Set</code> keine Reihenfolge definiert ist.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)
@JoinColumn(name = "zeitraum_id")
private Set&lt;TeilnehmerZeitraum&gt; teilnehmerZeitraeume = new HashSet&lt;&gt;();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wird von der Anwendung eine Sortierung benÃ¶tigt und sind alle fÃ¼r die Sortierung benÃ¶tigten Attribute in der EntitÃ¤t enthalten, dann kann auch der Java-Typ <code>List</code> verwendet werden, da die Datenbank effizienter sortieren kann als eine Java-Implementierung.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)
@JoinColumn(name = "terminfindung_id")
@OrderBy("datum ASC")
private List&lt;Tag&gt; termine = new ArrayList&lt;&gt;();</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="identifizierende-attribute-verwenden"><a class="anchor" href="#identifizierende-attribute-verwenden"></a>4.3. Identifizierende Attribute verwenden</h3>
<div class="paragraph">
<p>Falls fÃ¼r eine EntitÃ¤t genau ein identifizierendes Attribut existiert, ist dieses sowohl in der Datenbank als auch im Hibernate Mapping als PrimÃ¤rschlÃ¼ssel zu verwenden.
KÃ¼nstliche ID-Spalten sind nur dann als SchlÃ¼ssel zu verwenden, wenn kein identifizierendes Attribut fÃ¼r die EntitÃ¤t vorliegt oder nur mehrere Attribute zusammen die EntitÃ¤t eindeutig identifizieren.
Zusammengesetzte SchlÃ¼ssel dÃ¼rfen nicht verwendet werden.</p>
</div>
<div class="paragraph">
<p>Das identifizierende Attribut darf beliebige Typen besitzen: Es dÃ¼rfen Zeichenketten oder Datumsangaben sein.</p>
</div>
</div>
<div class="sect2">
<h3 id="bidirektionale-assoziationen-vermeiden"><a class="anchor" href="#bidirektionale-assoziationen-vermeiden"></a>4.4. Bidirektionale Assoziationen vermeiden</h3>
<div class="paragraph">
<p>Bidirektional traversierbare Assoziationen (<code>get</code> -Methoden auf beiden Seiten) sind zu vermeiden.
FÃ¼r die Traversierung in Gegenrichtung sollte eine Query verwendet werden.</p>
</div>
<div class="paragraph">
<p>Grund fÃ¼r die Vorgabe ist, dass Ã„nderungen am â€žinversen Endeâ€œ der Assoziation nicht persistiert werden.
Falls wirklich eine bidirektionale Assoziation benÃ¶tigt wird, sind in der EntitÃ¤t am â€žinversen Endeâ€œ der Assoziation <code>add/remove</code> Methoden zu definieren, welche die Assoziation korrekt manipulieren.</p>
</div>
<div class="paragraph">
<p>Explizit verboten sind bidirektional traversierbare n:m Assoziationen.
HierfÃ¼r sind zwei 1:n (bzw. n:1) Mappings zu definieren.</p>
</div>
</div>
<div class="sect2">
<h3 id="behandlung-von-zeitangaben"><a class="anchor" href="#behandlung-von-zeitangaben"></a>4.5. Behandlung von Datums- und Zeitangaben</h3>
<div class="paragraph">
<p>Es werden die Datums- und Zeitklassen aus der <em>Java 8 Date Time API</em> verwendet.
Hinweise zu deren Verwendung finden sich im <a href="../../isy-datetime/konzept/master.html" class="xref page">Konzept Datum Zeit</a>.
Zur Persistierung von ZeitrÃ¤umen und ungewissen Datums- und Zeitangaben im Sinne des <a href="../../isy-datetime/konzept/master.html" class="xref page">Konzept Datum Zeit</a> werden die <code>@Entity</code>-Klasse <code>ZeitraumEntitaet</code> und die <code>@Embeddable</code>-Klassen <code>UngewisseZeitEntitaet</code> und <code>UngewissesDatumEntitaet</code> bereitgestellt.</p>
</div>
<div class="sect3">
<h4 id="_altanwendungen"><a class="anchor" href="#_altanwendungen"></a>4.5.1. Altanwendungen</h4>
<div class="paragraph">
<p>FÃ¼r alte Anwendungen, die nicht die <em>Java 8 Date Time API</em> verwenden, sondern noch <code>java.util.Date</code> verwenden, gelten die folgenden Vorgaben.</p>
</div>
<div class="paragraph">
<p>In der Datenbank erfolgt die Speicherung in einem Attribut vom Typ <code>TIMESTAMP</code>.
In der EntitÃ¤tsklasse ist das Mapping wie folgt anzugeben:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Temporal(TemporalType.TIMESTAMP)
private Date updateDate;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Falls die Genauigkeit des Timestamp-Datentyps fachlich nicht gewÃ¼nscht ist, kann der Technische Chefdesigner entscheiden, dass in der Datenbank der Typ <code>DATE</code> verwendet wird.
Das Mapping muss dann folgendermaÃŸen festgelegt werden:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Temporal(TemporalType.DATE)
private Date updateDate;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hibernate erzeugt beim Laden der Daten aus der Datenbank implizit Objekte der Typen <code>java.sql.Timestamp</code> bzw. <code>java.sql.Date</code> fÃ¼r diese Attribute.
Beide Typen sind von <code>java.util.Date</code> abgeleitet und dieses Verhalten damit fÃ¼r den Entwickler transparent.</p>
</div>
<div class="paragraph">
<p>Vergleiche von Zeitangaben unterschiedlicher Genauigkeit sind jedoch problematisch:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>GrundsÃ¤tzlich darf der Vergleich <strong>nicht mit der <code>Equals-</code> Methode</strong> durchgefÃ¼hrt werden, es muss immer <code>compareTo</code> verwendet werden.</p>
</li>
<li>
<p>Ein Vergleich mit <strong><code>CompareTo</code> muss immer auf dem Attribut mit hÃ¶herer Genauigkeit</strong> (also auf dem <code>java.sql.Timestamp</code>) aufgerufen werden:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">.getTimestamp().compareTo(getDate()); // OK
.getDate().compareTo(getTimestamp()); // Nicht OK
.getDate().equals(getTimestamp()); // Nicht OK</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>FÃ¼r Berechnungen, z.Â B. das Hinzuaddieren von Tagen, oder das Setzen von Feldern, ist der Daten-Typ <code>java.util.Calendar</code> zu verwenden.
In diesem Fall wird im Anwendungskern temporÃ¤r ein <code>Calendar</code>-Objekt fÃ¼r das entsprechende Datum erzeugt:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Hinweis"></i>
</td>
<td class="content">
Insbesondere dÃ¼rfen die als Deprecated markierten Methoden von Date nicht verwendet werden.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">Calendar cal = Calendar.getInstance();
cal.add(Calendar.DAY_OF_MONTH, 1); // Einen Tag addieren
cal.set(Calendar.MONTH, 11); // Monat auf Dezember setzen</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="boolesche-variablen"><a class="anchor" href="#boolesche-variablen"></a>4.6. Boolesche Variablen</h3>
<div class="paragraph">
<p>FÃ¼r die Ablage von booleschen Werten in der Datenbank ist stets ein <code>NUMBER</code> Feld zu verwenden, kein Textfeld.
Der Wert wird Ã¼ber das default Hibernate-Mapping auf 1 fÃ¼r wahr und 0 fÃ¼r falsch abgebildet.</p>
</div>
</div>
<div class="sect2">
<h3 id="enum-variablen"><a class="anchor" href="#enum-variablen"></a>4.7. Enum-Variablen</h3>
<div class="paragraph">
<p>FÃ¼r die Ablage von Enum-Feldern persistenter EntitÃ¤ten in der Datenbank sind in JPA zwei Modi vorgesehen, die jedoch beide mit Nachteilen verbunden sind:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Hinweis"></i>
</td>
<td class="content">
Siehe <code>javax.persistence.EnumType</code>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ORDINAL</code>: Die Enum-AusprÃ¤gungen werden durchnummeriert und als Integer abgelegt.
Diese Ablage ist sehr ungÃ¼nstig, weil sich beim HinzufÃ¼gen oder Entfernen einer Enum-AusprÃ¤gung, die nicht die letzte ist, die Nummern verschieben und dadurch eine Datenmigration erforderlich wird.</p>
</li>
<li>
<p><code>STRING</code>: Es wird der Java-Name der Enum-AusprÃ¤gung in der Datenbank abgelegt.
Diese Ablage ist problematisch, weil sie eine enge Kopplung des Java-Codes an die Datenbankinhalte erzeugt.
Unter UmstÃ¤nden sollen im Java-Code lange, sprechende Namen genutzt werden, wÃ¤hrend fÃ¼r die Ablage in der Datenbank eine kurze, Speicherplatz sparende Darstellung gewÃ¼nscht ist.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Aufgrund der genannten SchwÃ¤chen werden in der Bibliothek <code>isy-persistence</code> zwei Hibernate User-Types zur VerfÃ¼gung gestellt, um Enum-Werte auf eine VARCHAR-Spalte der Datenbank abzubilden:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>EnumUserType</code> erlaubt es, in einem Enum per Annotation die gewÃ¼nschte Datenbankdarstellung zu jeder AusprÃ¤gung anzugeben.</p>
</li>
<li>
<p><code>EnumWithIdUserType</code> erlaubt die Persistierung von Enums, die einen fachlichen SchlÃ¼ssel als Attribut besitzen.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Beispiel fÃ¼r eine Enum-Klasse mit annotierten Persistenzwerten:</p>
</div>
<div id="listing-enum-annotated" class="listingblock">
<div class="title">Listing 1. Enum-Klasse mit annotierten Persistenzwerten</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public enum Geschlecht {
  @PersistentValue("M")
  MAENNLICH,
  @PersistentValue("W")
  WEIBLICH
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Beispiel fÃ¼r eine Enum-Klasse mit natÃ¼rlichem SchlÃ¼ssel:</p>
</div>
<div id="listing-enum-natural-key" class="listingblock">
<div class="title">Listing 2. Enum-Klasse mit natÃ¼rlichem SchlÃ¼ssel</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public enum Geschlecht {
  MAENNLICH("M"),
  WEIBLICH("W");

  private final String id;

  private Geschlecht(String id) {
    this.id = id;
  }

  @EnumId
  public String getId() {
    return id;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Beispiel fÃ¼r eine persistente EntitÃ¤t, die ein Enum-Feld enthÃ¤lt:</p>
</div>
<div id="listing-entity-enum-field" class="listingblock">
<div class="title">Listing 3. Enum-Feld an einer persistenten EntitÃ¤t</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
public class Person {
  ...

  @Column(nullable = *false*, length = 1)
  @Type(type = "de.bund.bva.isyfact.persistence.usertype.Enum(WithId)UserType", parameters = { @Parameter(
    name = "enumClass",
    value = "&lt;Package&gt;.Geschlecht") })
  public Geschlecht getGeschlecht() {
    return geschlecht;
  }
  ...
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="datenbankschema-anfangs-ueber-hbm2ddl-erzeugen"><a class="anchor" href="#datenbankschema-anfangs-ueber-hbm2ddl-erzeugen"></a>4.8. Datenbankschema anfangs Ã¼ber hbm2ddl erzeugen</h3>
<div class="paragraph">
<p>FÃ¼r die Erstellung des Datenbank-Schemas wird empfohlen, es initial Ã¼ber Hibernate zu erzeugen.
Dies ist einfach zu konfigurieren: In <code>application.properties</code> wird dazu die folgende Property gesetzt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.jpa.hibernate.ddl-auto=create</code></pre>
</div>
</div>
<div class="paragraph">
<p>GrundsÃ¤tzlich ist es mÃ¶glich, sÃ¤mtliche Tabellen-Eigenschaften (etwa auch die FeldlÃ¤ngen und Indizes) Ã¼ber Annotationen zu definieren und das Datenbank-Schema komplett durch hbm2ddl zu erzeugen.
Hierzu wird keine Vorgabe erstellt: Ob die DDL wÃ¤hrend der Entwicklung stets generiert wird oder sie nach einer initialen Generierung verÃ¤ndert und parallel gepflegt wird, ist je nach KomplexitÃ¤t des Schemas zu entscheiden.</p>
</div>
<div class="paragraph">
<p>Befindet sich die Anwendung in Produktion, dann muss der Parameter <code>spring.jpa.hibernate.ddl-auto</code> auskommentiert werden, damit weder eine Generierung noch eine Validierung des Schemas stattfindet.
Alternativ kann auch der Wert <code>none</code> gesetzt werden.
Eine Validierung durch Setzen des Parameters auf <code>validate</code> findet nicht statt.
Stattdessen wird eine explizite Versionierung des Schemas verwendet: Bei jedem Start der Anwendung wird Ã¼berprÃ¼ft, ob in der Datenbank die Schema-Version vorliegt, die die Anwendung erwartet.
Die FunktionalitÃ¤t hierzu ist in Abschnitt <a href="#pruefen-der-schema-version">PrÃ¼fen der Schema-Version</a> beschrieben.</p>
</div>
</div>
<div class="sect2">
<h3 id="vergabe-von-indizes"><a class="anchor" href="#vergabe-von-indizes"></a>4.9. Vergabe von Indizes</h3>
<div class="paragraph">
<p>Indizes sind ein wichtiges Element, um eine gute Performance des Datenbankzugriffs sicherzustellen.
Indizes mÃ¼ssen dabei gezielt vergeben werden.
Fehlende Indizes fÃ¼hren hÃ¤ufig zu einer schlechten Performance der Anwendung und belasten die Datenbank unter UmstÃ¤nden durch das Auftreten von Full-Table-Scans sehr stark.
Zu viele Indizes verschlechtern die Performance beim Schreiben von DatensÃ¤tzen und verbrauchen unnÃ¶tigen Speicherplatz.</p>
</div>
<div class="paragraph">
<p>Die tatsÃ¤chlich notwendigen Indizes kÃ¶nnen letztendlich hÃ¤ufig nur in Produktion festgestellt werden.
In dem Sinne ist es sinnvoll wÃ¤hrend der Entwicklung zunÃ¤chst nur die sicher notwendigen Indizes anzulegen und diese spÃ¤ter durch Erkenntnisse aus Lasttests und Produktion zu ergÃ¤nzen.</p>
</div>
<div class="paragraph">
<p>Initial sind folgende Indizes vorzusehen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ein Index auf jeder Spalte, die als FremdschlÃ¼ssel verwendet wird,</p>
</li>
<li>
<p>ein Index auf (fachliche) SchlÃ¼sselattribute, die sehr hÃ¤ufig im Rahmen der Verarbeitung genutzt werden (Beispiele: Nummer eines Registereintrags, Kennung einer Nachricht).</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="verwendung-von-jpa-in-der-anwendung"><a class="anchor" href="#verwendung-von-jpa-in-der-anwendung"></a>5. Verwendung von JPA in der Anwendung</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Nachdem ein Persistenzmodell erstellt und das Mapping auf ein Datenbankschema definiert wurde
(siehe Kapitel <a href="#persistenzlogik">Persistenzlogik</a> und <a href="#die-definition-des-mappings-zwischen-objekten-und-datenbank">Die Definition des Mappings zwischen Objekten und Datenbank</a>),
kÃ¶nnen die Persistenzobjekte in der Anwendung verwendet werden.
In diesem Kapitel wird der Zugriff auf Persistenzobjekte mit der Hilfe von Spring Data beschrieben.</p>
</div>
<div class="sect2">
<h3 id="zugriff-auf-jpa-nur-ueber-data-access-objects-daos"><a class="anchor" href="#zugriff-auf-jpa-nur-ueber-data-access-objects-daos"></a>5.1. Zugriff auf JPA nur Ã¼ber Data-Access-Objects (DAOs)</h3>
<div class="paragraph">
<p>Die Persistenzfunktionen werden in Data-Access-Objects (DAOs) mithilfe des JPA Entity Managers implementiert.</p>
</div>
<div class="paragraph">
<p>Um den Anteil an Boilerplate Code bei der Implementierung von Data Access Objects deutlich zu reduzieren, wird die Abstraktion fÃ¼r Data Access Object von Spring Data eingesetzt.
Die hÃ¤ufig verwendeten CRUD-Methoden (Create, Read, Update, Delete) werden vom Interface <code>CrudRepository</code> (siehe <a href="#listing-crudrepository">Listing 4</a>) aus Spring Data zur direkten Verwendung angeboten.
Zur Implementierung werden zwei Typparameter benÃ¶tigt: der EntitÃ¤tstyp <code>T</code> und der Typ des PrimÃ¤rschlÃ¼ssels <code>ID</code>.</p>
</div>
<div id="listing-crudrepository" class="listingblock">
<div class="title">Listing 4. Methoden von CrudRepository</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface CrudRepository&lt;T,ID&gt; {
    long        count();
    void        delete(T entity)
    void        deleteAll()
    void        deleteAll(Iterable&lt;? extends T&gt; entities)
    void        deleteById(ID id)
    boolean     existsById(ID id)
    Iterable&lt;T&gt; findAll()
    Iterable&lt;T&gt; findAllById(Iterable&lt;ID&gt; ids)
    Optional&lt;T&gt; findById(ID id)
    S           save(S entity)
    Iterable&lt;S&gt; saveAll(Iterable&lt;S&gt; entities)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>FÃ¼r ein konkretes DAO ist ein eigenes Interface von der Basisschnittstelle <code>CrudRepository</code> abzuleiten.
Die Benennung erfolgt gemÃ¤ÃŸ der <a href="#namenskonvention-spring-data-repository">Namenskonvention</a>.
In der Dao-Klasse kÃ¶nnen weitere DAO-Operationen definiert werden, zum Beispiel zur DurchfÃ¼hrung von Queries.
Ein Beispiel hierfÃ¼r ist in <a href="#listing-beispielrepository">Listing 5</a> zu sehen.</p>
</div>
<div class="paragraph">
<p>Weiterhin ist das eigene Interface mit der Annotation <code>@Repository</code> zu versehen, damit alle vom Entity Manager erzeugten Exceptions in die besser auszuwertenden Spring-<code>DataAccessExceptions</code> umgewandelt werden.</p>
</div>
<div id="listing-beispielrepository" class="listingblock">
<div class="title">Listing 5. Beispiel fÃ¼r ein eigenes Data Access Object</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Repository
public interface EintragDao extends CrudRepository&lt;Eintrag, Long&gt; {
    List&lt;Eintrag&gt; findAllBy...

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Damit die DAOs von Spring automatisch als Beans erzeugt werden, muss eine Konfigurationsklasse der Anwendung mit der Annotation <code>@EnableJpaRepositories</code> annotiert werden.</p>
</div>
<div id="listing-enablejparepositories" class="listingblock">
<div class="title">Listing 6. Automatische Erstellung von DAO-Beans durch Spring</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableJpaRepositories("&lt;Package-Name des Persistenz-Packages&gt;")
class PersistenceConfiguration { }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Der Zugriff auf die Datenbank aus dem <a href="../../../../glossary/latest/glossary/master.html#glossar-Anwendungskern" class="xref page">Anwendungskern</a> heraus erfolgt immer Ã¼ber die DAOs.
Die DAOs werden als Spring-Beans in den Anwendungskern injiziert.
Zudem wird fÃ¼r jedes DAO ein Interface angelegt.</p>
</div>
<div class="paragraph">
<p>DAOs werden im Persistenzpaket der Komponente abgelegt, welche die Datenhoheit Ã¼ber die Tabelle(n) des DAOs besitzt (zum Thema Datenhoheit siehe <a href="../referenzarchitektur-it-system/master.html#einleitung" class="xref page">IsyFact Referenzarchitektur IT-Systeme</a>).
Falls die Datenhoheit keiner einzelnen Komponente zugewiesen werden kann, erhÃ¤lt die Komponente Basisdaten die Datenhoheit (siehe auch <a href="../detailkonzept-komponente-anwendungskern/master.html" class="xref page">Detailkonzept Komponente Anwendungskern</a>).
Die DAOs werden nur von Klassen der Komponente mit Datenhoheit aufgerufen.</p>
</div>
<div class="paragraph">
<p>WÃ¤hrend Ã¼ber DAOs Persistenzobjekte aus der Datenbank gelesen und in die Datenbank eingefÃ¼gt werden, kÃ¶nnen sie auch auÃŸerhalb dieser Klassen verÃ¤ndert bzw. befÃ¼llt werden.
Dies darf jedoch gemÃ¤ÃŸ der <a href="../referenzarchitektur/master.html#einleitung" class="xref page">IsyFact Referenzarchitektur</a> nur von Klassen innerhalb der gleichen Teilanwendung  erfolgen: Komponenten anderer Teilanwendungen dÃ¼rfen sie nicht verÃ¤ndern oder befÃ¼llen.
Sie erhalten daher lediglich Deep-Copies bzw. nicht Ã¤nderbare Varianten der EntitÃ¤ten.</p>
</div>
<div class="paragraph">
<p>Eine Ausnahme hierzu bildet die Komponente Basisdaten: Sie gibt die EntitÃ¤ten an andere Komponenten weiter, welche diese verÃ¤ndern und befÃ¼llen dÃ¼rfen.</p>
</div>
<div class="paragraph">
<p>Als Beispiel fÃ¼r DAOs siehe die Klassen <code>TerminfindungDao</code> und <code>TeilnehmerDao</code> der Vorlage-Anwendung <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-vorlageanwendung" class="xref page">Vorlageanwendung</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="definition-von-query-methoden"><a class="anchor" href="#definition-von-query-methoden"></a>5.2. Definition von Query Methoden</h3>
<div class="paragraph">
<p>Der von Spring Data erzeugte Proxy fÃ¼r das Repository Interface kann die Queries auf zwei Arten ableiten.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ableitung des Queries Ã¼ber den Namen der Methode. <a href="#listing-querymethodenname">Listing 7</a> zeigt ein Beispiel hierfÃ¼r.</p>
<div id="listing-querymethodenname" class="listingblock">
<div class="title">Listing 7. Beispiele fÃ¼r die Ableitung des Queries aus dem Methodennamen.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">interface PersonRepository extends Repository&lt;Person, Long&gt; {

  List&lt;Person&gt; findByEmailAdresseAndNachname(EmailAdresse emailAdresse, String nachname);

  // Verwendung von DISTINCT
  List&lt;Person&gt; findDistinctPeopleByNachnameOrVorname(String nachname, String vorname);
  List&lt;Person&gt; findPeopleDistinctByNachnameOrVorname(String nachname, String vorname);

  // Ignorieren der GroÃŸ-/Kleinschreibung fÃ¼r ein bestimmtes Feld
  List&lt;Person&gt; findByNachnameIgnoreCase(String nachname);
  // Ignorieren der GroÃŸ-/Kleinschreibung fÃ¼r alle betroffenen Felder
  List&lt;Person&gt; findByNachnameAndVornameAllIgnoreCase(String nachname, String vorname);

  // Statisches Sortieren mit ORDER BY
  List&lt;Person&gt; findByNachnameOrderByVornameAsc(String nachname);
  List&lt;Person&gt; findByNachnameOrderByVornameDesc(String nachname);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Bei dieser Ableitung wird das PrÃ¤fix des Methodennamens abgeschnitten und der Rest geparst.
Nach dem ersten <code>By</code> beginnen die eigentlichen Abfragekriterien.
In den Abfragekriterien werden Bedingungen auf Feldern der EntitÃ¤t definiert und diese kÃ¶nnen mit 'And' und 'Or'
verknÃ¼pft werden.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Hinweis"></i>
</td>
<td class="content">
Eine Ãœbersicht zur Ableitung von Queries aus Methodennamen befindet sich in der Referenzdokumentation zu Spring Data JPA:
<a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-Spring-Data-JPA" class="xref page">Spring-Data-JPA</a>
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Ableitung Ã¼ber eine manuell definierte Query.
Die Query wird Ã¼ber die <code>@Query</code>-Annotation in JPQL direkt an die Methode des DAO geschrieben.</p>
<div id="listing-queryannotation" class="listingblock">
<div class="title">Listing 8. Beispiele fÃ¼r die Ableitung des Queries aus dem Methodennamen.</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface PersonRepository extends Repository&lt;Person, Long&gt; {

  @Query("select p from Person p where p.emailAdresse = ?1")
  User findByEmailAdresse(String emailAdresse);
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Bevorzugt wird die Ableitung der Queries Ã¼ber den Methodennamen.
Kann die Query nicht Ã¼ber den Methodennamen ausgedrÃ¼ckt werden, wird Variante 2 verwendet.</p>
</div>
</div>
<div class="sect2">
<h3 id="jpql-fuer-datenbank-abfragen-nutzen"><a class="anchor" href="#jpql-fuer-datenbank-abfragen-nutzen"></a>5.3. JPQL fÃ¼r Datenbank-Abfragen nutzen</h3>
<div class="paragraph">
<p>FÃ¼r Datenbank-Abfragen stellt JPA die Java Persistence Query Language JPQL bereit.
In dieser werden Queries Ã¼ber Objekte und Variablen, nicht Ã¼ber Tabellen und Felder definiert.</p>
</div>
<div class="paragraph">
<p>Wann immer mÃ¶glich sollten JPQL Abfragen und keine â€žnativenâ€œ SQL Abfragen verwendet werden.
Der einzige Grund fÃ¼r die Verwendung von SQL ist die Verwendung von Oracle SQL Features, welche durch JPQL nicht angeboten werden.</p>
</div>
</div>
<div class="sect2">
<h3 id="verwendung-von-oracle-hints-bei-optimizer-problemen"><a class="anchor" href="#verwendung-von-oracle-hints-bei-optimizer-problemen"></a>5.4. Verwendung von Oracle Hints bei Optimizer-Problemen</h3>
<div class="paragraph">
<p>NamedQueries werden als JDBC <code>PreparedStatements</code> umgesetzt.
Deshalb werden sie vom Oracle Optimizer bereits analysiert und ein AusfÃ¼hrungsplan erstellt, bevor ihre Parameter gebunden werden.</p>
</div>
<div class="paragraph">
<p>Dies fÃ¼hrt in AusnahmefÃ¤llen dazu, dass ein benÃ¶tigter Index fÃ¼r die Query-Bearbeitung nicht verwendet wird und â€žFull Tablescansâ€œ durchgefÃ¼hrt werden.</p>
</div>
<div class="paragraph">
<p>Im Falle von Index-Problemen bei NamedQueries sind Oracle-Hints zu verwenden.
Die Queries sind als native SQL-Queries in der XML Konfigurationsdatei abzulegen.</p>
</div>
<div class="paragraph">
<p>Ein Beispiel fÃ¼r einen Oracle-Hint in einer SQL-Query:</p>
</div>
<div id="listing-query-oracle-hint" class="listingblock">
<div class="title">Listing 9. Beispiel fÃ¼r einen Oracle-Hint in einer SQL-Query</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">select /*+ INDEX(aendno AENDERUNGS_NOTIFIKATION_STATUS) */ aendno from AENDERUNGS_NOTIFIKATION aendno where aendno.status = ?1 and aendno.zeitpunktNotifikation &gt; :datumVon and aendno.zeitpunktNotifikation &lt; :datumBis</code></pre>
</div>
</div>
<div class="paragraph">
<p>Eine Kurzanleitung zur Verwendung von Oracle-Traces fÃ¼r die Ermittlung von AusfÃ¼hrungsplÃ¤nen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In SQL*Plus als sysdba:<br>
<code>sqlplus sys/sys@ DATA.LOCAL.VM AS SYSDBA</code></p>
</li>
<li>
<p>Trace fÃ¼r ganze DB-Instanz anschalten:<br>
<code>alter system set sql_trace=true;</code></p>
</li>
<li>
<p>Time-Informationen anschalten<br>
<code>alter system set timed_statistics=true;</code></p>
</li>
<li>
<p>Ort, an dem das Trace-File liegt, ermitteln:<br>
<code>select value from v$parameter where name = 'user_dump_dest'</code></p>
</li>
<li>
<p>TKPROF drÃ¼berlaufen lassen, als oracle user, damit tkprof schon gesetzt ist<br>
<code>tkprof ora_19952.trc auswertung.txt</code></p>
</li>
<li>
<p>Am Ende: Trace fÃ¼r ganze DB-Instanz abschalten:<br>
<code>alter system set sql_trace=false;</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="verwendung-von-hibernate-filtern"><a class="anchor" href="#verwendung-von-hibernate-filtern"></a>5.5. Verwendung von Hibernate Filtern</h3>
<div class="paragraph">
<p>Parametrisierte Hibernate Filter bieten die MÃ¶glichkeit Daten zur Laufzeit mit Sichtbarkeitsregeln auszuwerten, ohne viele verschiedene Varianten von Abfragen schreiben zu mÃ¼ssen.
Dabei kÃ¶nnen sie pro Session aktiviert oder deaktiviert werden, standardmÃ¤ÃŸig sind sie deaktiviert.
Die Filter kÃ¶nnen auf Klassen- oder Collection-Ebene definiert werden und kÃ¶nnen bestehende â€žwhereâ€œ-Klauseln erweitern.</p>
</div>
<div class="paragraph">
<p>Wenn das fachliche Datenmodell variable Sichtbarkeitsregeln in grÃ¶ÃŸerem Umfang benÃ¶tigt, sollten diese mit Hibernate Filtern umgesetzt werden.
Das ersetzt eine Multiplizierung aller Abfragen.</p>
</div>
<div class="paragraph">
<p>Filter mÃ¼ssen als Annotationen mit <code>@FilterDef</code>, <code>@Filters</code> und <code>@Filter</code> umgesetzt werden.</p>
</div>
</div>
<div class="sect2">
<h3 id="verbot-von-bulk-queries"><a class="anchor" href="#verbot-von-bulk-queries"></a>5.6. Verbot von Bulk-Queries</h3>
<div class="paragraph">
<p>JPA bietet Ã¼ber die Methode <code>query.executeUpdate()</code> die MÃ¶glichkeit in JPQL formulierte <code>DELETE</code>- und <code>UPDATE</code>-Statements, sog. Bulk-Queries, auszufÃ¼hren.
Die Nutzung solcher Bulk-Queries ist verboten.
Wo aus PerformancegrÃ¼nden massenhafte <code>DELETE</code>- oder <code>UPDATE</code>-Statements direkt in der Datenbank benÃ¶tigt werden, kÃ¶nnen native SQL-Anweisungen verwendet werden.
Sofern bei solchen Bulk-Operationen kaskadierende Ã„nderungen benÃ¶tigt werden (z.Â B. weil Kind-Tabellen mitgelÃ¶scht werden sollen), mÃ¼ssen entsprechende Constraints in der Datenbank angelegt werden.</p>
</div>
<div class="paragraph">
<p>BegrÃ¼ndung: Hibernate erzeugt bei der AusfÃ¼hrung von <code>BULK</code>-Queries unter bestimmten UmstÃ¤nden zur Laufzeit implizit Hilfstabellen (temporÃ¤re Tabellen mit dem PrÃ¤fix HT_).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Hinweis"></i>
</td>
<td class="content">
siehe <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-Multitable-Bulk-Operations" class="xref page">Multitable Bulk Operations</a>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Dies fÃ¼hrt dazu, dass der Datenbank-User der Anwendung entsprechende <code>CREATE TABLE</code>-Rechte benÃ¶tigt, was i.Â d.Â R. nicht zugelassen ist.
Weiterhin fÃ¼hrt die Nutzung der temporÃ¤ren Tabellen in vielen FÃ¤llen zu Performance-Problemen.</p>
</div>
<div class="paragraph">
<p>Um die Einhaltung dieser Anforderung sicherzustellen, sollten auch in der Entwicklung bzw. bei frÃ¼hen Tests die Rechte auf die Testdatenbanken entsprechend beschrÃ¤nkt werden.</p>
</div>
</div>
<div class="sect2">
<h3 id="sicherheitsaspekte-von-anfragen"><a class="anchor" href="#sicherheitsaspekte-von-anfragen"></a>5.7. Sicherheitsaspekte von Anfragen</h3>
<div class="paragraph">
<p>Bei der Formulierung von Anfragen sind einige Aspekte zu beachten, da ansonsten negative Auswirkungen auf die StabilitÃ¤t, die VerfÃ¼gbarkeit oder Sicherheit der Anwendung die Folge sind.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Der %-Operator ist nach MÃ¶glichkeit zu vermeiden, da hiermit leicht lang laufende Abfragen erzeugt werden kÃ¶nnen, die die Anwendung blockieren und die Datenbank unnÃ¶tig belasten kÃ¶nnen.</p>
</li>
<li>
<p>FÃ¼r rein lesende Zugriffe und feste Auswertungen sind nach MÃ¶glichkeit Views zu verwenden und die Berechtigungen entsprechend zu setzen.
Dadurch kann der Zugriff auf die tatsÃ¤chlich benÃ¶tigten Daten gesteuert und eingeschrÃ¤nkt werden.</p>
</li>
<li>
<p>Bei der Formulierung von Anfragen sind die Eigenheiten des Optimizers des eingesetzten DBMS zu beachten.</p>
</li>
<li>
<p>Es ist darauf zu achten, dass Datenbankabfragen in Anwendungen durch Indizes in der Datenbank unterstÃ¼tzt werden.</p>
</li>
<li>
<p>Bei der Definition von Anfragen ist darauf zu achten, dass nicht zu viele Daten selektiert werden.
Im Zweifel, insbesondere bei freien Anfragen, die aus Benutzereingaben erzeugt werden, sollte die Anzahl der selektierten DatensÃ¤tze beschrÃ¤nkt werden.</p>
</li>
<li>
<p>Um SQL-Injection Attacken zu verhindern, sollen Named-Queries oder Criteria-Queries verwendeten werden, bei denen der OR-Mapper fÃ¼r ein Escaping der Query-Parameter sorgt.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="packagestruktur"><a class="anchor" href="#packagestruktur"></a>6. Paketstruktur fÃ¼r Persistenzklassen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die DAOs- und EntitÃ¤tsklassen sollen im Persistence-Package der entsprechenden Komponente implementiert werden.
.Vorgaben zur Paketstruktur fÃ¼r Persistenzklassen</p>
</div>
<table id="table-paketstruktur" class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Persistenzklasse</th>
<th class="tableblock halign-left valign-top">Paketstruktur</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">DAO</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;organisation&gt;.&lt;domÃ¤ne&gt;.&lt;system&gt;.persistence.&lt;komponente&gt;.dao</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Entity</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;organisation&gt;.&lt;domÃ¤ne&gt;.&lt;system&gt;.persistence.&lt;komponente&gt;.entity</code></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="konfiguration-von-jpa-und-hibernate-in-der-anwendung"><a class="anchor" href="#konfiguration-von-jpa-und-hibernate-in-der-anwendung"></a>7. Konfiguration von JPA und Hibernate in der Anwendung</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In den folgenden Abschnitten werden konkrete Vorgaben gemacht, welche Konfigurationen fÃ¼r die Umsetzung des Datenzugriffs verwendet werden sollen.</p>
</div>
<div class="sect2">
<h3 id="konfiguration-von-jpa-ueber-spring-beans-durchfuehren"><a class="anchor" href="#konfiguration-von-jpa-ueber-spring-beans-durchfuehren"></a>7.1. Konfiguration von JPA Ã¼ber Spring Beans durchfÃ¼hren</h3>
<div class="paragraph">
<p>Die fÃ¼r die Verwendung von JPA benÃ¶tigten Beans werden von Spring Boot beim Start der Anwendung automatisch instanziiert.</p>
</div>
<div class="paragraph">
<p>Teile dieser automatischen Konfiguration kÃ¶nnen bei Bedarf Ã¼berschrieben werden.
Soll z.Â B. fÃ¼r die Entwicklung eine andere Datenbank verwendet werden, kann die automatisch konfigurierte <code>DataSource</code>-Bean durch eine andere Ã¼berschrieben werden.
Das Gleiche gilt fÃ¼r die Anbindung einer zweiten Datenbank, siehe dazu <a href="#nutzung-und-anbindung-einer-zweiten-datenbank">Nutzung und Anbindung einer zweiten Datenbank</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="konfiguration-des-entitymanagers"><a class="anchor" href="#konfiguration-des-entitymanagers"></a>7.2. Konfiguration des EntityManagers</h3>
<div class="paragraph">
<p>Der EntityManager wird von Spring Boot automatisch konfiguriert.
Eine zusÃ¤tzliche Konfiguration kann Ã¼ber <code>application.properties</code> erfolgen.
GrundsÃ¤tzlich kÃ¶nnen nach dem Schema <code>spring.jpa.properties.&lt;SchlÃ¼ssel&gt;=&lt;Wert&gt;</code> beliebige native Properties fÃ¼r Hibernate gesetzt werden (<a href="#listing-configentitymanager">Listing 10</a>).</p>
</div>
<div id="listing-configentitymanager" class="listingblock">
<div class="title">Listing 10. Konfiguration des EntityManagers in application.properties</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=false

spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.Oracle12cDialect
spring.jpa.properties.hibernate.connection.isolation=4
spring.jpa.properties.hibernate.connection.useUnicode=true
spring.jpa.properties.hibernate.connection.characterEncoding=utf-8
spring.jpa.properties.hibernate.jdbc.batch_size=0
spring.jpa.properties.hibernate.jdbc.use_streams_for_binary=true
spring.jpa.properties.hibernate.format_sql=false
spring.jpa.properties.hibernate.default_schema=&lt;Default Schema&gt;
spring.jpa.properties.hibernate.ejb.metamodel.generation=enabled

# Folgender Parameter ist optional, da er dem Standard entspricht
spring.jpa.properties.hibernate.transaction.coordinator_class=jdbc</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="konfiguration-der-datasource"><a class="anchor" href="#konfiguration-der-datasource"></a>7.3. Konfiguration der Datasource</h3>
<div class="paragraph">
<p>Als Datasource-Implementierung muss die Implementierung aus <code>de.bund.bva.isyfact.persistence.datasource.IsyDataSource</code> genutzt werden.
Bei der Verwendung von <code>isy-persistence</code> wird automatisch eine Bean mit dem Namen <code>appDataSource</code> erzeugt.
Diese prÃ¼ft die Version des Datenbankschemas (siehe Abschnitt <a href="#pruefen-der-schema-version">PrÃ¼fen der Schema-Version</a>) und dient als Wrapper fÃ¼r die wirkliche Datasource des Connections-Pools, dessen Konfiguration im nÃ¤chsten Abschnitt erlÃ¤utert wird.</p>
</div>
</div>
<div class="sect2">
<h3 id="oracle-universal-connection-pool-ucp-verwenden"><a class="anchor" href="#oracle-universal-connection-pool-ucp-verwenden"></a>7.4. Oracle Universal Connection Pool (UCP) verwenden</h3>
<div class="paragraph">
<p>Bei der Verwendung von JPA mit Spring <strong>muss</strong> zwingend ein Datenbank-Connection-Pooling verwendet werden: Die aktuelle Spring Implementierung der <code>EntityManagerFactory</code> fragt bei jeder Erzeugung eines Entity Managers (und somit bei jeder Anfrage) eine Datenbank-Verbindung an.</p>
</div>
<div class="paragraph">
<p>FÃ¼r das Datenbank-Connection-Pooling ist der Oracle Universal Connection Pool (UCP) einzusetzen.
Dieser kann auf der Oracle Website heruntergeladen werden.</p>
</div>
<div class="paragraph">
<p>Zur Laufzeit bietet der Pool Informationen per JMX an, die zur Ãœberwachung der PoolaktivitÃ¤t nÃ¼tzlich sind.
Dazu zÃ¤hlt unter anderem die Anzahl aktuell ausgeliehener Verbindungen.</p>
</div>
<div class="paragraph">
<p>Die zu setzenden Parameter kÃ¶nnen der folgenden Vorlage entnommen werden, wobei die genaue Bedeutung der Parameter der Oracle Dokumentation <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-UCP" class="xref page">Ucp15</a> entnommen werden kann:</p>
</div>
<div class="paragraph">
<p>Die Konfiguration des UCP erfolgt in <code>application.properties</code> Ã¼ber die Properties in <a href="#listing-configpropertiesucp">Listing 11</a>.</p>
</div>
<div id="listing-configpropertiesucp" class="listingblock">
<div class="title">Listing 11. Properties zur Konfiguration des UCP</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-ruby hljs" data-lang="ruby"># Connection-String fÃ¼r die Datenbankverbindung
isy.persistence.oracle.datasource.database-url=jdbc:oracle:thin:@database.local.vm:1521:isyfact
# Name des Datenbankbenutzers
isy.persistence.oracle.datasource.database-username=anwendungxyz
# Passwort fÃ¼r den Datenbankbenutzer
isy.persistence.oracle.datasource.database-password=anwendungxyz
# Name des Verbindungspools
isy.persistence.oracle.datasource.pool-name=anwendungxyz
# Anzahl der minimal offenen Verbindungen im Connection Cache
isy.persistence.oracle.datasource.pool-min-active=5
# Anzahl der maximal moeglichen Verbindungen im Connection Cache
isy.persistence.oracle.datasource.pool-max-active=40
# Anzahl der initialen Connections im Connection Cache
isy.persistence.oracle.datasource.pool-initial-size=10
# Aktiviert/deaktiviert die Pruefung von Datenbankverbindungen vor ihrer Benutzung (validateConnectionOnBorrow)
isy.persistence.oracle.datasource.pool-validate-on-borrow=true
# Zeit in Sekunden, nach der bei Nichtverfuegbarkeit einer neue Verbindung ein Fehler geworfen wird
isy.persistence.oracle.datasource.pool-wait-timeout=10
# Zeit in Sekunden, nach der eine bereitstehende und untÃ¤tige Verbindung geschlossen und aus dem Pool entfernt wird
isy.persistence.oracle.datasource.pool-inactive-timeout=120
# Zeit in Sekunden, nach der eine ausgeliehene Verbindung wieder zwangsweise zurÃ¼ck in den Pool geholt wird.
# Offene Transaktionen werden zurÃ¼ckgerollt. Standard ist 0 (deaktiviert).
isy.persistence.oracle.datasource.pool-time-to-live-timeout=0
# Zeit in Sekunden, nach der eine ungenutzte aber verliehene Verbindung wieder in den Pool geholt wird.
# Offene Transaktionen werden zurÃ¼ckgerollt. Standard ist 0 (deaktiviert).
isy.persistence.oracle.datasource.pool-abandoned-timeout=0
# Zeit in Sekunden, nach der eine physikalische Verbindung im Pool geordnet abgebaut wird. Sie wird erst abgebaut,
# wenn die Verbindung nicht mehr genutzt wird und zurÃ¼ck im Pool ist. Kann genutzt werden, wenn bspw. Firewalls
# nach einer zeitlichen BeschrÃ¤nkung Verbindungen schliessen. Standard ist 0, deaktiviert.
isy.persistence.oracle.datasource.pool-max-reuse-time=0
# Maximale Anzahl, die eine Verbindung ausgeliehen werden kann, bevor sie endgueltig abgebaut wird. Standard 0 (deaktiviert)
isy.persistence.oracle.datasource.pool-max-reuse-count=0
# Anzahl der Statements, die pro Verbindung gecacht werden sollen (Statement Cache). Standard ist 0 (deaktiviert).
isy.persistence.oracle.datasource.pool-statement-cache=0

# --- Konfiguration des Oracle JDBC Datenbanktreibers ---
# Der Wert fuer oracle.net.CONNECT_TIMEOUT des Oracle JDBC Treibers. Der Timeout bestimmt die maximale Zeit in ms,
# welche zum Aufbau einer Netzwerkverbindung zum Datenbankserver gewartet wird.
isy.persistence.oracle.datasource.jdbc-timeout-connect=10000
# Der Wert fuer oracle.jdbc.ReadTimeout des Oracle JDBC Treibers. Der Timeout bestimmt die maximale Zeit in ms,
# welche auf Socketebene zum Lesen von Daten gewartet wird.Dadurch koennen abgebrochene TCP Verbindungen erkannt werden.
isy.persistence.oracle.datasource.jdbc-timeout-read
# Verbindungen kÃ¶nnen im regulÃ¤ren band (inband) oder asynchron (out-of-band) beendet werden. StandardmÃ¤ssig passiert das
# per OOB. Kann bei Problemen deaktiviert werden.
isy.persistence.oracle.datasource.jdbc-disable-oob</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hierbei ist zu beachten, dass die hier angegebenen Werte der Konfigurationsparameter nur beispielhaft sind.
Sie mÃ¼ssen je nach Anwendung und Lastprofil angepasst werden.</p>
</div>
</div>
<div class="sect2">
<h3 id="standardmaessig-lazy-loading-verwenden"><a class="anchor" href="#standardmaessig-lazy-loading-verwenden"></a>7.5. StandardmÃ¤ÃŸig Lazy Loading verwenden</h3>
<div class="paragraph">
<p>StandardmÃ¤ÃŸig verwendet Hibernate fÃ¼r alle 1:n und n:m Assoziationen ein Lazy Loading Ã¼ber dynamische Proxies und fÃ¼r n:1 oder 1:1 Assoziationen wird Eager Loading eingesetzt.
StandardmÃ¤ÃŸig soll fÃ¼r alle Assoziationen Lazy Loading verwendet werden, wobei Bytecode-Manipulationen fÃ¼r Lazy Loading nicht verwendet werden sollen.</p>
</div>
<div class="paragraph">
<p>Um Lazy Loading auch fÃ¼r 1:1 Assoziationen einzuschalten, wird das <code>fetch</code>-Attribut auf <code>FetchType.LAZY</code> gesetzt.
Damit das Lazy Loading Ã¼ber Proxies funktioniert, muss die Assoziation nicht optional sein, d.Â h., dass Feld darf nicht <code>null</code> sein.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OneToOne(optional = false, fetch = FetchType.LAZY)
private SomeEntity someEntity;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ist ein 1:1 assoziiertes Feld optional und kann den Wert <code>null</code> annehmen, kann Lazy Loading nur Ã¼ber Bytecode-Manipulation realisiert werden.
FÃ¼r n:1 Assoziationen wird genauso verfahren und das <code>fetch</code>-Attribut auf <code>FetchType.LAZY</code> gesetzt.
Es ist erlaubt und erwÃ¼nscht, dieses Verhalten fÃ¼r Assoziationen zu Ã¼berschreiben, bei denen Eager Loading Sinn ergibt.
HierfÃ¼r ist das Attribute <code>fetch</code> der jeweiligen Mapping-Annotation wie folgt zu setzen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@OneToMany(fetch = FetchType.EAGER)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Die Verwendung der Annotationen <code>@LazyToOne</code> und <code>@LazyCollection</code> ist zu vermeiden, falls man nicht den <code>@LazyCollection</code> Wert â€žExtraâ€œ fÃ¼r extra groÃŸe Collections benÃ¶tigt.</p>
</div>
</div>
<div class="sect2">
<h3 id="standardmaessig-optimistisches-locking-verwenden"><a class="anchor" href="#standardmaessig-optimistisches-locking-verwenden"></a>7.6. StandardmÃ¤ÃŸig optimistisches Locking verwenden</h3>
<div class="paragraph">
<p>StandardmÃ¤ÃŸig ist fÃ¼r Hibernate ein optimistisches Locking zu verwenden: Objekte werden bei dieser Locking-Strategie nicht per â€žselect for updateâ€œ gesperrt.
Stattdessen wird am Ende der Transaktion geprÃ¼ft, ob lokal verÃ¤nderte Objekte parallel in der Datenbank geÃ¤ndert wurden.
Ist dies der Fall, wird eine Ausnahme geworfen.</p>
</div>
<div class="paragraph">
<p>Dieser Vorgehensweise liegt die Annahme zugrunde, dass konkurrierende schreibende Zugriffe in einer GeschÃ¤ftsanwendung nicht oder hÃ¶chstens in AusnahmefÃ¤llen vorkommen.
Sollte dies nicht zutreffen, muss explizites Locking verwendet werden (vgl.
Abschnitt <a href="#bei-bedarf-explizites-locking-verwenden">Bei Bedarf explizites Locking verwenden</a>). In der Anwendung ist keine explizite Fehlerbehandlung (etwa durch das Mergen der Daten) zu implementieren.
Die geworfene Ausnahme ist (gewrappt) an den Aufrufer weiterzugeben.</p>
</div>
<div class="paragraph">
<p>Um zu erkennen, ob sich das Objekt in der Datenbank verÃ¤ndert hat, empfiehlt Hibernate die Verwendung eines numerischen Versions-Felds in jeder Datenbank-Tabelle.
Dazu wird in den EntitÃ¤ten eine numerische Property mit der Annotation <code>@Version</code> gekennzeichnet.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Version
public int getVersion() {
  return version;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dieses Feld wird einzig von Hibernate verwaltet. Es ist weder zu lesen noch zu schreiben.</p>
</div>
</div>
<div class="sect2">
<h3 id="bei-bedarf-explizites-locking-verwenden"><a class="anchor" href="#bei-bedarf-explizites-locking-verwenden"></a>7.7. Bei Bedarf explizites Locking verwenden</h3>
<div class="paragraph">
<p>Falls fÃ¼r einen Teil der EntitÃ¤ten konkurrierende Zugriffe mÃ¶glich sind, ist fÃ¼r genau diese EntitÃ¤ten ein explizites (pessimistisches) Locking zu verwenden.</p>
</div>
</div>
<div class="sect2">
<h3 id="aufrufuebergreifendes-caching-vermeiden"><a class="anchor" href="#aufrufuebergreifendes-caching-vermeiden"></a>7.8. AufrufÃ¼bergreifendes Caching vermeiden</h3>
<div class="paragraph">
<p>Caching-Strategien sind kein Teil der JPA-Spezifikation.
FÃ¼r das Definieren eines Cache muss deswegen auf Hibernate-spezifische Mechanismen zugegriffen werden.</p>
</div>
<div class="paragraph">
<p>Jeder Aufruf der Persistenzschicht geschieht innerhalb einer Transaktion.
In der Regel lÃ¤uft jeder Aufruf in einer eigenen Transaktion ab, weswegen kein Zustand und keine Daten zwischen zwei Aufrufen gehalten oder geteilt werden kÃ¶nnen.
AuÃŸer in AusnahmefÃ¤llen ist dies jedoch auch nicht notwendig.</p>
</div>
<div class="paragraph">
<p>Ist ein aufrufÃ¼bergreifendes Caching dennoch notwendig, ist dies nicht in der Persistenzschicht und nicht mittels Hibernate durchzufÃ¼hren.
Hibernate bietet fÃ¼r das Caching von Objekten prinzipiell zwei MÃ¶glichkeiten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Cache in der Hibernate-Session:</strong> Die Hibernate-Session ist an einen Thread gebunden.
Die Nutzungsschicht verwendet fÃ¼r jede Anfrage einen neuen Thread (und damit eine frische Hibernate-Session).
Deshalb kann dieser Cache hÃ¶chstens im Rahmen einer Anfrage an das IT-System gelten.
Diese Nutzung eines Cache ist nicht sinnvoll.</p>
</li>
<li>
<p><strong>VM-weiter â€ž2nd Level Cacheâ€œ:</strong> Dieser Cache ist vor allem fÃ¼r unverÃ¤nderliche, hÃ¤ufig verwendete Informationen (z.B. SchlÃ¼sseldaten) gedacht.
In der IsyFact werden solche Daten jedoch bereits durch andere Mechanismen vorgehalten.
Deshalb ist eine Verwendung dieses Cache ebenfalls unnÃ¶tig.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Die Verwendung von Ã¼ber einen Aufruf hinausgehenden Cache ist deshalb zu vermeiden.
Falls aufgrund spezieller Anforderungen trotzdem ein 2nd Level Cache benÃ¶tigt wird, ist auf folgende Punkte zu achten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FÃ¼r den Cache ist eine gesonderte Cache-Region zu verwenden.</p>
</li>
<li>
<p>Nur unverÃ¤nderliche Daten dÃ¼rfen in den Cache.</p>
</li>
<li>
<p>Man kann nicht davon ausgehen, dass der Cache bei Ã„nderungen der Objekte aktualisiert wird.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="nutzung-und-anbindung-einer-zweiten-datenbank"><a class="anchor" href="#nutzung-und-anbindung-einer-zweiten-datenbank"></a>7.9. Nutzung und Anbindung einer zweiten Datenbank</h3>
<div class="paragraph">
<p>Einige AnwendungsfÃ¤lle machen es notwendig, eine zweite Datenbank zu nutzen.
Das ist beispielsweise notwendig, wenn Daten aus einem Altsystem Ã¼ber die Datenbank fÃ¼r andere Systeme bereitgestellt werden und diese Daten in eine IsyFact-Anwendung Ã¼ber einen Batch importiert werden sollen.
Der Batch muss dann sowohl auf die Datenbank der IsyFact-Anwendung, als auch auf die Datenbank des Altsystems zugreifen.</p>
</div>
<div class="paragraph">
<p>Die Anbindung einer zweiten Datenbank erfolgt analog zur Anbindung der primÃ¤ren Datenbank Ã¼ber Spring und die Nutzung Ã¼ber JPA, die in Kapitel <a href="#konfiguration-von-jpa-ueber-spring-beans-durchfuehren">Konfiguration von JPA Ã¼ber Spring Beans durchfÃ¼hren</a> beschrieben ist.
Dabei erfolgt der Zugriff auf die zweite Datenbank getrennt Ã¼ber einen weiteren Entity Manager und eine weitere Data Source.</p>
</div>
<div class="paragraph">
<p>Die Beans fÃ¼r die <code>EntityManagerFactory</code> und den <code>TransactionManager</code> mÃ¼ssen manuell konfiguriert werden <a href="#listing-datasource1">Listing 12</a>.
Als <code>DataSource</code> wird hier die von <code>isy-persistence</code> automatisch konfigurierte <code>appDataSource</code> verwendet.</p>
</div>
<div id="listing-datasource1" class="listingblock">
<div class="title">Listing 12. Konfiguration der ersten DataSource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableJpaRepositories(basePackages = "de.beispiel.zweidatasources.persistence", entityManagerFactoryRef = "entityManagerFactoryApp", transactionManagerRef = "transactionManagerApp")
public class PersistenceConfig {

    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactoryApp(@Qualifier("appDataSource") DataSource dataSource) {
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setPackagesToScan("de.beispiel.zweidatasource.persistence");
        em.setDataSource(dataSource);
        em.setJpaDialect(new HibernateJpaDialect());

        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();
        vendorAdapter.setGenerateDdl(true);
        vendorAdapter.setDatabase(Database.ORACLE);
        vendorAdapter.setShowSql(false);
        em.setJpaVendorAdapter(vendorAdapter);

        return em;
    }

    @Bean
    public PlatformTransactionManager transactionManagerApp(@Qualifier("entityManagerFactory") EntityManagerFactory entityManagerFactory) {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory);
        return transactionManager;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>FÃ¼r die zweite Datenbankanbindung wird eine weitere Konfiguration angelegt <a href="#listing-datasource2">Listing 13</a>.</p>
</div>
<div id="listing-datasource2" class="listingblock">
<div class="title">Listing 13. Konfiguration der zweiten DataSource</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
@EnableJpaRepositories(basePackages = "de.beispiel.zweidatasources.persistencesec", entityManagerFactoryRef = "entityManagerFactorySec", transactionManagerRef = "transactionManagerSec")
public class Persistence2Config {

    @Autowired
    private Environment env;

    @Bean
    public DataSource dataSourceSec() {
        JdbcDataSource dataSource = new JdbcDataSource();
        dataSource.setUrl(env.getProperty("datasource.second.url"));

        return dataSource;
    }

    @Bean
    public LocalContainerEntityManagerFactoryBean entityManagerFactorySec(@Qualifier("dataSourceSec") DataSource dataSource) {
        LocalContainerEntityManagerFactoryBean em = new LocalContainerEntityManagerFactoryBean();
        em.setPackagesToScan("de.beispiel.zweidatasource.persistencesec");
        em.setDataSource(dataSource);
        em.setJpaDialect(new HibernateJpaDialect());

        HibernateJpaVendorAdapter vendorAdapter = new HibernateJpaVendorAdapter();
        vendorAdapter.setGenerateDdl(true);
        vendorAdapter.setDatabase(Database.H2);
        vendorAdapter.setShowSql(false);
        em.setJpaVendorAdapter(vendorAdapter);

        return em;
    }

    @Bean
    public PlatformTransactionManager transactionManagerSec(@Qualifier("entityManagerFactorySecc") EntityManagerFactory entityManagerFactory) {
        JpaTransactionManager transactionManager = new JpaTransactionManager();
        transactionManager.setEntityManagerFactory(entityManagerFactory);
        return transactionManager;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Die Datei <code>application.properties</code> wird um den neuen Konfigurationsparameter <code>datasource.second.url</code> fÃ¼r die zweite Datenbankverbindung erweitert.</p>
</div>
</div>
<div class="sect2">
<h3 id="konfiguration-der-id-und-sequenz"><a class="anchor" href="#konfiguration-der-id-und-sequenz"></a>7.10. Konfiguration der ID und Sequenz</h3>
<div class="paragraph">
<p>PrimÃ¤rschlÃ¼ssel werden in JPA mittels der <code>@Id</code> und <code>@GeneratedValue</code> Annotation markiert.
Der <code>GenerationType</code> der <code>@GeneratedValue</code> Annotation muss in jedem Fall <code>AUTO</code> sein.
Als Generator kommt unter Oracle ein <code>@SequenceGenerator</code> zum Einsatz, der eine Datenbanksequenz benutzt.</p>
</div>
<div class="paragraph">
<p>Es muss unbedingt darauf geachtet werden, die Inkrementierung (<code>INCREMENT BY</code>) der zur ID-Generierung genutzt Datenbanksequenz auf denselben Wert einzustellen, der auch beim JPA <code>SequenceGenerator</code> mit <code>allocationSize</code> angegeben ist.</p>
</div>
<div class="paragraph">
<p>Ein Konfigurationsbeispiel kann folgendermaÃŸen aussehen:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Id
@GeneratedValue(strategy=GenerationType.AUTO, generator="my_seq")
@SequenceGenerator(name="my_seq",sequenceName="MY_SEQ", allocationSize=50)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="historisierung"><a class="anchor" href="#historisierung"></a>8. Historisierung</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="grundlagen"><a class="anchor" href="#grundlagen"></a>8.1. Grundlagen</h3>
<div class="paragraph">
<p>Unter Historisierung (auch <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-Temporale-Datenhaltung" class="xref page">temporale Datenhaltung</a> genannt) versteht man das Festhalten der zeitlichen Entwicklung von Daten durch Speichern in einer Datenbank.
Bei den DatensÃ¤tzen gibt es zwei relevante Aspekte: den GÃ¼ltigkeitszeitraum eines Datensatzes und den Bearbeitungszeitpunkt eines Datensatzes.</p>
</div>
<div class="paragraph">
<p>Der GÃ¼ltigkeitszeitraum gibt an, wie lange ein Datensatz gÃ¼ltig ist.
WÃ¤hrend der Beginn des GÃ¼ltigkeitszeitraumes meistens genau bekannt ist, so kann das Ende der GÃ¼ltigkeit so lange unbekannt sein, bis der Datensatz ungÃ¼ltig wird.
Beispiel: Der Preis einer Ware oder Dienstleistung ist so lange gÃ¼ltig, bis er neu festgelegt wird.</p>
</div>
<div class="paragraph">
<p>Der Bearbeitungszeitpunkt definiert den Zeitpunkt wann eine Entscheidung getroffen wurde und ist in vielen FÃ¤llen identisch mit dem Beginn des GÃ¼ltigkeitszeitraumes , kann jedoch auch davon abweichen, wenn z.Â B. fÃ¼r eine Ware eine PreisÃ¤nderung zu einem bestimmten Datum im Voraus festgelegt wird.</p>
</div>
<div class="paragraph">
<p>Eine Historisierung von DatensÃ¤tzen wird durchgefÃ¼hrt, wenn Fragen Ã¼ber den Wert eines Datensatzes zu einem vergangenen Zeitpunkt beantwortet werden mÃ¼ssen (z.Â B. Was kostete X zum Zeitpunkt Y), oder wenn der Verlauf eines Wertes Ã¼ber die Zeit beobachtet werden muss (z.Â B. Wann und warum wurde welche Ã„nderung durchgefÃ¼hrt).</p>
</div>
<div class="sect3">
<h4 id="abgrenzung-archivierung"><a class="anchor" href="#abgrenzung-archivierung"></a>8.1.1. Abgrenzung Archivierung</h4>
<div class="paragraph">
<p>Bei der Archivierung handelt es sich um die Aufbewahrung eines Datensatzes Ã¼ber eine lÃ¤ngere Zeit.
Dies ist meist aus rechtlichen GrÃ¼nden notwendig z.Â B. wegen gesetzlicher Aufbewahrungsfristen.
Bei der Archivierung sind dementsprechend Randbedingungen wie IntegritÃ¤t, UnverÃ¤nderlichkeit und Vertraulichkeit einzuhalten <a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-IT-Grundschutz-BSI" class="xref page">IT-Grundschutz BSI</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="abgrenzung-datensicherung-backup"><a class="anchor" href="#abgrenzung-datensicherung-backup"></a>8.1.2. Abgrenzung Datensicherung (Backup)</h4>
<div class="paragraph">
<p>Bei der Datensicherung handelt es sich um das redundante Aufbewahren von DatensÃ¤tzen.
Das Ziel ist es, bei Verlust oder ungewÃ¼nschter Manipulation von DatensÃ¤tzen diese DatensÃ¤tze auf den gespeicherten Stand zurÃ¼cksetzen zu kÃ¶nnen.</p>
</div>
</div>
<div class="sect3">
<h4 id="abgrenzung-protokollierung"><a class="anchor" href="#abgrenzung-protokollierung"></a>8.1.3. Abgrenzung Protokollierung</h4>
<div class="paragraph">
<p>Ziel der Protokollierung ist das Nachvollziehen von Ã„nderungen und AuskÃ¼nften.
Dazu werden je nach Bedarf die SuchschlÃ¼ssel und Nettodaten von Aufrufen gespeichert.</p>
</div>
</div>
<div class="sect3">
<h4 id="abgrenzung-logging"><a class="anchor" href="#abgrenzung-logging"></a>8.1.4. Abgrenzung Logging</h4>
<div class="paragraph">
<p>Beim Logging werden Notizen zu technischen Aufrufen innerhalb eines Systems oder zwischen Anwendungen in Dateien abgelegt.
Das Logging hat einen technischen Fokus und dient in der Regel als Hilfsinstrument zur Fehlerbehebung.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="anforderungen-1"><a class="anchor" href="#anforderungen-1"></a>8.2. Anforderungen</h3>
<div class="paragraph">
<p>Die beabsichtigte Nutzung der Historisierung lÃ¤sst sich mit Blick auf die Referenzarchitektur zu Anforderungen  verallgemeinern, die in diesem Abschnitt dargestellt werden.</p>
</div>
<div class="paragraph">
<p>FÃ¼r die Historisierung von DatensÃ¤tzen in einer Anwendung gelten folgende Anforderungen und GrundsÃ¤tze:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Es dÃ¼rfen nur solche Daten historisiert werden, die auch angezeigt werden.</p>
</li>
<li>
<p>Die Speicherung von historischen Daten wird durch individuelle LÃ¶schfristen von DatensÃ¤tzen begrenzt.</p>
</li>
<li>
<p>DatensÃ¤tze mÃ¼ssen beim Eintreten bestimmter Ereignisse komplett inklusive aller historisierten DatensÃ¤tze gelÃ¶scht werden.</p>
</li>
<li>
<p>FÃ¼r die meisten Daten ist eine Historisierung weder notwendig noch erlaubt.
Dies ist durch Vorgaben des Datenschutzes und der Geheimhaltung begrÃ¼ndet.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Diese Anforderungen fÃ¼hren zu folgenden Festlegungen:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Eine automatische Historisierung von Daten, bei der jeder Datensatz in mehreren Versionen vorgehalten ist, wird nicht realisiert.</p>
</li>
<li>
<p>Sollte es fachlich gewÃ¼nscht sein, so wird explizit fÃ¼r die betroffenen DatensÃ¤tze ein Historienverwalter implementiert, dessen Aufgabe die Historisierung von DatensÃ¤tzen ist.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Die Referenzarchitektur dieses Historienverwalters ist im folgenden Kapitel beschrieben.</p>
</div>
</div>
<div class="sect2">
<h3 id="architektur-fuer-die-umsetzung-von-historisierung"><a class="anchor" href="#architektur-fuer-die-umsetzung-von-historisierung"></a>8.3. Architektur fÃ¼r die Umsetzung von Historisierung</h3>
<div class="paragraph">
<p>In diesem Kapitel wird beschrieben, wie die technische Umsetzung der Historisierung erfolgt.
Dabei werden die beiden in Kapitel <a href="#grundlagen">Grundlagen</a> eingefÃ¼hrten Aspekte der Historisierung â€žGÃ¼ltigkeitszeitraumâ€œ
und â€žVerlauf der Bearbeitungâ€œ getrennt beschrieben, wobei der zweite Aspekt aufwÃ¤ndiger umzusetzen ist und daher den GroÃŸteil des Kapitels einnimmt.</p>
</div>
<div class="sect3">
<h4 id="abbildung-eines-gueltigkeitszeitraums"><a class="anchor" href="#abbildung-eines-gueltigkeitszeitraums"></a>8.3.1. Abbildung eines GÃ¼ltigkeitszeitraums</h4>
<div class="paragraph">
<p>Manche Daten haben einen Zeitbezug, d.Â h. der Inhalt eines Datensatzes bezieht sich nur auf einen bestimmten Zeitraum.
Man mÃ¶chte z.Â B. beschreiben, dass fÃ¼r eine Ware in einem bestimmten Zeitraum ein Rabatt gewÃ¤hrt wird.
Um einen solchen GÃ¼ltigkeitszeitraum abzubilden, werden zu dem ursprÃ¼nglichen Datensatz zwei zusÃ¤tzliche Datumsattribute ergÃ¤nzt.
Falls diese Datumsattribute bereits fachlich etablierte Namen haben, werden diese genutzt.
Sonst werden die Namen <code>gueltigVon</code> und <code>gueltigBis</code> benutzt.
Diese Attribute werden durch die Anwendung genauso gepflegt wie alle anderen Attribute des Datensatzes auch.</p>
</div>
</div>
<div class="sect3">
<h4 id="abbildung-der-historie-der-bearbeitung"><a class="anchor" href="#abbildung-der-historie-der-bearbeitung"></a>8.3.2. Abbildung der Historie der Bearbeitung</h4>
<div class="paragraph">
<p>In diesem Abschnitt wird beschrieben, wie die Historie der Bearbeitung gepflegt werden soll, z.Â B. wenn die letzten zehn Ã„nderungen zu einem Datensatz abgespeichert werden sollen.
Dazu wird zunÃ¤chst beschrieben, wie die prinzipielle Herangehensweise dazu ist.
AnschlieÃŸend wird dies durch Angabe eines Entwurfsmusters prÃ¤zisiert.</p>
</div>
<div class="paragraph">
<p>Die grundlegenden Prinzipien bei der technischen Abbildung sind die, dass Historisierung explizit durchgefÃ¼hrt wird, dass die Nutzungsvorgabe in Form eines Patterns erfolgt und dass die HistorisierungslÃ¶sung konsistent mit den bereits getroffenen Festlegungen zur Persistenz sein soll.</p>
</div>
<div class="paragraph">
<p><strong>Explizite Historisierung:</strong> Die Historisierung der Bearbeitung erfolgt explizit, d.Â h. die zu historisierenden Daten werden durch die Anwendungslogik gepflegt und persistiert.</p>
</div>
<div class="paragraph">
<p>Theoretisch wÃ¤re es auch mÃ¶glich, eine solche Historisierung auf der Ebene der Datenbankzugriffsschicht durchzufÃ¼hren.
Dazu wÃ¼rden dann in der Datenbankzugriffschicht die <code>UPDATE</code>-Statements durch <code>INSERT</code>-Statements ersetzt.
Die Daten der <code>INSERT</code>-Statements wÃ¼rden dann durch einen Zeitstempel ergÃ¤nzt.
Beim <code>SELECT</code> wÃ¼rde immer der aktuellste Datensatz geliefert werden.
Dieses Vorgehen lohnt sich aber nicht, da nur sehr wenige DatensÃ¤tze historisiert werden sollen und ebenso widerspricht es der Anforderung, dass keine Daten gespeichert werden sollen, die nicht auch angezeigt werden.
Sinnvoll wÃ¤re ein solches Vorgehen dann, wenn Ã¼ber die Historisierung eine Nachvollziehbarkeit der Ã„nderungen erreicht werden soll.
Dies ist im Rahmen der Referenzarchitektur aber explizit die Aufgabe der Protokollierung.</p>
</div>
<div class="paragraph">
<p><strong>Historisierung durch Vorgabe eines Patterns:</strong> Die beschriebene HistorisierungsfunktionalitÃ¤t lÃ¤sst sich nur schwer in der Form von Bibliotheken mit abstrakten Oberklassen, Interfaces und Ã¤hnlichem abbilden.
Die dadurch entstehenden Java-Konstrukte wÃ¤ren nur sehr sperrig zu nutzen und wÃ¼rden die Entwicklung eher behindern als beschleunigen.
Deshalb wird in diesem Dokument ein Entwurfsmuster vorgegeben, nach dem die Historisierung zu erfolgen hat.
Diese Entwurfsmuster sind fÃ¼r den Entwickler leichter zu handhaben.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vorgehen-zur-historisierung-der-bearbeitung"><a class="anchor" href="#vorgehen-zur-historisierung-der-bearbeitung"></a>8.4. Vorgehen zur Historisierung der Bearbeitung</h3>
<div class="sect3">
<h4 id="schritt-1-ergaenzen-von-datumsattributen"><a class="anchor" href="#schritt-1-ergaenzen-von-datumsattributen"></a>8.4.1. Schritt 1: ErgÃ¤nzen von Datumsattributen</h4>
<div class="paragraph">
<p>Historisierte Versionen und die aktuelle Version eines Datensatzes werden in der gleichen Tabelle gepflegt.
Dazu wird die Tabelle um zwei neue Datumsattribute erweitert: <code>aktuellVon</code> und <code>aktuellBis</code>.
Der aktuell gÃ¼ltige Datensatz ist somit der mit dem neuesten <code>aktuellVon</code>-Datum.
Das <code>aktuellBis</code>-Datum vereinfacht den Zugriff auf die Tabelle per SQL.
Es wird dadurch einfacher, den Datensatz zu finden, der zu einem bestimmten Datum aktuell war.
Das Attribut <code>aktuellBis</code> des aktuellen Datensatzes wird per Konvention auf das Datum 31.12.9999 gesetzt.
Damit kann dieses Attribut zur Ermittlung des aktuellen Datensatzes genutzt werden.
Der Chefdesigner eines Projekts kann festlegen, dass dieses Attribut Teil des SchlÃ¼ssels ist.
Dadurch ist es mÃ¶glich, die Tabelle der Datenbank zu partitionieren, um die Verarbeitungsgeschwindigkeit zu erhÃ¶hen.</p>
</div>
<div class="paragraph">
<p>In AusnahmefÃ¤llen darf auch eine eigene Tabelle zur Speicherung der Historie angelegt werden.
Dies muss der Chefdesigner eines Projekts entscheiden.
Dabei ist zu beachten, dass dadurch der Datenzugriff verlangsamt wird, da in diesem Fall immer zwei Tabellen statt einer geschrieben werden.</p>
</div>
<div class="paragraph">
<p>Durch das EinfÃ¼hren der Datumsattribute erweitert sich der fachliche SchlÃ¼ssel des Datensatzes.
Der somit aus mehreren Attributen zusammengesetzte fachliche SchlÃ¼ssel wird genauso behandelt, wie jeder andere zusammengesetzte fachliche SchlÃ¼ssel auch.</p>
</div>
</div>
<div class="sect3">
<h4 id="schritt-2-erweiterung-des-daos"><a class="anchor" href="#schritt-2-erweiterung-des-daos"></a>8.4.2. Schritt 2: Erweiterung des DAOs</h4>
<div class="paragraph">
<p>Alle Datenzugriffe auf zu persistierende Objekte (Entities) werden Ã¼ber das zugehÃ¶rige DAO (Data Access Object) vorgenommen.
Insbesondere muss das DAO auch dafÃ¼r sorgen, dass die Attribute <code>aktuellVon</code> und <code>aktuellBis</code> mit den korrekten Werten belegt sind.</p>
</div>
<div class="paragraph">
<p>Das auf die EntitÃ¤t bezogene DAO wird wie folgt angepasst und erweitert:</p>
</div>
<div class="sect4">
<h5 id="_erstelle_neue_methode_lesen_der_zu_dem_datum_gÃ¼ltigen_entitÃ¤t"><a class="anchor" href="#_erstelle_neue_methode_lesen_der_zu_dem_datum_gÃ¼ltigen_entitÃ¤t"></a>8.4.2.1. Erstelle neue Methode: Lesen der zu dem Datum gÃ¼ltigen EntitÃ¤t</h5>
<div class="paragraph">
<p>Die Funkion liefert die zu dem Ã¼bergebenen Zeitpunkt (Parameter calendar) gÃ¼ltige EntitÃ¤t.</p>
</div>
<table id="table-dao-ext-lese-valid-entity-by-date" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 4. DAO: Erweiterung: Lesen der zu dem Datum gÃ¼ltigen EntitÃ¤t</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">DAO: Erweiterung: Lesen der zu dem Datum gÃ¼ltigen EntitÃ¤t</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;Entity&gt; lese&lt;Entity&gt;(&lt;Schluessel&gt;, Calendar)`</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AkteDao leseAkte(id, Calendar)</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_Ã¤ndern_der_methode_xyz_lese_xyzschluessel"><a class="anchor" href="#_Ã¤ndern_der_methode_xyz_lese_xyzschluessel"></a>8.4.2.2. Ã„ndern der Methode <code>Xyz lese Xyz(Schluessel)</code></h5>
<div class="paragraph">
<p>Diese Methode ist im DAO bereits vorhanden.
Sie wird so angepasst, dass sie das aktuell gÃ¼ltige Objekt zurÃ¼ckgibt.
Dies ist das Objekt mit den Ã¼bergebenen SchlÃ¼sselattributen, dessen <code>aktuellBis</code>-Eintrag der 31.12.9999 ist.</p>
</div>
<table id="table-dao-ext-lese-current-valid-entity" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 5. Data Access Objects: Anpassung: Lesen der aktuell gÃ¼ltigen EntitÃ¤t</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Data Access Objects: Anpassung: Lesen der aktuell gÃ¼ltigen EntitÃ¤t</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>&lt;Entity&gt; lese&lt;Entity&gt;(&lt;Schluessel&gt;)`</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AkteDao  leseAkte(id)</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_erstellen_einer_neuen_methode_listxyz_lesexyzhistorieschluessel"><a class="anchor" href="#_erstellen_einer_neuen_methode_listxyz_lesexyzhistorieschluessel"></a>8.4.2.3. Erstellen einer neuen Methode <code>List&lt;Xyz&gt; leseXyzHistorie(Schluessel)</code></h5>
<div class="paragraph">
<p>Diese Methode liefert die gesamte Historie eines Datensatzes.</p>
</div>
<table id="table-dao-ext-lese-Historie-von-entitaet" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 6. Data Access Objects: Erweiterung: Lesen der Historie einer EntitÃ¤t</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Data Access Objects: Erweiterung: Lesen der Historie einer EntitÃ¤t</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List&lt;EntitÃ¤t&gt; lese&lt;EnititÃ¤t&gt;Historie(Schluessel)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>List&lt;AkteDao&gt; leseAkteHistorie(id)</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_erstellen_einer_neuen_methode_xyz_erzeugeneueversionxyz"><a class="anchor" href="#_erstellen_einer_neuen_methode_xyz_erzeugeneueversionxyz"></a>8.4.2.4. Erstellen einer neuen Methode <code>Xyz erzeugeNeueVersion(Xyz)</code></h5>
<div class="paragraph">
<p>Bei einer Umsetzung ohne Historisierung konnten Objekte direkt Ã¼ber ihren Konstruktor erzeugt werden
und mithilfe der Methode <code>speichereXyz(Xyz)</code> persistiert werden.
Dies ist jetzt nicht mehr mÃ¶glich, da in diesem Fall die Attribute <code>aktuellVon</code> und <code>aktuellBis</code> nicht korrekt belegt
werden wÃ¼rden.
Daher bietet das DAO eine Methode an, um auf Basis eines bestehenden Objekts eine neue Version dieses Objekts zu erstellen.</p>
</div>
<div class="paragraph">
<p>Die Idee dabei ist, dass das bisher aktuelle Objekt einen Nachfolger erhÃ¤lt.</p>
</div>
<table id="table-dao-neue-methode" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 7. Data Access Objects: Erweiterung: Erzeugen einer neuen Version einer EntitÃ¤t</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Data Access Objects: Erweiterung: Erzeugen einer neuen Version einer EntitÃ¤t</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>EntitÃ¤t erzeugeNeueVersion(EntitÃ¤t)</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Beispiele</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AkteDao leseAkteHistorie(AkteDao)</code></p></td>
</tr>
</tbody>
</table>
<table id="table-dao-max-anzahl" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 8. Data Access Objects: optionale Erweiterung: Maximale Anzahl der gespeicherten Versionen</caption>
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top" colspan="2">Data Access Objects: optionale Erweiterung: Maximale Anzahl der gespeicherten Versionen</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Schema</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MAX_EINTRAEGE_HISTORIE</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Beim bisher aktuellen Objekt wird vermerkt, dass es nicht mehr aktuell ist und das neu erzeugte Objekt wird als aktuelles Objekt gekennzeichnet.
Im Detail werden dabei die folgenden Schritte durchgefÃ¼hrt:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Ausgangslage: Das bisher aktuelle Objekt wird als Parameter Ã¼bergeben.</p>
</li>
<li>
<p>SchrittÂ 1: Der Zeitstempel des Ã¼bergebenen Objekts wird verÃ¤ndert und damit dieses Objekt als nicht mehr aktuell markiert.
Das Ã¼bergebene Objekt ist das bisher aktuelle Objekt, der Zeitstempel <code>aktuellBis</code> war bisher auf den 31.12.9999 gesetzt.
Dieser Zeitstempel wird auf den aktuellen Zeitstempel gesetzt.</p>
</li>
<li>
<p>SchrittÂ 2: Es wird ein neues Objekt <code>Xyz</code> erzeugt.</p>
</li>
<li>
<p>SchrittÂ 3: Der Zeitstempel <code>aktuellVon</code> des neu erzeugten Objekts wird auf den aktuellen Zeitstempel gesetzt.</p>
</li>
<li>
<p>SchrittÂ 4: Die Daten des Ã¼bergebenen Objekts werden in das aktuelle Objekt kopiert.</p>
</li>
<li>
<p>SchrittÂ 5: Der Zeitstempel <code>aktuellBis</code> wird auf den 31.12.9999 gesetzt. Damit ist es als das aktuelle Objekt gekennzeichnet.</p>
</li>
<li>
<p>SchrittÂ 6: Das neue Objekt wird in der Session des Persistenzmanagers registriert, damit es beim spÃ¤teren <code>commit</code> persistiert wird.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Als Parameter der Methode darf auch <code>null</code> Ã¼bergeben werden.
In diesem Fall wird ein neuer, leerer Datensatz angelegt, dessen Zeitstempel aber korrekt befÃ¼llt sind.
Dies ist nÃ¶tig, um das erste Objekt einer Historie erzeugen zu kÃ¶nnen.</p>
</div>
<div class="paragraph">
<p>Nach konkretem Bedarf kann die Methode <code>&lt;EntitÃ¤t&gt; erzeugeNeueVersion(EntitÃ¤t)</code> auch noch durch zusÃ¤tzliche â€žconvenienceâ€œ-Methoden ergÃ¤nzt werden, die andere Parameter erwarten, z.Â B. durch eine Methode, die als Parameter nur die SchlÃ¼sselwerte des Objekts und nicht das Objekt selbst erwartet oder durch eine Methode, die die aktuellste Version eines Datensatzes selber ermittelt.</p>
</div>
<div class="paragraph">
<p><strong>Optionale Erweiterungen:</strong> Falls eine Obergrenze fÃ¼r die Anzahl der zu historisierenden DatensÃ¤tze vorgegeben ist, wird die Einhaltung dieser Obergrenze ebenfalls durch das DAO sichergestellt.
In diesem Fall wird bei der Erzeugung einer neuen Version geprÃ¼ft, ob dadurch die Obergrenze Ã¼berschritten wird und ggf. die Ã¤lteste Version gelÃ¶scht.
Der Wert dieser Obergrenze wird in einer Klassenkonstante des DAOs gehalten.
Diese Klassenkonstante ist <code>public</code>, damit deren Wert bei einer VerÃ¤nderung der Historie auÃŸerhalb des DAOs berÃ¼cksichtigt werden kann.
Sie trÃ¤gt den Namen <code>MAX_EINTRAEGE_HISTORIE</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_lÃ¶schen_der_methode_void_speicherexyzxyz"><a class="anchor" href="#_lÃ¶schen_der_methode_void_speicherexyzxyz"></a>8.4.2.5. LÃ¶schen der Methode <code>void speichereXyz(Xyz)</code></h5>
<div class="paragraph">
<p>Es ist nicht mehr mÃ¶glich, ein neues Objekt zu erzeugen und direkt in der Datenbank zu speichern und damit die Historisierung zu umgehen.</p>
</div>
<div class="paragraph">
<p>Es wurden in der Schnittstelle des DAOs bewusst keine Funktionen vorgesehen, um die Historie verÃ¤ndern zu kÃ¶nnen.
Der Regelfall ist der, dass die Zeitstempel automatisch durch den Historienverwalter gesetzt werden und die Historie nicht mehr verÃ¤ndert wird.</p>
</div>
<div class="paragraph">
<p>Eine VerÃ¤nderung der Historie ist technisch nicht ausgeschlossen, dies kann direkt durch die Bearbeitung der historisierten DatensÃ¤tze geschehen.
Dies ist allerdings ein fachlicher Ausnahmefall.
Im Regelfall darf die Historie nicht verÃ¤ndert werden.
Ã„nderungen der Historie dÃ¼rfen nur in Abstimmung mit den fachlichen Chefarchitekten vorgenommen werden.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="beispiel"><a class="anchor" href="#beispiel"></a>8.4.3. Beispiel</h4>
<div class="paragraph">
<p>Das fachliche Szenario fÃ¼r dieses Beispiel ist das Folgende: Der Bestand einer CD soll historisiert werden.</p>
</div>
<div class="paragraph">
<p>Schritt 1: ErgÃ¤nzen von Datumsattributen</p>
</div>
<div class="paragraph">
<p>Der Bestand der CDs ist ohne Historisierung wie in <a href="#image-BestandCDoH">Abbildung 2</a> modelliert.</p>
</div>
<div id="image-BestandCDoH" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/BestandCDoH.png" alt="BestandCDoH" width="70%">
</div>
<div class="title">Abbildung 3. Modellierung des Bestands ohne Historisierung</div>
</div>
<div class="paragraph">
<p>Es gibt eine EntitÃ¤t <code>CD</code>, die eine konkrete CD reprÃ¤sentiert.
Der SchlÃ¼ssel dieser <code>CD</code> ist die <code>isbn</code>.
Der Bestand dieser CD wird in einer separaten EntitÃ¤t Bestand vorgehalten.
Die Relation zwischen <code>Bestand</code> und <code>CD</code> ist eine 1:1-Relation.
Eventuell kÃ¶nnte diese Relation in der Datenbank so modelliert werden, dass sowohl <code>Bestand</code> als auch <code>CD</code> in einer Tabelle zusammengefasst sind.
Um den Bestand historisierbar zu machen, mÃ¼sste diese Tabelle in zwei Tabellen zerlegt werden.</p>
</div>
<div class="paragraph">
<p>In die EntitÃ¤t Bestand werden die Attribute <code>aktuellVon</code> und <code>aktuellBis</code> eingefÃ¼gt.
Dies ist in <a href="#image-BestandCD">Abbildung 3</a> dargestellt.</p>
</div>
<div id="image-BestandCD" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/BestandCD.png" alt="BestandCD" width="70%">
</div>
<div class="title">Abbildung 4. Modellierung des Bestands mit Historisierung</div>
</div>
<div class="paragraph">
<p>Schritt 2: Erweiterung des DAOs</p>
</div>
<div class="paragraph">
<p>Das DAO fÃ¼r die EntitÃ¤t Bestand ohne Historisierung ist in <a href="#image-BestandDaooFzH">Abbildung 4</a> dargestellt.</p>
</div>
<div id="image-BestandDaooFzH" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/BestandDaooFzH.png" alt="BestandDaooFzH" width="50%">
</div>
<div class="title">Abbildung 5. BestandDao ohne Funktionen zur Historisierung</div>
</div>
<div class="paragraph">
<p>Um ein neues Objekt Bestand zu persistieren, wird eine Instanz von Bestand erzeugt und anschlieÃŸend <code>speichereBestand(Bestand)</code> aufgerufen.
Die Methode <code>leseBestand(String)</code> liest den Bestand einer CD, die durch den Ã¼bergebenen String (die isbn) identifiziert wird.
Die Methode <code>loescheBestand(Bestand)</code> lÃ¶scht den Datensatz aus der Datenbank.
Um den Bestand historisierbar zu machen, werden die folgenden Erweiterungen vorgenommen, die in <a href="#image-BestandDao">Abbildung 5</a> dargestellt sind.</p>
</div>
<div id="image-BestandDao" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/BestandDao.png" alt="BestandDao" width="50%">
</div>
<div class="title">Abbildung 6. BestandDao mit Erweiterungen fÃ¼r Historisierung</div>
</div>
<div class="paragraph">
<p>Die Methode <code>erzeugeNeueVersionBestand(Bestand)</code> wurde eingefÃ¼gt.</p>
</div>
<div class="paragraph">
<p>Die Methode <code>leseBestand(String, Calendar)</code> wurde eingefÃ¼gt.</p>
</div>
<div class="paragraph">
<p>Die Methode <code>leseBestand(String)</code> wurde geÃ¤ndert, sodass der aktuelle Datensatz geliefert wird.</p>
</div>
<div class="paragraph">
<p>Die Methode <code>leseBestandHistorie(String)</code> wurde eingefÃ¼gt.</p>
</div>
<div class="paragraph">
<p>Die Methode <code>speichereBestand(Bestand)</code> wurde entfernt.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="erstellung-von-datenbankschemas"><a class="anchor" href="#erstellung-von-datenbankschemas"></a>9. Erstellung von Datenbankschemas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In diesem Kapitel werden Vorgaben fÃ¼r die Erstellung von Datenbankschemas erlÃ¤utert.</p>
</div>
<div class="sect2">
<h3 id="namenskonventionen-von-datenbankschemas"><a class="anchor" href="#namenskonventionen-von-datenbankschemas"></a>9.1. Namenskonventionen</h3>
<div class="paragraph">
<p>FÃ¼r die Benennung von Datenbankschemas sind folgende EinschrÃ¤nkungen zu beachten:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>VollstÃ¤ndige, beschreibende, aussprechbare Namen (oder bekannte AbkÃ¼rzungen).</p>
</li>
<li>
<p>Der Name eines Datenbankschemas muss mit einem Buchstaben beginnen.</p>
</li>
<li>
<p>Es dÃ¼rfen nur Buchstaben, Zahlen und Unterstriche (_) im Namen enthalten sein.</p>
</li>
<li>
<p>Umlaute, Sonderzeichen, Bindestriche und Leerzeichen sind nicht erlaubt.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="versionierung-von-datenbankschemas"><a class="anchor" href="#versionierung-von-datenbankschemas"></a>10. Versionierung von Datenbankschemas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Die Struktur der Daten, die von einer Anwendung dauerhaft gespeichert werden, kann sich im Laufe des Lebenszyklus der Anwendung Ã¤ndern.
Das bedeutet, dass sich neben der Anwendung auch das Datenbankschema Ã¤ndert.
Die Anwendung und das Datenbankschema mÃ¼ssen zueinander passen.</p>
</div>
<div class="paragraph">
<p>Die Verwaltung von Versionsinformationen fÃ¼r ein Datenbankschema innerhalb der Datenbank soll sicherstellen, dass die Anwendung und Datenmigrationsskripte erkennen kÃ¶nnen, ob ein Datenbankschema die erwartete Version hat.
ZusÃ¤tzlich sollen die Datenbankadministratoren nachvollziehen kÃ¶nnen, welche Ã„nderungen am Datenbankschema bereits erfolgt sind.</p>
</div>
<div class="paragraph">
<p>Die Versionsnummer eines Datenbankschemas ist gleich der Versionsnummer der Anwendung, mit der das Schema angelegt bzw. zuletzt geÃ¤ndert wurde.
Damit ist auf einen Blick zu erkennen, welche Versionsnummer eine Anwendung mindestens haben muss, um mit dem Schema zusammenarbeiten zu kÃ¶nnen.</p>
</div>
<div class="paragraph">
<p>Wird nur eine Anwendung geÃ¤ndert, das Datenbankschema aber nicht, so bleibt die Versionsnummer des Datenbankschemas sowohl in der Anwendung als auch in den Datenbank-Skripten unverÃ¤ndert.
Nur die Versionsnummer der Anwendung selbst wird erhÃ¶ht.</p>
</div>
<div class="paragraph">
<p>ZusÃ¤tzlich wird ein Update-ZÃ¤hler mitgefÃ¼hrt, der jedes Mal hochgezÃ¤hlt wird, wenn sich das Datenbankschema Ã¤ndert, aber die Anwendung unverÃ¤ndert bleibt.
Das ist z.B. dann der Fall, wenn zusÃ¤tzliche Indexe angelegt werden oder Views, die die Anwendung selbst nicht benÃ¶tigt.</p>
</div>
<div class="paragraph">
<p>Im Folgenden wird ein Verfahren festgelegt das diese Anforderungen umsetzt.</p>
</div>
<div class="sect2">
<h3 id="struktur-der-versionsmetadaten"><a class="anchor" href="#struktur-der-versionsmetadaten"></a>10.1. Struktur der Versionsmetadaten</h3>
<div class="paragraph">
<p>Die Informationen Ã¼ber Versionen und durchgefÃ¼hrte Ã„nderungen an einem Datenbankschema werden innerhalb des Schemas in eigenen Metadatentabellen gespeichert.
Hierzu muss jedes Datenbankschema die folgenden Tabellen enthalten.</p>
</div>
<div class="sect3">
<h4 id="tabelle-m_schema_version"><a class="anchor" href="#tabelle-m_schema_version"></a>10.1.1. Tabelle M_SCHEMA_VERSION</h4>
<div class="paragraph">
<p>Die Tabelle M_SCHEMA_VERSION enthÃ¤lt die Information Ã¼ber die aktuelle Version des Schemas.
Die Tabelle hat die folgende Struktur:</p>
</div>
<table id="table-TabMSHEVERS" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 9. Tabelle M_SCHEMA_VERSION</caption>
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 28.5714%;">
<col style="width: 42.8572%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Spalte</th>
<th class="tableblock halign-left valign-top">Typ</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version_nummer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar2(25 char)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Versionsnummer des Datenbankschemas.
Diese Versionsnummer entspricht der Versionsnummer der Anwendung, mit der sich das Schema geÃ¤ndert hat.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>update_nummer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar2(5 char)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update-ZÃ¤hler, der jedes Mal hochgezÃ¤hlt wird, wenn sich das Datenbankschema Ã¤ndert, aber die Anwendung unverÃ¤ndert bleibt.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar2(25 char)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Status des Schemas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>gueltig: Das Schema wurde korrekt installiert bzw. aktualisiert und kann verwendet werden.</p>
</li>
<li>
<p>bereit: Das Schema ist bereit schemaÃ¼bergreifende Operationen durchzufÃ¼hren.</p>
</li>
<li>
<p>ungueltig: Das Schema befindet sich im Aufbau bzw. in der Ã„nderung oder die Installation wurde nur teilweise durchgefÃ¼hrt und wurde mit Fehlern abgebrochen.
Das Schema kann nicht verwendet werden und muss Ã¼berprÃ¼ft werden.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="tabelle-m_schema_log"><a class="anchor" href="#tabelle-m_schema_log"></a>10.1.2. Tabelle M_SCHEMA_LOG</h4>
<div class="paragraph">
<p>Die Tabelle M_SCHEMA_LOG enthÃ¤lt Information Ã¼ber eingespielte Skripte zur Anpassung des Schemas.
Die Tabelle hat die folgende Struktur:</p>
</div>
<table id="table-TabMSHELOG" class="tableblock frame-all grid-all stretch">
<caption class="title">Tabelle 10. Tabelle M_SCHEMA_LOG</caption>
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 28.5714%;">
<col style="width: 42.8572%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Spalte</th>
<th class="tableblock halign-left valign-top">Typ</th>
<th class="tableblock halign-left valign-top">Beschreibung</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schemaversion</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar2(25 char)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Versionsnummer des Schemas, zu dessen Erstellung bzw. Anpassung das Skript genutzt wurde.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schemaupdate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar2(5 char)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Update-ZÃ¤hler, der jedes Mal hochgezÃ¤hlt wird, wenn sich das Datenbankschema Ã¤ndert, aber die Anwendung unverÃ¤ndert bleibt.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>schritt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar2(10 char)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nummer des Schrittes im Installationsablauf.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>beschreibung</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar2(100 char)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Kurzbeschreibung des Installationsschrittes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skript</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar2(100 char)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Name des ausgefÃ¼hrten Skripts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skript_start</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zeitpunkt, an dem das Skript gestartet wurde.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>skript_ende</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Zeitpunkt, an dem das Skript beendet wurde.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>status</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>varchar2(25 char)</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Status der SkriptausfÃ¼hrung:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>wird ausgefÃ¼hrt: Skript wurde gestartet und lÃ¤uft oder wurde abgebrochen</p>
</li>
<li>
<p>erfolgreich: Skript wurde erfolgreich abgearbeitet</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="installationsablauf-bei-der-neuanlage"><a class="anchor" href="#installationsablauf-bei-der-neuanlage"></a>10.2. Installationsablauf bei der Neuanlage</h3>
<div class="paragraph">
<p>Die Neuinstallation eines Datenbankschemas erfolgt in mehreren Schritten, die jeweils aufeinander aufbauen.
FÃ¼r die automatisierte Installation werden diese Schritte von einem Datenbankskript nacheinander durchgefÃ¼hrt.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Schritt 1: Umgebungsvariablen laden</dt>
<dd>
<p>FÃ¼r Testzwecke ist es erforderlich, Datenbankschemas in unterschiedlichen Umgebungen zu installieren.
Umgebungsspezifische Konfigurationsparameter, wie z.Â B. der Schemaname oder die Angaben zur Datenbankverbindung werden in einem eigenen Datenbankskript abgelegt, das Umgebungsvariablen mit den entsprechenden Werten setzt.
Die Ã¼brigen Installationsschritte verwenden dann diese Variablen.</p>
</dd>
<dt class="hdlist1">Schritt 2: Tablespace erstellen</dt>
<dd>
<p>Erstellen aller Tablespaces, die fÃ¼r die Installation der DatenbankÂ­objekte benÃ¶tigt werden.</p>
</dd>
<dt class="hdlist1">Schritt 3: Benutzer anlegen</dt>
<dd>
<p>Anlegen aller Datenbankbenutzer einschlieÃŸlich ihrer Rollen und Berechtigungen.
Mit diesen Benutzern werden die anwendungsspezifischen Datenbankobjekte angelegt.
Es mÃ¼ssen daher alle hierfÃ¼r benÃ¶tigten Rechte fÃ¼r die Dauer der Installation gesetzt werden.</p>
</dd>
<dt class="hdlist1">Schritt 4: Erzeugen der anwendungsspezifischen Datenbankobjekte</dt>
<dd>
<p>Es werden alle Tabellen, Indexe, Views, Prozeduren und Funktionen fÃ¼r die Anwendung angelegt.
Weiterhin werden benÃ¶tigte spezielle Datenbankobjekte, z.Â B. fÃ¼r das Oracle-Advanced-Queuing angelegt.
Die anwendungsspezifischen Datenbankobjekte werden mit den in Schritt 3 angelegten Benutzern erstellt.</p>
</dd>
<dt class="hdlist1">Schritt 5: Abschlussbearbeitung</dt>
<dd>
<p>In diesem Schritt kÃ¶nnen alle Operationen ausgefÃ¼hrt werden, die sich auf die bisher angelegten Datenbankobjekte beziehen.</p>
</dd>
<dt class="hdlist1">Schritt 6: Rechte entziehen</dt>
<dd>
<p>Falls den Benutzern im Schritt 3 Rechte zugewiesen wurden, die nur fÃ¼r die Installation benÃ¶tigt wurden, werden sie in diesem Schritt wieder entzogen.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Die nachfolgende Abbildung zeigt noch einmal die einzelnen Schritte der Installation.</p>
</div>
<div id="image-instbeineuan" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/instbeineuan.png" alt="instbeineuan">
</div>
<div class="title">Abbildung 7. Installationsablauf bei der Neuanlage</div>
</div>
<div class="sect3">
<h4 id="struktur-der-installationsskripte-fuer-die-neuanlage"><a class="anchor" href="#struktur-der-installationsskripte-fuer-die-neuanlage"></a>10.2.1. Struktur der Installationsskripte fÃ¼r die Neuanlage</h4>
<div class="paragraph">
<p>FÃ¼r die automatisierte Installation wird eine Strukturierung der Installationsskripte festgelegt.
Es existieren folgende Aufrufbeziehungen:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Shell-Skripte</dt>
<dd>
<p>Ãœber die Shell-Skripte <code>install-db-schema.bat</code> (Windows) bzw. <code>install-db-schema.sh</code> (Linux) wird das SQL-Skript <code>00_install-main.sql</code> aufgerufen.
Als Parameter werden das Skript fÃ¼r das Anlegen der Umgebungsvariablen und die Log-Datei mitgegeben.</p>
</dd>
<dt class="hdlist1">00_install-main.sql</dt>
<dd>
<p>Das SQL-Skript ruft die eigentlichen Installationsskripte in der richtigen Reihenfolge Ã¼ber das Hilfsskript <code>99_starte-skript-mit-logging.sql</code> nacheinander auf.
Dabei werden auch die Tabellen zur Versionierung angelegt und korrekt gefÃ¼llt.</p>
</dd>
<dt class="hdlist1">99_starte-skript-mit-logging.sql</dt>
<dd>
<p>Das Hilfsskript fÃ¼hrt ein SQL-Skript aus und befÃ¼llt die Versionstabelle korrekt.
Als Parameter werden der Pfad des Skripts, die Schnittnummer inklusiv der Unterschrittnummer und die Beschreibung mit Ã¼bergeben.</p>
</dd>
<dt class="hdlist1">&lt;Installationsskript&gt;.sql</dt>
<dd>
<p>Die eigentlichen Installationsskripte haben das feste Namensschema: <code>&lt;Schrittnummer&gt;-&lt;Unterschrittnummer&gt;_&lt;Name&gt;.sql</code>.
Die Schrittnummer ist 2-stellig und entspricht der Schrittnummer aus Kapitel <a href="#installationsablauf-bei-der-neuanlage">Installationsablauf bei der Neuanlage</a>.
Falls zu einem Schritt mehrere Skripte gehÃ¶ren, gibt die Unterschrittnummer die Reihenfolge an, in der diese ausgefÃ¼hrt werden.
Der Name kann frei vergeben werden, sollte aber sprechend sein.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Die nachfolgende Abbildung zeigt noch einmal die Beziehung zwischen den einzelnen Skripten.</p>
</div>
<div id="image-BezzwischInst" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/BezzwischInst.png" alt="BezzwischInst">
</div>
<div class="title">Abbildung 8. Beziehungen zwischen den Installationsskripten</div>
</div>
<div class="paragraph">
<p>Templates fÃ¼r die Skripte sind als Ressourcen in der Bibliothek <code>isy-persistence</code> abgelegt.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="installationsablauf-bei-der-schemaaenderung"><a class="anchor" href="#installationsablauf-bei-der-schemaaenderung"></a>10.3. Installationsablauf bei der SchemaÃ¤nderung</h3>
<div class="paragraph">
<p>Die Ã„nderung eines Datenbankschemas erfolgt analog zur Neuanlage ebenfalls in mehreren Schritten, die jeweils aufeinander aufbauen.
FÃ¼r die automatisierte Ã„nderung werden diese Schritte von einem Datenbankskript nacheinander durchgefÃ¼hrt.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Schritt 1: Umgebungsvariablen laden</dt>
<dd>
<p>Dieser Schritt unterscheidet sich nicht von der Neuanlage.
Je nach Art der durchzufÃ¼hrenden Ã„nderung kann es aber erforderlich sein, hier weitere Variablen zu setzen.</p>
</dd>
<dt class="hdlist1">Schritt 2: Rechte setzen</dt>
<dd>
<p>Falls erforderlich, werden fÃ¼r den Benutzer, mit dem die Ã„nderungen durchgefÃ¼hrt werden sollen, alle fÃ¼r die Ã„nderung des Datenbankschemas benÃ¶tigten Berechtigungen gesetzt.</p>
</dd>
<dt class="hdlist1">Schritt 3: DurchfÃ¼hren der SchemaÃ¤nderungen</dt>
<dd>
<p>Es werden alle Ã„nderungen am Datenbankschema vorgenommen.
Das umfasst sowohl das Anlegen neuer Datenbankobjekte, wie z.Â B. Tabellen, Views und Indexe, als auch die Ã„nderung bereits vorhandener Datenbankobjekte, wie z.Â B. das LÃ¶schen und HinzufÃ¼gen von Spalten in Tabellen.
Die Ã„nderungen werden mit dem Benutzer durchgefÃ¼hrt, fÃ¼r den in Schritt 2 die Berechtigungen entsprechend gesetzt wurden.</p>
</dd>
<dt class="hdlist1">Schritt 4: Abschlussbearbeitung</dt>
<dd>
<p>In diesem Schritt kÃ¶nnen alle Operationen ausgefÃ¼hrt werden, die sich auf die bisher angelegten Datenbankobjekte beziehen.</p>
</dd>
<dt class="hdlist1">Schritt 5: Rechte entziehen</dt>
<dd>
<p>Falls in Schritt 2 fÃ¼r Benutzer Rechte gesetzt wurden, die nur fÃ¼r die DurchfÃ¼hrung der Ã„nderungen benÃ¶tigt wurden, werden sie in diesem Schritt wieder entzogen.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Die nachfolgende Abbildung zeigt noch einmal die einzelnen Schritte der Installation.</p>
</div>
<div id="image-instbeineuan2" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/instbeineuan.png" alt="instbeineuan">
</div>
<div class="title">Abbildung 9. Ablauf bei der SchemaÃ¤nderung</div>
</div>
<div class="sect3">
<h4 id="struktur-der-aenderungsskripte"><a class="anchor" href="#struktur-der-aenderungsskripte"></a>10.3.1. Struktur der Ã„nderungsskripte</h4>
<div class="paragraph">
<p>FÃ¼r die automatisierte Ã„nderung wird eine Strukturierung der Ã„nderungsskripte festgelegt.
Diese ist analog zur Struktur der Installationsskripte aus Abschnitt <a href="#struktur-der-installationsskripte-fuer-die-neuanlage">Struktur der Installationsskripte fÃ¼r die Neuanlage</a>.
Es existieren folgende Aufrufbeziehungen:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Shell-Skripte</dt>
<dd>
<p>Ãœber die Shell-Skripte <code>update-db-schema.bat</code> (Windows) bzw. <code>update-db-schema.sh</code> (Linux) wird das SQL-Skript <code>00_update-main.sql</code> aufgerufen.
Als Parameter werden das Skript fÃ¼r das Anlegen der Umgebungsvariablen und die Log-Datei mitgegeben.</p>
</dd>
<dt class="hdlist1">00_update-main.sql</dt>
<dd>
<p>Das SQL-Skript ruft die eigentlichen Installationsskripte in der richtigen Reihenfolge Ã¼ber das Hilfsskript <code>99_starte-skript-mit-logging.sql</code> nacheinander auf.
Dabei werden auch die Tabellen zur Versionierung angelegt und korrekt gefÃ¼llt.</p>
</dd>
<dt class="hdlist1">99_starte-skript-mit-logging.sql</dt>
<dd>
<p>Das Hilfsskript fÃ¼hrt ein SQL-Skript aus und befÃ¼llt die Versionstabelle korrekt.
Als Parameter werden der Pfad des Skripts, die Schnittnummer inklusiv der Unterschrittnummer und die Beschreibung mit Ã¼bergeben.</p>
</dd>
<dt class="hdlist1">&lt;Update-Skript&gt;.sql</dt>
<dd>
<p>Die eigentlichen Ã„nderungsskripte haben das feste Namensschema <code>&lt;Schrittnummer&gt;-&lt;Unterschrittnummer&gt;_&lt;Name&gt;.sql</code>.
Die Schrittnummer ist 2-stellig und entspricht der Schrittnummer aus Kapitel <a href="#installationsablauf-bei-der-schemaaenderung">Installationsablauf bei der SchemaÃ¤nderung</a>.
Falls zu einem Schritt mehrere Skripte gehÃ¶ren, gibt die Unterschrittnummer die Reihenfolge an, in der diese ausgefÃ¼hrt werden.
Der Name kann frei vergeben werden, sollte aber sprechend sein.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Die nachfolgende Abbildung zeigt noch einmal die Beziehung zwischen den einzelnen Skripten.</p>
</div>
<div id="image-bezzwischenAend" class="imageblock text-center">
<div class="content">
<img src="../_images/detailkonzept-datenzugriff/bezzwischenAend.png" alt="bezzwischenAend">
</div>
<div class="title">Abbildung 10. Beziehungen zwischen den Ã„nderungsskripten</div>
</div>
<div class="paragraph">
<p>Templates fÃ¼r die Skripte sind als Ressourcen in der Bibliothek <code>isy-persistence</code> abgelegt.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="ablage-der-skripte-und-namenskonventionen"><a class="anchor" href="#ablage-der-skripte-und-namenskonventionen"></a>10.4. Ablage der Skripte und Namenskonventionen</h3>
<div class="paragraph">
<p>Die Skripte werden im Source-Projekt der Anwendung, zu der sie gehÃ¶ren, im Verzeichnis <code>src/main/skripte/sql/&lt;dbschema-name&gt;</code> abgelegt.
In diesem Verzeichnis liegen die Unterverzeichnisse <code>db-install-&lt;Versionsnummer&gt;</code> fÃ¼r Installationsskripte und <code>db-update-&lt;Versionsnummer&gt;</code> fÃ¼r Updateskripte.
<code>&lt;Versionsnummer&gt;</code> gibt dabei die Versionsnummer des Datenbankschemas, einschlieÃŸlich der Update-Nummer, an (z.Â B. <code>1.2.3_01</code>).</p>
</div>
<div class="paragraph">
<p>FÃ¼r die aktuelle Datenbankversion muss es ein vollstÃ¤ndiges Installationsskript geben.
Wurden Ã„nderungen am Schema vorgenommen, gibt es zusÃ¤tzlich ein entsprechendes Update-Skript von der Vorversion auf die aktuelle Version.
Das Verzeichnis enthÃ¤lt so immer das Installationsskript fÃ¼r die aktuelle Datenbankversion und Update-Skripte, um jede belieblige Vorversion seit EinfÃ¼hrung der Schema-Versionierung auf die aktuelle Datenbankversion anheben zu kÃ¶nnen.</p>
</div>
<div class="paragraph">
<p>Die einzelnen Skripte werden auf der Grundlage der Templates aus der Bibliothek <code>isy-persistence</code> erstellt und behalten auch deren Namen.</p>
</div>
<div class="paragraph">
<p>Die eigentlichen Installations- und Update-Skripte haben das feste Namensschema: <code>&lt;Schrittnummer&gt;-&lt;Unterschrittnummer&gt;_&lt;Name&gt;.sql</code>.
Die Schrittnummer ist 2-stellig und entspricht der Schrittnummer aus dem Kapitel <a href="#installationsablauf-bei-der-neuanlage">Installationsablauf bei der Neuanlage</a> bzw. <a href="#installationsablauf-bei-der-schemaaenderung">Installationsablauf bei der SchemaÃ¤nderung</a>.
Falls zu einem Schritt mehrere Skripte gehÃ¶ren, gibt die Unterschrittnummer die Reihenfolge an, in der diese ausgefÃ¼hrt werden.
Der Name kann frei vergeben werden, sollte aber sprechend sein.</p>
</div>
</div>
<div class="sect2">
<h3 id="schemauebergreifende-operationen"><a class="anchor" href="#schemauebergreifende-operationen"></a>10.5. SchemaÃ¼bergreifende Operationen</h3>
<div class="paragraph">
<p>Sollte eine Anwendung schemaÃ¼bergreifende Operationen haben wird das vorgestellte DB-Versionierungskonzept wie folgt erweitert.
Die Skripte der schemaÃ¼bergreifenden Operationen werden gemÃ¤ÃŸ Kapitel <a href="#ablage-der-skripte-und-namenskonventionen">Ablage der Skripte und Namenskonventionen</a> in einen eigenen Ordner unter <code>src/main/skripte/sql/uebergreifend</code> abgelegt.
Die hier abgelegten Skripte werden immer als letztes ausgefÃ¼hrt.
Zuvor werden alle anderen Schemata installiert.</p>
</div>
<div class="paragraph">
<p>Die Skripte im Ordner <code>uebergreifend</code> werden ebenfalls im gewohnten DB-Versionierungskonzept Format abgelegt.
Die Schrittnummer ist 2-stellig und entspricht der Schrittnummer aus Kapitel <a href="#installationsablauf-bei-der-neuanlage">Installationsablauf bei der Neuanlage</a>.
Allerdings beginnt die Schrittnummer mit 91 statt mit 01.
Die einzelnen Skripte werden in der richtigen Reihenfolge Ã¼ber das Hilfsskript <code>99_starte-skript-mit-logging.sql</code> aufgerufen und in der Tabelle <code>M_SCHEMA_LOG</code> des Hauptschemas der Anwendung protokolliert.</p>
</div>
<div class="paragraph">
<p>Die Skripte im Hauptschema der Anwendung setzen, nach erfolgreicher AusfÃ¼hrung, den Status von <code>M_SCHEMA_VERSION</code> auf â€ž<strong>bereit</strong>â€œ statt auf â€žgueltigâ€œ.
Das signalisiert, dass das Schema bereit ist, die schemaÃ¼bergreifenden Operationen durchzufÃ¼hren.
Vor der AusfÃ¼hrung der Skripte im Ordner <code>uebergreifend</code> wird geprÃ¼ft, dass der Status des Hauptschemas auf â€žbereitâ€œ steht.
Erst nach der erfolgreichen AusfÃ¼hrung aller Schritte des Schemas <code>uebergreifend</code> wird der Status auf â€žgueltigâ€œ gesetzt.</p>
</div>
<div class="paragraph">
<p>Mit den Ã¼bergreifenden Skripten sollen auch die Zugriffsrechte fÃ¼r die Queue(s) eines Anwendungssystems vergeben werden, sofern diese existieren.
Die entsprechenden Datenbanknutzer der Systeme, die Zugriff auf die Queue(s) haben sollen, sind dann in der Datei <code>91_environment.sql</code> einzutragen.
In einem Skript <code>93-X.sql</code> kÃ¶nnen dann die Rechte je nach Bedarf vergeben werden.
Auf diese Weise legt das Anwendungssystem selbst fest, welche anderen Systeme Zugriff auf die Queue(s) haben.</p>
</div>
</div>
<div class="sect2">
<h3 id="datenbankuebergreifende-operationen"><a class="anchor" href="#datenbankuebergreifende-operationen"></a>10.6. DatenbankÃ¼bergreifende Operationen</h3>
<div class="paragraph">
<p>Im Gegensatz zu schemaÃ¼bergreifenden Operationen wird von datenbankÃ¼bergreifenden Operationen dringlichst abgeraten.
Nur eine LÃ¶sung, Oracle Database Links, bietet im Zusammenspiel mit Oracle-Datenbanken eine generische, transaktionssichere LÃ¶sung fÃ¼r dieses Problem an.
Allerdings sind Oracle Database Links laut MaÃŸnahme M 4.71 des IT-Grundschutzes (<a href="../../../../glossary/latest/literaturextern/inhalt.html#litextern-IT-Grundschutz-M471" class="xref page">IT-Grundschutz M471</a>) nur unter strengen Auflagen zulÃ¤ssig, die eine Verwendung erheblich erschweren.</p>
</div>
<div class="paragraph">
<p>Mit dem Wegfall dieser LÃ¶sung gibt es aus Sicht der IsyFact keine geeignete LÃ¶sung, um Daten zwischen mehreren Schemata auf unterschiedlichen Datenbank-Instanzen zu bearbeiten.
UnabhÃ¤ngig von der LÃ¶sung erschweren datenbankÃ¼bergreifende Operationen die Fehlersuche im Falle einer fehlgeschlagenen Installation oder Aktualisierung wesentlich.</p>
</div>
</div>
<div class="sect2">
<h3 id="pruefen-der-schema-version"><a class="anchor" href="#pruefen-der-schema-version"></a>10.7. PrÃ¼fen der Schema-Version</h3>
<div class="paragraph">
<p>Jede Anwendung prÃ¼ft beim Start, ob das DB-Schema die erwartete Version hat.
Diese PrÃ¼fung ist in der Bibliothek <code>isy-persistence</code> fest eingebaut.
In der Anwendungskonfiguration mÃ¼ssen in <code>application.properties</code> die folgenden Properties gesetzt werden:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">isy.persistence.oracle.datasource.schema-invalid-version-action=fail
isy.persistence.oracle.datasource.schema-version=1.2.3</code></pre>
</div>
</div>
<div class="paragraph">
<p>In der Property <code>schemaVersion</code> wird die Versionsnummer des Datenbankschemas angegeben, das die Anwendung erwartet.
Wird die Property <code>schemaVersion</code> oder der Wert fÃ¼r die Version nicht angegeben, so findet keine ÃœberprÃ¼fung der Schema-Version statt.</p>
</div>
<div class="paragraph">
<p>In der Property <code>invalidSchemaVersionAction</code> wird festgelegt, wie die Data-Source auf eine falsche Schema-Version reagieren soll.
Der Wert <code>fail</code> legt fest, dass eine Exception geworfen wird.
Das hat zur Folge, dass die Anwendung nicht gestartet werden kann.
Der Wert <code>warn</code> legt fest, dass lediglich eine Warnung in die Log-Datei geschrieben wird.</p>
</div>
<div class="paragraph">
<p>Bei Datenmigrationen muss jedes Skript vor der AusfÃ¼hrung prÃ¼fen, ob die Datenbank die erwartete Version hat.
Das kann mit dem folgenden SQL-Statement durchgefÃ¼hrt werden:</p>
</div>
<div id="listing-pruefung-schema-version" class="listingblock">
<div class="title">Listing 14. SQL-Query zur PrÃ¼fung der Schema-Version</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">SELECT version
  FROM m_schema_version
 WHERE version_nummer = '&lt;schemaVersion&gt;'
   AND status = 'gueltig';</code></pre>
</div>
</div>
<div class="paragraph">
<p>Liefert dieses SQL-Statement einen Wert zurÃ¼ck, dann ist die erwartete Schema-Version vorhanden.
Liefert es keinen Wert zurÃ¼ck, dann ist die erwartete Schema-Version nicht vorhanden.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="verwendung-von-varchar"><a class="anchor" href="#verwendung-von-varchar"></a>11. Verwendung von VARCHAR</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bei der Verwendung von VARCHAR ist auf die korrekte Schreibweise zu achten.
Korrekt ist die Variante VARCHAR2 (x char), keinesfalls darf VARCHAR2(x) oder VARCHAR(x) verwendet werden.
Hintergrund: VARCHAR2 (10 char) bedeutet, dass bis zu 10 Zeichen gespeichert werden kÃ¶nnen, unabhÃ¤ngig davon, wie viele Bytes ein Zeichen benÃ¶tigt.
Beispielsweise kann bei Verwendung von Unicode ein Zeichen bis zu 4 Bytes beanspruchen.</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<div class="divFooter"></div>

<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/isyfact.js"></script>
  </body>
</html>
